<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì¸ì°¾ê¸° ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            user-select: none;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .security-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }
        .header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 3em;
            font-weight: bold;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .admin-auth {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 100px auto;
        }
        .dashboard {
            display: none;
        }
        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        .loading-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        /* ì„¸ì…˜ ì •ë³´ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .session-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .tab-menu {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
            overflow-x: auto;
        }
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            min-width: 140px;
        }
        .tab-button:first-child {
            border-radius: 20px 0 0 0;
        }
        .tab-button:last-child {
            border-radius: 0 20px 0 0;
        }
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            box-shadow: 0 -2px 10px rgba(102, 126, 234, 0.1);
        }
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 500px;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .admin-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            margin-bottom: 25px;
        }
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 10px 15px;
            font-size: 12px;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-edit {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .error-message {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #feb2b2;
        }
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }
        .form-input {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            margin: 10px;
            flex: 1;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-input.duplicate {
            border-color: #e53e3e;
            background-color: #fed7d7;
            animation: shake 0.5s ease-in-out;
        }
        .form-input.valid {
            border-color: #38a169 !important;
            background-color: #f0fff4 !important;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        .user-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        .user-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .user-form-row.basic-info {
            flex-wrap: wrap;
        }
        .user-form-row.basic-info > * {
            flex: 1;
            min-width: 200px;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* ì§€ì—­ ê¶Œí•œ ì„ íƒ ìŠ¤íƒ€ì¼ */
        .region-permissions {
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 10px;
        }
        .region-permissions h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .region-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .region-checkbox:hover {
            background-color: #f1f3f4;
        }
        .region-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        .region-checkbox label {
            cursor: pointer;
            font-size: 14px;
            color: #2d3748;
            user-select: none;
        }
        .region-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .region-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            color: #667eea;
        }
        .region-controls button:hover {
            background: #667eea;
            color: white;
        }
        /* ì‚¬ìš©ì ì •ë³´ì—ì„œ ê¶Œí•œ í‘œì‹œ */
        .user-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .permission-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .permission-tag.all-regions {
            background: #28a745;
        }
        .permission-tag.limited {
            background: #ffc107;
            color: #333;
        }
        /* ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        /* ê¸°ê¸° ê´€ë¦¬ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .device-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .device-item.pending {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }
        .device-item.approved {
            border-left: 4px solid #28a745;
        }
        .device-item.rejected {
            border-left: 4px solid #dc3545;
            background: #fdf2f2;
        }
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .device-field {
            display: flex;
            flex-direction: column;
        }
        .device-field label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .device-field span {
            font-size: 14px;
            color: #2d3748;
        }
        .device-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        /* ë³´ì•ˆ ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        .security-log {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            border-left: 3px solid;
        }
        .log-entry.info {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #1565c0;
        }
        .log-entry.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #e65100;
        }
        .log-entry.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .log-filter {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .log-stats {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        .remember-me input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .tab-menu {
                flex-wrap: wrap;
            }
            .tab-button {
                min-width: 120px;
                font-size: 12px;
                padding: 12px 15px;
            }
            .device-info {
                grid-template-columns: 1fr;
            }
            .user-form-row {
                flex-direction: column;
            }
            .user-actions {
                flex-direction: column;
                gap: 5px;
            }
            .region-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë¡œë”© í™”ë©´ -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">ì„¸ì…˜ í™•ì¸ ì¤‘...</div>
        </div>

        <!-- ë³´ì•ˆ í—¤ë” -->
        <div class="security-header">
            <h2>ğŸ”’ ë³´ì•ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
            <div>ì´ ì‹œìŠ¤í…œì€ ìŠ¹ì¸ëœ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ëª¨ë“  í™œë™ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</div>
        </div>

        <!-- ê´€ë¦¬ì ì¸ì¦ í™”ë©´ -->
        <div id="adminAuth" class="admin-auth">
            <h2>ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
            <p style="margin: 20px 0; color: #666;">ê´€ë¦¬ì ìê²©ì¦ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <input type="text" id="adminUsername" class="admin-input" placeholder="ê´€ë¦¬ì ì•„ì´ë””">
            <input type="password" id="adminPassword" class="admin-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
            
            <!-- ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì²´í¬ë°•ìŠ¤ -->
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (24ì‹œê°„)</label>
            </div>
            
            <button onclick="authenticateAdmin()" class="btn btn-primary" style="width: 100%;">
                ğŸš€ ë¡œê·¸ì¸
            </button>
            <div id="authMessage"></div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ë©”ì¸ í™”ë©´ -->
        <div id="dashboard" class="dashboard">
            <!-- í—¤ë” -->
            <div class="header">
                <button onclick="logout()" class="logout-btn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                <!-- ì„¸ì…˜ ì •ë³´ í‘œì‹œ -->
                <div class="session-info" id="sessionInfo" style="display: none;">
                    <div style="font-size: 10px; opacity: 0.8;">ì„¸ì…˜ ìœ íš¨</div>
                    <div id="sessionExpiry" style="font-size: 11px;"></div>
                </div>
                <h1>ğŸ›¡ï¸ ì§€ì¸ì°¾ê¸° ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                <p>ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ ë° ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="tab-menu">
                <button class="tab-button active" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button class="tab-button" onclick="switchTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('devices')">ğŸ“± ê¸°ê¸° ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('referrers')">ğŸ¯ ì¶”ì²œì¸ í†µê³„</button>
                <button class="tab-button" onclick="switchTab('regions')">ğŸ—ºï¸ ì§€ì—­ ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</button>
                <button class="tab-button" onclick="switchTab('security')">ğŸ›¡ï¸ ë³´ì•ˆ ë¡œê·¸</button>
            </div>

            <!-- íƒ­ ë‚´ìš© -->
            <div class="tab-content">
                <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
                <div id="dashboard-tab" class="tab-panel active">
                    <h3>ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                        <!-- ê¸°ë³¸ í†µê³„ -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="totalUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">ì´ ì‚¬ìš©ì</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #17a2b8;" id="activeUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">í™œì„± ì‚¬ìš©ì</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #fd7e14;" id="pendingDevices">-</div>
                            <div style="color: #666; margin-top: 5px;">ê¸°ê¸° ìš”ì²­ ëŒ€ê¸°</div>
                        </div>
                        <!-- ìƒˆë¡œìš´ ì•± ì‚¬ìš© í†µê³„ -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalFoundContacts">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">ì´ ì°¾ì€ ì§€ì¸</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalPhoneCalls">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">ì´ ì „í™” íšŸìˆ˜</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalSMS">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">ì´ ë¬¸ì íšŸìˆ˜</div>
                        </div>
                        <!-- ê¸°íƒ€ í†µê³„ -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalRegions">-</div>
                            <div style="color: #666; margin-top: 5px;">ë“±ë¡ëœ ì§€ì—­</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="totalLogs">-</div>
                            <div style="color: #666; margin-top: 5px;">ë³´ì•ˆ ë¡œê·¸</div>
                        </div>
                    </div>
                    <!-- í‰ê·  í†µê³„ ì„¹ì…˜ -->
                    <div style="background: #f1f3f4; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š í‰ê·  ì‚¬ìš© í†µê³„</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;" id="avgFoundContacts">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">ì‚¬ìš©ìë‹¹ í‰ê·  ì§€ì¸</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #28a745;" id="avgPhoneCalls">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">ì‚¬ìš©ìë‹¹ í‰ê·  ì „í™”</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #ff6b6b;" id="avgSMS">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">ì‚¬ìš©ìë‹¹ í‰ê·  ë¬¸ì</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #ffc107;" id="avgUsage">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">ì‚¬ìš©ìë‹¹ í‰ê·  ì´ìš©</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: #f1f3f4; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4>ğŸ“ˆ ìµœê·¼ í™œë™</h4>
                        <div id="recentActivity" style="margin-top: 15px;">
                            <div>ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
                <div id="users-tab" class="tab-panel">
                    <h3>ğŸ‘¤ ì‹ ê·œ ì‚¬ìš©ì ë“±ë¡</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        ğŸ’¡ <strong>íŒ:</strong> ì „í™”ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬ë©ë‹ˆë‹¤. ì§€ì—­ ê¶Œí•œì„ ì„¤ì •í•˜ë©´ í•´ë‹¹ ì§€ì—­ì˜ ì§€ì¸ë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì§€ì—­ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        <br>ğŸ“Š <strong>í†µê³„ ì•ˆë‚´:</strong> ì•±ì—ì„œ ìë™ìœ¼ë¡œ ìˆ˜ì§‘ë˜ëŠ” í†µê³„ - ì°¾ì€ ì§€ì¸ ìˆ˜, ì „í™” íšŸìˆ˜, ë¬¸ì íšŸìˆ˜, ì•± ì‚¬ìš© íšŸìˆ˜
                    </div>
                    <div class="user-form">
                        <!-- ê¸°ë³¸ ì •ë³´ ì…ë ¥ -->
                        <div class="user-form-row basic-info">
                            <div style="position: relative; flex: 1;">
                                <input type="tel" id="newUserPhone" class="form-input" 
                                       placeholder="ì „í™”ë²ˆí˜¸ (010-1234-5678)" 
                                       autocomplete="tel"
                                       style="transition: border-color 0.3s, background-color 0.3s; margin: 0;">
                            </div>
                            <input type="text" id="newUserName" class="form-input" 
                                   placeholder="ì´ë¦„ (ì„ íƒì‚¬í•­)" 
                                   autocomplete="name"
                                   style="margin: 0;">
                            <input type="text" id="newUserReferrer" class="form-input" 
                                   placeholder="ì¶”ì²œì¸ (ì„ íƒì‚¬í•­)" 
                                   autocomplete="off"
                                   style="margin: 0;">
                        </div>
                        <!-- ì§€ì—­ ê¶Œí•œ ì„ íƒ -->
                        <div class="region-permissions">
                            <h4>ğŸ—ºï¸ ì§€ì—­ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •</h4>
                            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                                â„¹ï¸ ì„ íƒí•œ ì§€ì—­ì˜ ì§€ì¸ë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì§€ì—­ì— ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            </div>
                            <div class="region-controls">
                                <button type="button" onclick="selectAllRegions()">ì „ì²´ ì„ íƒ</button>
                                <button type="button" onclick="clearAllRegions()">ì „ì²´ í•´ì œ</button>
                            </div>
                            <div id="regionCheckboxes" class="region-grid">
                                <div style="text-align: center; color: #666; padding: 20px;">ì§€ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                            </div>
                        </div>
                        <!-- ì¶”ê°€ ë²„íŠ¼ -->
                        <div class="user-form-row">
                            <button onclick="addUser()" class="btn btn-primary" style="width: 100%; padding: 15px;">
                                â• ì‚¬ìš©ì ì¶”ê°€
                            </button>
                        </div>
                    </div>
                    <div id="addUserMessage"></div>
                    <h3 style="margin-top: 30px;">ğŸ‘¥ ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡ (ì´ <span id="userCount">0</span>ëª…)</h3>
                    <div id="userList" class="user-list">
                        <div>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ê¸°ê¸° ê´€ë¦¬ íƒ­ -->
                <div id="devices-tab" class="tab-panel">
                    <h3>ğŸ“± ê¸°ê¸° ë“±ë¡ ê´€ë¦¬</h3>
                    <!-- ê¸°ê¸° ë“±ë¡ ìš”ì²­ ì„¹ì…˜ -->
                    <div style="margin-bottom: 40px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ ê¸°ê¸° ë“±ë¡ ìš”ì²­ (<span id="pendingRequestsCount">0</span>ê±´)</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                            ğŸ“‹ <strong>ì•ˆë‚´:</strong> ì‚¬ìš©ìë“¤ì´ ìƒˆë¡œìš´ ê¸°ê¸°ì—ì„œ ì•±ì„ ì‚¬ìš©í•˜ë ¤ê³  í•  ë•Œ ë“±ë¡ ìš”ì²­ì´ ìƒì„±ë©ë‹ˆë‹¤. ê° ì‚¬ìš©ìëŠ” í•˜ë‚˜ì˜ ê¸°ê¸°ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                        <div id="deviceRequests">
                            <div style="text-align: center; color: #666; padding: 20px;">ê¸°ê¸° ë“±ë¡ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                    <!-- ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ì„¹ì…˜ -->
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ’» ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ (<span id="registeredDevicesCount">0</span>ëŒ€)</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="deviceSearchInput" placeholder="ì „í™”ë²ˆí˜¸ ë˜ëŠ” ê¸°ê¸°ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="searchDevices()" class="btn btn-secondary">ğŸ” ê²€ìƒ‰</button>
                            <button onclick="loadRegisteredDevices()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button onclick="forceRefreshAllCaches()" class="btn btn-warning">âš¡ ìºì‹œ ë¬´íš¨í™”</button>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #856404;">
                            ğŸ’¡ <strong>ê¸°ëŠ¥ ì•ˆë‚´:</strong><br>
                            â€¢ <strong>ğŸ”„ ê¸°ê¸° ì´ˆê¸°í™”</strong>: ì‚¬ìš©ìëŠ” ìœ ì§€í•˜ê³  ê¸°ê¸° ì •ë³´ë§Œ ì œê±° (ì‚¬ìš©ìê°€ ìƒˆ ê¸°ê¸° ë“±ë¡ ê°€ëŠ¥)<br>
                            â€¢ <strong>âŒ ë¹„í™œì„±í™”</strong>: ì‚¬ìš©ì ê³„ì • ì¼ì‹œ ì¤‘ì§€
                        </div>
                        <div id="registeredDevices">
                            <div style="text-align: center; color: #666; padding: 20px;">ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- ì¶”ì²œì¸ í†µê³„ íƒ­ -->
                <div id="referrers-tab" class="tab-panel">
                    <h3>ğŸ¯ ì¶”ì²œì¸ë³„ í†µê³„</h3>
                    <!-- ì „ì²´ ì¶”ì²œ í†µê³„ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalReferrers">-</div>
                            <div style="color: #666; margin-top: 5px;">ì´ ì¶”ì²œì¸ ìˆ˜</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="referredUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">ì¶”ì²œìœ¼ë¡œ ê°€ì…í•œ ì‚¬ìš©ì</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="selfRegistered">-</div>
                            <div style="color: #666; margin-top: 5px;">ì§ì ‘ ê°€ì…í•œ ì‚¬ìš©ì</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #17a2b8;" id="avgReferrals">-</div>
                            <div style="color: #666; margin-top: 5px;">ì¶”ì²œì¸ë‹¹ í‰ê·  ì¶”ì²œìˆ˜</div>
                        </div>
                    </div>
                    <!-- ì¶”ì²œì¸ ëª©ë¡ ë° í†µê³„ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>ğŸ† ì¶”ì²œì¸ ìˆœìœ„</h4>
                            <div id="referrerRanking" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <div>í†µê³„ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</div>
                            </div>
                        </div>
                        <div>
                            <h4>ğŸ“‹ ì¶”ì²œëœ ì‚¬ìš©ì ëª©ë¡</h4>
                            <div style="margin-bottom: 10px;">
                                <select id="referrerFilter" onchange="filterByReferrer()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">ì „ì²´ ì¶”ì²œì¸</option>
                                </select>
                            </div>
                            <div id="referredUsersList" style="max-height: 350px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <div>ì¶”ì²œì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì§€ì—­ ê´€ë¦¬ íƒ­ -->
                <div id="regions-tab" class="tab-panel">
                    <h3>ğŸ—ºï¸ ì§€ì—­ ê´€ë¦¬</h3>
                    <!-- ì§€ì—­ë³„ í†µê³„ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalRegionsCount">-</div>
                            <div style="color: #666; margin-top: 5px;">ì „ì²´ ì§€ì—­ ìˆ˜</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="usersWithRegionLimits">-</div>
                            <div style="color: #666; margin-top: 5px;">ì§€ì—­ ì œí•œ ì‚¬ìš©ì</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="usersWithoutLimits">-</div>
                            <div style="color: #666; margin-top: 5px;">ë¬´ì œí•œ ì ‘ê·¼ ì‚¬ìš©ì</div>
                        </div>
                    </div>
                    <!-- ì§€ì—­ ëª©ë¡ -->
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ ë“±ë¡ëœ ì§€ì—­ ëª©ë¡</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="regionSearchInput" placeholder="ì§€ì—­ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="searchRegions()" class="btn btn-secondary">ğŸ” ê²€ìƒ‰</button>
                        </div>
                        <div id="regionsList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #666; padding: 20px;">ì§€ì—­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- ì„¤ì • íƒ­ -->
                <div id="settings-tab" class="tab-panel">
                    <h3>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div style="margin-top: 40px;">
                            <h4>ğŸ“… ì•± ë§Œë£Œì¼ ì„¤ì •</h4>
                            <input type="date" id="expiryDateInput" class="form-input" style="max-width: 300px;">
                            <button onclick="saveExpiryDate()" class="btn btn-primary" style="margin-left: 10px;">ğŸ’¾ ì €ì¥</button>
                            <div id="expiryDateMessage" style="margin-top: 10px; font-size: 14px;"></div>
                        </div>
                        <div>
                            <h4>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                            <input type="password" id="currentPassword" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" style="margin: 5px 0;">
                            <input type="password" id="newPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin: 5px 0;">
                            <input type="password" id="confirmPassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="margin: 5px 0;">
                            <button onclick="changePassword()" class="btn btn-primary" style="width: 100%;">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        </div>
                        <div>
                            <h4>ğŸ“‹ í˜„ì¬ ë¡œê·¸ì¸ ì •ë³´</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 14px;">
                                <div><strong>ê³„ì •:</strong> <span id="currentAdminInfo">-</span></div>
                                <div><strong>ë¡œê·¸ì¸ ì‹œê°„:</strong> <span id="loginTime">-</span></div>
                                <div><strong>ë§ˆì§€ë§‰ í™œë™:</strong> <span id="lastActivity">-</span></div>
                                <div><strong>ê¶Œí•œ:</strong> <span id="userRole">-</span></div>
                                <div><strong>ì„¸ì…˜ ìƒíƒœ:</strong> <span id="sessionStatus">-</span></div>
                            </div>
                            <!-- ì„¸ì…˜ ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button onclick="clearStoredSession()" class="btn btn-warning" style="flex: 1;">
                                    ğŸ—‘ï¸ ì €ì¥ëœ ì„¸ì…˜ ì‚­ì œ
                                </button>
                                <button onclick="extendSession()" class="btn btn-success" style="flex: 1;">
                                    â° ì„¸ì…˜ ì—°ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="adminSettingsMessage"></div>
                </div>

                <!-- ë³´ì•ˆ ë¡œê·¸ íƒ­ -->
                <div id="security-tab" class="tab-panel">
                    <h3>ğŸ›¡ï¸ ë³´ì•ˆ ë¡œê·¸</h3>
                    <!-- ë¡œê·¸ í†µê³„ -->
                    <div class="log-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalLogCount">0</div>
                            <div class="stat-label">ì „ì²´ ë¡œê·¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="errorLogCount">0</div>
                            <div class="stat-label">ì˜¤ë¥˜</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="warningLogCount">0</div>
                            <div class="stat-label">ê²½ê³ </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="infoLogCount">0</div>
                            <div class="stat-label">ì •ë³´</div>
                        </div>
                    </div>
                    <!-- ë¡œê·¸ ì»¨íŠ¸ë¡¤ -->
                    <div class="log-controls">
                        <select id="logFilter" class="log-filter" onchange="filterLogs()">
                            <option value="all">ì „ì²´ ë¡œê·¸</option>
                            <option value="ERROR">ì˜¤ë¥˜ë§Œ</option>
                            <option value="WARNING">ê²½ê³ ë§Œ</option>
                            <option value="INFO">ì •ë³´ë§Œ</option>
                        </select>
                        <button onclick="refreshLogs()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <button onclick="clearLogs()" class="btn btn-danger">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
                        <button onclick="exportLogs()" class="btn btn-primary">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                    <!-- ë¡œê·¸ í‘œì‹œ ì˜ì—­ -->
                    <div class="security-log" id="securityLogDisplay">
                        <div>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editPermissionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ—ºï¸ ì‚¬ìš©ì ê¶Œí•œ í¸ì§‘</h3>
                <span class="close" onclick="closePermissionsModal()">&times;</span>
            </div>
            <div id="modalUserInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- ì‚¬ìš©ì ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="region-permissions">
                <h4>ğŸ—ºï¸ ì§€ì—­ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •</h4>
                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                    â„¹ï¸ ì„ íƒí•œ ì§€ì—­ì˜ ì§€ì¸ë§Œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì§€ì—­ì— ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>
                <div class="region-controls">
                    <button type="button" onclick="selectAllRegionsModal()">ì „ì²´ ì„ íƒ</button>
                    <button type="button" onclick="clearAllRegionsModal()">ì „ì²´ í•´ì œ</button>
                </div>
                <div id="modalRegionCheckboxes" class="region-grid">
                    <!-- ì§€ì—­ ì²´í¬ë°•ìŠ¤ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closePermissionsModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button onclick="saveUserPermissions()" class="btn btn-primary">âœ… ê¶Œí•œ ì €ì¥</button>
            </div>
            <div id="modalMessage"></div>
        </div>
    </div>

    <script>
        // ========================================
        // 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì„¸ì…˜ ê´€ë¦¬ ì¶”ê°€)
        // ========================================
        let currentUser = null;
        let loginAttempts = 0;
        let allUsers = [];
        let securityLogs = [];
        let deviceRequests = [];
        let registeredDevices = [];
        let currentEditingUserId = null;
        let db = null;
        let currentTab = 'dashboard';
        
        // ìºì‹± ê´€ë ¨ ë³€ìˆ˜ë“¤
        let usersCache = { data: [], timestamp: 0, loaded: false };
        let devicesCache = { data: [], timestamp: 0, loaded: false };
        let regionsCache = { data: [], timestamp: 0, loaded: false };
        const CACHE_DURATION = 15 * 60 * 1000; // 15ë¶„ ìºì‹œ
        
        // Firebase í˜¸ì¶œ ì œí•œ
        let lastFirebaseCall = 0;
        const MIN_FIREBASE_INTERVAL = 2000; // ìµœì†Œ 2ì´ˆ ê°„ê²©
        let pendingFirebaseCalls = 0;
        const MAX_CONCURRENT_CALLS = 3;
        
        // ê´€ë¦¬ì ê³„ì • ì •ë³´
        let adminUsers = [];
        
        // ì„¸ì…˜ ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜ë“¤
        const SESSION_KEY = 'admin_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„
        let sessionCheckInterval = null;
        let sessionExpiry = null;

        // ========================================
        // 2. ì„¸ì…˜ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ========================================
        
        // ì„¸ì…˜ ì •ë³´ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
        function saveSession(user, rememberMe = false) {
            if (!rememberMe) return;
            
            try {
                const sessionData = {
                    id: user.id,
                    username: user.username,
                    role: user.role,
                    isLocal: user.isLocal,
                    loginTime: Date.now(),
                    expiry: Date.now() + SESSION_DURATION
                };
                
                // ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(sessionData), 'SecureAdminSession2024!@#').toString();
                localStorage.setItem(SESSION_KEY, encrypted);
                
                sessionExpiry = sessionData.expiry;
                updateSessionDisplay();
                startSessionMonitoring();
                
                addSecurityLog('INFO', `ì„¸ì…˜ ì €ì¥ë¨: ${user.username} (ë§Œë£Œ: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`);
            } catch (error) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì €ì¥ëœ ì„¸ì…˜ ë¡œë“œ
        function loadSession() {
            try {
                const encrypted = localStorage.getItem(SESSION_KEY);
                if (!encrypted) return null;
                
                // ë³µí˜¸í™”
                const decrypted = CryptoJS.AES.decrypt(encrypted, 'SecureAdminSession2024!@#').toString(CryptoJS.enc.Utf8);
                if (!decrypted) return null;
                
                const sessionData = JSON.parse(decrypted);
                
                // ì„¸ì…˜ ë§Œë£Œ ì²´í¬
                if (Date.now() > sessionData.expiry) {
                    clearStoredSession();
                    addSecurityLog('WARNING', 'ë§Œë£Œëœ ì„¸ì…˜ ê°ì§€ë¨ - ìë™ ì‚­ì œ');
                    return null;
                }
                
                sessionExpiry = sessionData.expiry;
                return sessionData;
            } catch (error) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                clearStoredSession();
                return null;
            }
        }
        
        // ì„¸ì…˜ ìë™ ë³µì›
        async function restoreSession() {
            const sessionData = loadSession();
            if (!sessionData) return false;
            
            try {
                addSecurityLog('INFO', `ì„¸ì…˜ ë³µì› ì‹œë„: ${sessionData.username}`);
                
                // ë¡œì»¬ ê´€ë¦¬ì ê³„ì • í™•ì¸
                const localAdmin = adminUsers.find(admin => 
                    admin.id === sessionData.id && 
                    admin.username === sessionData.username && 
                    admin.isActive
                );
                
                if (localAdmin) {
                    currentUser = localAdmin;
                    addSecurityLog('INFO', `ì„¸ì…˜ ë³µì› ì„±ê³µ: ${sessionData.username} (ë¡œì»¬ ê³„ì •)`);
                    
                    // UI ì „í™˜
                    showDashboard();
                    updateSessionDisplay();
                    startSessionMonitoring();
                    
                    // ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
                    setTimeout(() => {
                        loadUsers().catch(error => {
                            addSecurityLog('WARNING', `ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                        });
                    }, 1000);
                    
                    return true;
                }
                
                // ì›ê²© ê³„ì • í™•ì¸ (Firebase ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš°)
                if (db && !sessionData.isLocal) {
                    try {
                        const userDoc = await db.collection('admin_users').doc(sessionData.id).get();
                        if (userDoc.exists && userDoc.data().isActive) {
                            currentUser = { id: userDoc.id, ...userDoc.data() };
                            addSecurityLog('INFO', `ì„¸ì…˜ ë³µì› ì„±ê³µ: ${sessionData.username} (ì›ê²© ê³„ì •)`);
                            
                            showDashboard();
                            updateSessionDisplay();
                            startSessionMonitoring();
                            
                            setTimeout(() => {
                                loadUsers().catch(error => {
                                    addSecurityLog('WARNING', `ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                                });
                            }, 1000);
                            
                            return true;
                        }
                    } catch (error) {
                        addSecurityLog('WARNING', `ì›ê²© ì„¸ì…˜ ë³µì› ì‹¤íŒ¨: ${error.message}`);
                    }
                }
                
                // ì„¸ì…˜ ë³µì› ì‹¤íŒ¨
                clearStoredSession();
                addSecurityLog('WARNING', `ì„¸ì…˜ ë³µì› ì‹¤íŒ¨: ìœ íš¨í•˜ì§€ ì•Šì€ ê³„ì • - ${sessionData.username}`);
                return false;
                
            } catch (error) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ë³µì› ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                clearStoredSession();
                return false;
            }
        }
        
        // ì €ì¥ëœ ì„¸ì…˜ ì‚­ì œ
        function clearStoredSession() {
            try {
                localStorage.removeItem(SESSION_KEY);
                sessionExpiry = null;
                updateSessionDisplay();
                stopSessionMonitoring();
                addSecurityLog('INFO', 'ì €ì¥ëœ ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                
                // ë©”ì‹œì§€ í‘œì‹œ (ì„¤ì • íƒ­ì—ì„œ ìˆ˜ë™ ì‚­ì œí•œ ê²½ìš°)
                if (currentTab === 'settings') {
                    showMessage(document.getElementById('adminSettingsMessage'), 
                              'âœ… ì €ì¥ëœ ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            } catch (error) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì„¸ì…˜ ì—°ì¥
        function extendSession() {
            try {
                const encrypted = localStorage.getItem(SESSION_KEY);
                if (!encrypted) {
                    showMessage(document.getElementById('adminSettingsMessage'), 
                              'âŒ ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                const decrypted = CryptoJS.AES.decrypt(encrypted, 'SecureAdminSession2024!@#').toString(CryptoJS.enc.Utf8);
                const sessionData = JSON.parse(decrypted);
                
                // ì„¸ì…˜ ë§Œë£Œ ì‹œê°„ ì—°ì¥
                sessionData.expiry = Date.now() + SESSION_DURATION;
                sessionExpiry = sessionData.expiry;
                
                // ë‹¤ì‹œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥
                const newEncrypted = CryptoJS.AES.encrypt(JSON.stringify(sessionData), 'SecureAdminSession2024!@#').toString();
                localStorage.setItem(SESSION_KEY, newEncrypted);
                
                updateSessionDisplay();
                addSecurityLog('INFO', `ì„¸ì…˜ ì—°ì¥: ${sessionData.username} (ìƒˆ ë§Œë£Œ: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`);
                
                showMessage(document.getElementById('adminSettingsMessage'), 
                          `âœ… ì„¸ì…˜ì´ 24ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ë§Œë£Œ: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`, 'success');
            } catch (error) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ì—°ì¥ ì‹¤íŒ¨: ${error.message}`);
                showMessage(document.getElementById('adminSettingsMessage'), 
                          'âŒ ì„¸ì…˜ ì—°ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì„¸ì…˜ ì •ë³´ UI ì—…ë°ì´íŠ¸
        function updateSessionDisplay() {
            const sessionInfo = document.getElementById('sessionInfo');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionExpiryEl = document.getElementById('sessionExpiry');
            
            if (sessionExpiry && currentUser) {
                const timeLeft = sessionExpiry - Date.now();
                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / (60 * 60 * 1000));
                    const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                    
                    sessionInfo.style.display = 'block';
                    sessionExpiryEl.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
                    
                    if (sessionStatus) {
                        sessionStatus.textContent = `ìë™ ë¡œê·¸ì¸ í™œì„± (${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ)`;
                    }
                } else {
                    sessionInfo.style.display = 'none';
                    if (sessionStatus) {
                        sessionStatus.textContent = 'ì„¸ì…˜ ë§Œë£Œë¨';
                    }
                }
            } else {
                sessionInfo.style.display = 'none';
                if (sessionStatus) {
                    sessionStatus.textContent = 'ì„¸ì…˜ ì—†ìŒ';
                }
            }
        }
        
        // ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startSessionMonitoring() {
            stopSessionMonitoring(); // ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            
            sessionCheckInterval = setInterval(() => {
                if (sessionExpiry && Date.now() > sessionExpiry) {
                    addSecurityLog('WARNING', 'ì„¸ì…˜ ë§Œë£Œë¡œ ì¸í•œ ìë™ ë¡œê·¸ì•„ì›ƒ');
                    alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì–´ ìë™ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.');
                    logout();
                } else {
                    updateSessionDisplay();
                }
            }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
        }
        
        // ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        function stopSessionMonitoring() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
                sessionCheckInterval = null;
            }
        }

        // ========================================
        // 3. Firebase ì„¤ì •
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBlm_IxqmV4Kfr5eklto0lME2QDpTbXdB0",
            authDomain: "contacts-wonju.firebaseapp.com",
            projectId: "contacts-wonju",
            storageBucket: "contacts-wonju.firebasestorage.app",
            messagingSenderId: "866369356970",
            appId: "1:866369356970:web:75c30d24b7e089363e7cd3",
            measurementId: "G-LPE3WHDTZV"
        };

        // ========================================
        // 4. ì§€ì—­ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ========================================
        let availableRegions = ['ê·€ë˜ë©´', 'ë‹¨ê³„ë™', 'ë¬´ì‹¤ë™', 'ë¬¸ë§‰ì', 'ë¶€ë¡ ë©´', 'ìš°ì‚°ë™', 'ì›ì¸ë™', 'ì¼ì‚°ë™', 'ì§€ì •ë©´', 'ì¤‘ì•™ë™', 'íƒœì¥1ë™', 'íƒœì¥2ë™', 'í•™ì„±ë™', 'í˜¸ì €ë©´'];
        console.log("Regions loaded from a predefined list.");

        // ì§€ì—­ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateRegionCheckboxes() {
            const container = document.getElementById('regionCheckboxes');
            let html = '';
            availableRegions.forEach(region => {
                const checkboxId = `region_${region.replace(/[^a-zA-Z0-9]/g, '_')}`;
                html += `
                    <div class="region-checkbox">
                        <input type="checkbox" id="${checkboxId}" value="${region}">
                        <label for="${checkboxId}">${region}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ëª¨ë‹¬ì˜ ì§€ì—­ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateModalRegionCheckboxes(userRegions = []) {
            const container = document.getElementById('modalRegionCheckboxes');
            if (availableRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ë“±ë¡ëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            let html = '';
            availableRegions.forEach(region => {
                const checkboxId = `modal_region_${region.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const isChecked = userRegions.includes(region) ? 'checked' : '';
                html += `
                    <div class="region-checkbox">
                        <input type="checkbox" id="${checkboxId}" value="${region}" ${isChecked}>
                        <label for="${checkboxId}">${region}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ëª¨ë“  ì§€ì—­ ì„ íƒ
        function selectAllRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        // ëª¨ë“  ì§€ì—­ í•´ì œ
        function clearAllRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // ëª¨ë‹¬ì—ì„œ ëª¨ë“  ì§€ì—­ ì„ íƒ
        function selectAllRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        // ëª¨ë‹¬ì—ì„œ ëª¨ë“  ì§€ì—­ í•´ì œ
        function clearAllRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // ì„ íƒëœ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
        function getSelectedRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ëª¨ë‹¬ì—ì„œ ì„ íƒëœ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
        function getSelectedRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ì§€ì—­ ëª©ë¡ í‘œì‹œ
        function displayRegionsList() {
            const container = document.getElementById('regionsList');
            if (availableRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ë“±ë¡ëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            let html = '';
            availableRegions.forEach((region, index) => {
                // í•´ë‹¹ ì§€ì—­ì— ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ìˆ˜ ê³„ì‚°
                const usersWithThisRegion = allUsers.filter(user => 
                    user.regions && user.regions.includes(region)
                ).length;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${region}</div>
                            <small style="color: #718096;">ê¶Œí•œ ë³´ìœ  ì‚¬ìš©ì: ${usersWithThisRegion}ëª…</small>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editRegion('${region}')" class="btn btn-edit">âœï¸ í¸ì§‘</button>
                            <button onclick="deleteRegion('${region}')" class="btn btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ì§€ì—­ í¸ì§‘ (ì´ë¦„ ë³€ê²½)
        function editRegion(oldRegionName) {
            const newRegionName = prompt(`ì§€ì—­ëª…ì„ ìˆ˜ì •í•˜ì„¸ìš”:`, oldRegionName);
            if (!newRegionName || newRegionName.trim() === '') {
                return;
            }
            const trimmedName = newRegionName.trim();
            if (trimmedName === oldRegionName) {
                return; // ë³€ê²½ì‚¬í•­ ì—†ìŒ
            }
            if (availableRegions.includes(trimmedName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§€ì—­ëª…ì…ë‹ˆë‹¤.');
                return;
            }
            // ì§€ì—­ëª… ì—…ë°ì´íŠ¸
            const index = availableRegions.indexOf(oldRegionName);
            if (index !== -1) {
                availableRegions[index] = trimmedName;
                availableRegions.sort();
                // ì‚¬ìš©ìë“¤ì˜ ê¶Œí•œë„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” Firebase ì—…ë°ì´íŠ¸ í•„ìš”)
                allUsers.forEach(user => {
                    if (user.regions && user.regions.includes(oldRegionName)) {
                        const regionIndex = user.regions.indexOf(oldRegionName);
                        if (regionIndex !== -1) {
                            user.regions[regionIndex] = trimmedName;
                        }
                    }
                });
                // UI ì—…ë°ì´íŠ¸
                updateRegionCheckboxes();
                displayRegionsList();
                displayUsers(allUsers);
                addSecurityLog('INFO', `ì§€ì—­ëª… ë³€ê²½: ${oldRegionName} â†’ ${trimmedName}`);
            }
        }

        // ì§€ì—­ ì‚­ì œ
        function deleteRegion(regionName) {
            const usersWithThisRegion = allUsers.filter(user => 
                user.regions && user.regions.includes(regionName)
            ).length;
            if (usersWithThisRegion > 0) {
                if (!confirm(`"${regionName}" ì§€ì—­ì— ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìê°€ ${usersWithThisRegion}ëª… ìˆìŠµë‹ˆë‹¤.\nì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» í•´ë‹¹ ì‚¬ìš©ìë“¤ì˜ ê¶Œí•œì—ì„œ ì´ ì§€ì—­ì´ ì œê±°ë©ë‹ˆë‹¤.`)) {
                    return;
                }
            } else {
                if (!confirm(`"${regionName}" ì§€ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }
            // ì§€ì—­ ì œê±°
            const index = availableRegions.indexOf(regionName);
            if (index !== -1) {
                availableRegions.splice(index, 1);
                // ì‚¬ìš©ìë“¤ì˜ ê¶Œí•œì—ì„œë„ ì œê±° (ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” Firebase ì—…ë°ì´íŠ¸ í•„ìš”)
                allUsers.forEach(user => {
                    if (user.regions && user.regions.includes(regionName)) {
                        user.regions = user.regions.filter(region => region !== regionName);
                    }
                });
                // UI ì—…ë°ì´íŠ¸
                updateRegionCheckboxes();
                displayRegionsList();
                displayUsers(allUsers);
                updateRegionStats();
                addSecurityLog('WARNING', `ì§€ì—­ ì‚­ì œ: ${regionName} (ì˜í–¥ë°›ì€ ì‚¬ìš©ì: ${usersWithThisRegion}ëª…)`);
            }
        }

        // ì§€ì—­ ê²€ìƒ‰
        function searchRegions() {
            const searchTerm = document.getElementById('regionSearchInput').value.trim().toLowerCase();
            const container = document.getElementById('regionsList');
            if (!searchTerm) {
                displayRegionsList();
                return;
            }
            const filteredRegions = availableRegions.filter(region => 
                region.toLowerCase().includes(searchTerm)
            );
            if (filteredRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            let html = '';
            filteredRegions.forEach(region => {
                const usersWithThisRegion = allUsers.filter(user => 
                    user.regions && user.regions.includes(region)
                ).length;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${region}</div>
                            <small style="color: #718096;">ê¶Œí•œ ë³´ìœ  ì‚¬ìš©ì: ${usersWithThisRegion}ëª…</small>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editRegion('${region}')" class="btn btn-edit">âœï¸ í¸ì§‘</button>
                            <button onclick="deleteRegion('${region}')" class="btn btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ì§€ì—­ í†µê³„ ì—…ë°ì´íŠ¸
        function updateRegionStats() {
            const totalRegions = availableRegions.length;
            const usersWithLimits = allUsers.filter(user => user.regions && user.regions.length > 0).length;
            const usersWithoutLimits = allUsers.length - usersWithLimits;
            document.getElementById('totalRegionsCount').textContent = totalRegions;
            document.getElementById('usersWithRegionLimits').textContent = usersWithLimits;
            document.getElementById('usersWithoutLimits').textContent = usersWithoutLimits;
            document.getElementById('totalRegions').textContent = totalRegions; // ëŒ€ì‹œë³´ë“œìš©
        }

        // ========================================
        // 5. ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ========================================
        
        // ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
        function openPermissionsModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                alert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            currentEditingUserId = userId;
            const formattedPhone = formatPhoneNumber(user.phoneNumber);
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('modalUserInfo').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; font-size: 16px; color: #2d3748;">
                            ${formattedPhone} (${user.name || 'ì´ë¦„ ì—†ìŒ'})
                        </div>
                        <div style="font-size: 14px; color: #718096; margin-top: 4px;">
                            í˜„ì¬ ê¶Œí•œ: ${getUserPermissionText(user)}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ì‚¬ìš©íšŸìˆ˜: ${user.usageCount || 0}íšŒ<br>
                        ìƒíƒœ: ${user.isActive ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
                    </div>
                </div>
            `;
            // ì§€ì—­ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            updateModalRegionCheckboxes(user.regions || []);
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('editPermissionsModal').style.display = 'block';
            document.getElementById('modalMessage').innerHTML = '';
            addSecurityLog('INFO', `ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ ì—´ë¦¼: ${formattedPhone}`);
        }

        // ê¶Œí•œ í¸ì§‘ ëª¨ë‹¬ ë‹«ê¸°
        function closePermissionsModal() {
            document.getElementById('editPermissionsModal').style.display = 'none';
            currentEditingUserId = null;
        }

        // ì‚¬ìš©ì ê¶Œí•œ ì €ì¥ (Firebase í˜¸ì¶œ ì œí•œ)
        async function saveUserPermissions() {
            if (!currentEditingUserId) {
                alert('í¸ì§‘ ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const selectedRegions = getSelectedRegionsModal();
            const messageEl = document.getElementById('modalMessage');
            try {
                addSecurityLog('INFO', `ì‚¬ìš©ì ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹œë„: ${currentEditingUserId}`);
                // ë¡œì»¬ì—ì„œ ë¨¼ì € ì—…ë°ì´íŠ¸
                const user = allUsers.find(u => u.id === currentEditingUserId);
                if (user) {
                    user.regions = selectedRegions.length > 0 ? selectedRegions : null;
                }
                // Firebase ì—…ë°ì´íŠ¸ (ì œí•œ ì ìš©)
                const updateData = {
                    regions: selectedRegions.length > 0 ? selectedRegions : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.username
                };
                await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users').doc(currentEditingUserId).update(updateData);
                });
                showMessage(messageEl, 'âœ… ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                addSecurityLog('INFO', `ê¶Œí•œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${formatPhoneNumber(user?.phoneNumber)} (ì§€ì—­: ${selectedRegions.length > 0 ? selectedRegions.join(', ') : 'ë¬´ì œí•œ'})`);
                // UI ìƒˆë¡œê³ ì¹¨
                displayUsers(allUsers);
                updateRegionStats();
                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closePermissionsModal();
                }, 2000);
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    showMessage(messageEl, 'âœ… ê¶Œí•œì´ ë¡œì»¬ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (Firebase ì €ì¥ì€ í• ë‹¹ëŸ‰ ì´ˆê³¼ë¡œ ì‹¤íŒ¨)', 'success');
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ - ë¡œì»¬ ê¶Œí•œ ë³€ê²½ë§Œ ì ìš©');
                    // UIëŠ” ì—…ë°ì´íŠ¸
                    displayUsers(allUsers);
                    updateRegionStats();
                    setTimeout(() => {
                        closePermissionsModal();
                    }, 3000);
                } else {
                    addSecurityLog('ERROR', `ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                    showMessage(messageEl, 'âŒ ê¶Œí•œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ì‚¬ìš©ì ê¶Œí•œ í…ìŠ¤íŠ¸ ìƒì„±
        function getUserPermissionText(user) {
            if (!user.regions || user.regions.length === 0) {
                return 'ëª¨ë“  ì§€ì—­ ì ‘ê·¼ ê°€ëŠ¥';
            } else if (user.regions.length === 1) {
                return `${user.regions[0]} ì§€ì—­ë§Œ`;
            } else if (user.regions.length <= 3) {
                return `${user.regions.join(', ')} ì§€ì—­`;
            } else {
                return `${user.regions.length}ê°œ ì§€ì—­ (${user.regions.slice(0, 2).join(', ')} ì™¸)`;
            }
        }

        // ========================================
        // 6. Firebase ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê·¹í•œ ìµœì í™”)
        // ========================================

        // Firebase í˜¸ì¶œ ì œí•œê¸° (í• ë‹¹ëŸ‰ ì´ˆê³¼ì‹œ ì˜êµ¬ ì°¨ë‹¨, ë¡œê·¸ì¸ ì‹œ ì œí•œ ì™„í™”)
        async function throttledFirebaseCall(operation, isLoginCall = false) {
            const now = Date.now();
            
            // ì´ë¯¸ í• ë‹¹ëŸ‰ ì´ˆê³¼ê°€ ê°ì§€ëœ ê²½ìš° ì¦‰ì‹œ ì˜¤í”„ë¼ì¸ ëª¨ë“œ
            const quotaExceeded = localStorage.getItem('firebase_quota_exceeded');
            if (quotaExceeded === 'true') {
                addSecurityLog('WARNING', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ìƒíƒœ - í˜¸ì¶œ ì°¨ë‹¨');
                throw new Error('QUOTA_EXCEEDED');
            }
            
            // ë™ì‹œ í˜¸ì¶œ ìˆ˜ ì œí•œ
            if (pendingFirebaseCalls >= MAX_CONCURRENT_CALLS) {
                addSecurityLog('WARNING', 'Firebase ë™ì‹œ í˜¸ì¶œ ìˆ˜ ì œí•œìœ¼ë¡œ ëŒ€ê¸°');
                await new Promise(resolve => setTimeout(resolve, 1000));
                return throttledFirebaseCall(operation, isLoginCall);
            }
            
            // ë¡œê·¸ì¸ í˜¸ì¶œì˜ ê²½ìš° ì œí•œ ì™„í™” (500ms), ì¼ë°˜ í˜¸ì¶œì€ ê¸°ì¡´ ì œí•œ (2000ms)
            const minInterval = isLoginCall ? 500 : MIN_FIREBASE_INTERVAL;
            
            // ìµœì†Œ ê°„ê²© ì œí•œ
            const timeSinceLastCall = now - lastFirebaseCall;
            if (timeSinceLastCall < minInterval) {
                const waitTime = minInterval - timeSinceLastCall;
                addSecurityLog('INFO', `Firebase í˜¸ì¶œ ì œí•œ: ${waitTime}ms ëŒ€ê¸° ${isLoginCall ? '(ë¡œê·¸ì¸)' : ''}`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            pendingFirebaseCalls++;
            lastFirebaseCall = Date.now();
            
            try {
                const result = await operation();
                return result;
            } catch (error) {
                // í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ ê°•í™”
                if (error.code === 'resource-exhausted' || 
                    error.message?.includes('Quota exceeded') ||
                    error.message?.includes('quota')) {
                    
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ - ì˜êµ¬ ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜');
                    
                    // localStorageì— í• ë‹¹ëŸ‰ ì´ˆê³¼ í”Œë˜ê·¸ ì €ì¥ (ë‹¤ìŒ ì„¸ì…˜ê¹Œì§€ ìœ ì§€)
                    localStorage.setItem('firebase_quota_exceeded', 'true');
                    localStorage.setItem('quota_exceeded_time', new Date().toISOString());
                    
                    // Firebase ì—°ê²° ì°¨ë‹¨
                    db = null;
                    
                    // ì¦‰ì‹œ ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì „í™˜
                    setTimeout(() => {
                        showQuotaExceededMessage();
                    }, 100);
                    
                    throw new Error('QUOTA_EXCEEDED');
                }
                throw error;
            } finally {
                pendingFirebaseCalls--;
            }
        }

        // í• ë‹¹ëŸ‰ ì´ˆê³¼ ìƒíƒœ ì´ˆê¸°í™” (ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œ)
        function resetQuotaStatus() {
            localStorage.removeItem('firebase_quota_exceeded');
            localStorage.removeItem('quota_exceeded_time');
            addSecurityLog('INFO', 'Firebase í• ë‹¹ëŸ‰ ìƒíƒœ ì´ˆê¸°í™” - ì¬ì—°ê²° ì‹œë„ ê°€ëŠ¥');
            if (confirm('Firebase í• ë‹¹ëŸ‰ ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.reload();
            }
        }

        // í• ë‹¹ëŸ‰ ì´ˆê³¼ ë©”ì‹œì§€ í‘œì‹œ (ê´€ë¦¬ ê¸°ëŠ¥ í¬í•¨)
        function showQuotaExceededMessage() {
            const existingBanner = document.getElementById('quotaExceededBanner');
            if (existingBanner) return; // ì´ë¯¸ í‘œì‹œ ì¤‘
            const quotaTime = localStorage.getItem('quota_exceeded_time');
            const timeInfo = quotaTime ? new Date(quotaTime).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
            const banner = document.createElement('div');
            banner.id = 'quotaExceededBanner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                padding: 20px;
                text-align: center;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                animation: slideDown 0.5s ease-out;
            `;
            banner.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="font-size: 18px; margin-bottom: 10px;">âš ï¸ Firebase ì¼ì¼ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                    <div style="font-size: 14px; margin-bottom: 15px; opacity: 0.9;">
                        ğŸ• ë°œìƒ ì‹œê°„: ${timeInfo}<br>
                        ğŸ”„ ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ëŠ” ìºì‹œì—ì„œ ì œê³µë©ë‹ˆë‹¤.<br>
                        ğŸ“… í• ë‹¹ëŸ‰ì€ ë‚´ì¼ ìì •(UTC ê¸°ì¤€)ì— ìë™ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="resetQuotaStatus()" style="background: #fbbf24; color: #92400e; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;" title="í• ë‹¹ëŸ‰ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ê³  Firebase ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤">
                            ğŸ”„ ìƒíƒœ ì´ˆê¸°í™”
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;" title="ì´ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤">
                            âœ• ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(banner);
            // 30ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                }
            }, 30000);
        }

        // Firebase ì´ˆê¸°í™” (í• ë‹¹ëŸ‰ ì´ˆê³¼ì‹œ ì™„ì „ ë¹„í™œì„±í™”)
        function initializeFirebase() {
            try {
                // ìš°ì„  í• ë‹¹ëŸ‰ ì´ˆê³¼ ì—¬ë¶€ í™•ì¸
                const quotaExceeded = localStorage.getItem('firebase_quota_exceeded');
                if (quotaExceeded === 'true') {
                    addSecurityLog('WARNING', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ - ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
                    return initializeOfflineMode();
                }
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                // ì˜¤í”„ë¼ì¸ ì§€ì›ì€ ì¡°ìš©íˆ í™œì„±í™” (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
                try {
                    db.enablePersistence({ synchronizeTabs: true })
                        .then(() => {
                            addSecurityLog('INFO', 'Firebase ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”');
                        })
                        .catch((err) => {
                            addSecurityLog('WARNING', `Firebase ì˜¤í”„ë¼ì¸ ì„¤ì • ì‹¤íŒ¨: ${err.code}`);
                        });
                } catch (persistenceError) {
                    addSecurityLog('WARNING', `Firebase ì˜¤í”„ë¼ì¸ ì„¤ì • ì˜¤ë¥˜: ${persistenceError.message}`);
                }
                addSecurityLog('INFO', 'Firebase ì´ˆê¸°í™” ì„±ê³µ (ì˜¤í”„ë¼ì¸ ì§€ì› í¬í•¨)');
                // ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™” (Firebase í˜¸ì¶œ ì—†ìŒ)
                initializeAdminAccounts();
                return true;
            } catch (error) {
                addSecurityLog('ERROR', `Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                // Firebase ì‹¤íŒ¨ì‹œ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì „í™˜
                return initializeOfflineMode();
            }
        }

        // ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì´ˆê¸°í™”
        function initializeOfflineMode() {
            addSecurityLog('INFO', 'ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì´ˆê¸°í™”');
            // Firebase ì™„ì „ ë¹„í™œì„±í™”
            db = null;
            // ë¡œì»¬ ê´€ë¦¬ì ê³„ì •ë§Œ ì‚¬ìš©
            adminUsers = [{
                id: 'offline_admin',
                username: 'admin',
                password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                role: 'admin',
                permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                isActive: true,
                isLocal: true,
                isOffline: true
            }];
            addSecurityLog('INFO', 'ì˜¤í”„ë¼ì¸ ê´€ë¦¬ì ê³„ì • ìƒì„± ì™„ë£Œ');
            // í• ë‹¹ëŸ‰ ì´ˆê³¼ í‘œì‹œ
            setTimeout(() => {
                showQuotaExceededMessage();
            }, 2000);
            return false; // Firebase ì‚¬ìš© ë¶ˆê°€
        }

        // ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™” (Firebase í˜¸ì¶œ ì™„ì „ ì œê±°)
        async function initializeAdminAccounts() {
            try {
                // ë¡œì»¬ ê´€ë¦¬ì ê³„ì •ë§Œ ìƒì„± (Firebase í˜¸ì¶œ ì™„ì „ ì—†ìŒ)
                adminUsers = [{
                    id: 'local_admin',
                    username: 'admin',
                    password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                    role: 'admin',
                    permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                    isActive: true,
                    isLocal: true
                }];
                addSecurityLog('INFO', 'ë¡œì»¬ ê´€ë¦¬ì ê³„ì • ìƒì„± ì™„ë£Œ (Firebase í˜¸ì¶œ ì—†ìŒ)');
                // Firebase ì›ê²© ê³„ì • í™•ì¸ì€ ì™„ì „íˆ ì œê±° (í• ë‹¹ëŸ‰ ì´ˆê³¼ ë°©ì§€)
                addSecurityLog('INFO', 'ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - Firebase ë™ê¸°í™” ë¹„í™œì„±í™”');
            } catch (error) {
                addSecurityLog('ERROR', `ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ========================================
        // 7. ë³´ì•ˆ ê¸°ëŠ¥ë“¤
        // ========================================
        
        // ê°œë°œì ë„êµ¬ ì°¨ë‹¨
        function blockDevTools() {
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || // F12
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                    (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
                    e.preventDefault();
                    addSecurityLog('WARNING', 'ê°œë°œì ë„êµ¬ ì ‘ê·¼ ì‹œë„ ì°¨ë‹¨');
                    return false;
                }
            });
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                addSecurityLog('WARNING', 'ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨');
                return false;
            });
        }

        // ========================================
        // 8. ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì„¸ì…˜ ì§€ì† ê¸°ëŠ¥ ì¶”ê°€)
        // ========================================
        
        // ëŒ€ì‹œë³´ë“œ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜ë“¤
        function showDashboard() {
            document.getElementById('adminAuth').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateDashboardStats();
            loadUsers();
        }
        
        function showLoginScreen() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminUsername').focus();
        }

        // ë¡œë”© í™”ë©´ í‘œì‹œ/ìˆ¨ê¹€
        function showLoadingScreen(text = 'ë¡œë”© ì¤‘...') {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.querySelector('.loading-text');
            loadingText.textContent = text;
            loadingScreen.style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // ê´€ë¦¬ì ì¸ì¦ (ì„¸ì…˜ ì €ì¥ ê¸°ëŠ¥ í¬í•¨)
        async function authenticateAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!username || !password) {
                showAuthMessage('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showLoadingScreen('ì¸ì¦ ì¤‘...');
            
            try {
                addSecurityLog('INFO', `ë¡œê·¸ì¸ ì‹œë„: ${username}`);
                
                // 1ë‹¨ê³„: ë¡œì»¬ ê´€ë¦¬ì ê³„ì • ìš°ì„  í™•ì¸ (Firebase í˜¸ì¶œ ì—†ìŒ)
                const hashedPassword = CryptoJS.SHA256(password).toString();
                const localAdmin = adminUsers.find(admin => 
                    admin.username === username && 
                    admin.password === hashedPassword && 
                    admin.isActive
                );
                
                if (localAdmin) {
                    // ë¡œì»¬ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ
                    loginAttempts = 0;
                    currentUser = localAdmin;
                    addSecurityLog('INFO', `ë¡œì»¬ ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ: ${username} (${localAdmin.role})`);
                    
                    // ì„¸ì…˜ ì €ì¥ (ì²´í¬ë°•ìŠ¤ì— ë”°ë¼)
                    if (rememberMe) {
                        saveSession(localAdmin, true);
                    }
                    
                    // UI ì „í™˜
                    hideLoadingScreen();
                    showDashboard();
                    
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                    
                    // ê´€ë¦¬ì ì •ë³´ í‘œì‹œ
                    updateAdminInfo();
                    
                    // ê¸°ë³¸ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
                    try {
                        await loadUsers();
                    } catch (error) {
                        addSecurityLog('WARNING', 'Firebase ì´ˆê¸° ë¡œë“œ ì‹¤íŒ¨ - ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                        allUsers = [];
                        updateDashboardStats();
                    }
                    return; // ë¡œì»¬ ë¡œê·¸ì¸ ì„±ê³µì‹œ ì—¬ê¸°ì„œ ì¢…ë£Œ
                }
                
                // 2ë‹¨ê³„: Firebase ì›ê²© ê³„ì • í™•ì¸ (ì„ íƒì , í• ë‹¹ëŸ‰ í—ˆìš©ì‹œì—ë§Œ)
                if (db) {
                    try {
                        addSecurityLog('INFO', `ì›ê²© ê´€ë¦¬ì ê³„ì • í™•ì¸ ì‹œë„: ${username}`);
                        // Firebase í˜¸ì¶œ ì œí•œ ì ìš©
                        const snapshot = await throttledFirebaseCall(async () => {
                            return await db.collection('admin_users')
                                .where('username', '==', username)
                                .where('password', '==', hashedPassword)
                                .where('isActive', '==', true)
                                .limit(1)
                                .get();
                        }, true); // ë¡œê·¸ì¸ í˜¸ì¶œì„ì„ í‘œì‹œ
                        
                        if (!snapshot.empty) {
                            const remoteAdmin = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            loginAttempts = 0;
                            currentUser = remoteAdmin;
                            
                            // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸ (ì„ íƒì )
                            try {
                                await throttledFirebaseCall(async () => {
                                    return await db.collection('admin_users').doc(remoteAdmin.id).update({
                                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }, true);
                            } catch (updateError) {
                                addSecurityLog('WARNING', `ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${updateError.message}`);
                            }
                            
                            addSecurityLog('INFO', `ì›ê²© ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ: ${username} (${remoteAdmin.role})`);
                            
                            // ì„¸ì…˜ ì €ì¥ (ì²´í¬ë°•ìŠ¤ì— ë”°ë¼)
                            if (rememberMe) {
                                saveSession(remoteAdmin, true);
                            }
                            
                            // UI ì „í™˜
                            hideLoadingScreen();
                            showDashboard();
                            
                            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                            document.getElementById('adminUsername').value = '';
                            document.getElementById('adminPassword').value = '';
                            updateAdminInfo();
                            
                            try {
                                await loadUsers();
                            } catch (error) {
                                addSecurityLog('WARNING', 'Firebase ì´ˆê¸° ë¡œë“œ ì‹¤íŒ¨ - ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                                allUsers = [];
                                updateDashboardStats();
                            }
                            return; // ì›ê²© ë¡œê·¸ì¸ ì„±ê³µì‹œ ì—¬ê¸°ì„œ ì¢…ë£Œ
                        }
                    } catch (firebaseError) {
                        if (firebaseError.message === 'QUOTA_EXCEEDED') {
                            addSecurityLog('WARNING', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ - ë¡œì»¬ ê³„ì •ë§Œ ì‚¬ìš©');
                            showQuotaExceededMessage();
                        } else {
                            addSecurityLog('WARNING', `ì›ê²© ì¸ì¦ ì‹¤íŒ¨: ${firebaseError.message}`);
                        }
                        // Firebase ì˜¤ë¥˜ì‹œì—ë„ ê³„ì† ì§„í–‰í•˜ì—¬ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
                    }
                }
                
                // 3ë‹¨ê³„: ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
                hideLoadingScreen();
                loginAttempts++;
                addSecurityLog('ERROR', `ë¡œê·¸ì¸ ì‹¤íŒ¨ (${loginAttempts}íšŒ): ${username}`);
                
                if (loginAttempts >= 3) {
                    showAuthMessage('ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ì¸í•´ ì ‘ê·¼ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.', 'error');
                    setTimeout(() => {
                        window.location.href = 'about:blank';
                    }, 3000);
                } else {
                    showAuthMessage(`ì˜ëª»ëœ ìê²©ì¦ëª…ì…ë‹ˆë‹¤. (${loginAttempts}/3)`, 'error');
                }
                
            } catch (error) {
                hideLoadingScreen();
                addSecurityLog('ERROR', `ì¸ì¦ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                showAuthMessage('ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê´€ë¦¬ì ì •ë³´ ì—…ë°ì´íŠ¸
        function updateAdminInfo() {
            if (currentUser) {
                document.getElementById('currentAdminInfo').textContent = `${currentUser.username} (${currentUser.role})`;
                document.getElementById('loginTime').textContent = new Date().toLocaleString('ko-KR');
                document.getElementById('lastActivity').textContent = new Date().toLocaleString('ko-KR');
                document.getElementById('userRole').textContent = currentUser.role;
                
                // ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateSessionDisplay();
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 5000);
        }

        function logout() {
            if (confirm('ì •ë§ë¡œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                addSecurityLog('INFO', `ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ: ${currentUser?.username}`);
                
                // ì„¸ì…˜ ì •ë¦¬
                clearStoredSession();
                currentUser = null;
                
                showLoginScreen();
                document.getElementById('adminUsername').focus();
                
                // ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ë¦¬ì…‹
                currentTab = 'dashboard';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.querySelector('.tab-button').classList.add('active');
                document.getElementById('dashboard-tab').classList.add('active');
            }
        }

        // ========================================
        // 9. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ========================================
        
        // ë³´ì•ˆ ë¡œê·¸ ê¸°ëŠ¥
        function addSecurityLog(level, message) {
            // ë§¤ê°œë³€ìˆ˜ê°€ 1ê°œë§Œ ì „ë‹¬ëœ ê²½ìš° ì²˜ë¦¬
            if (typeof message === 'undefined') {
                message = level;
                level = 'INFO';
            }
            const timestamp = new Date().toLocaleString('ko-KR');
            const logEntry = {
                timestamp: timestamp,
                level: level,
                message: message,
                id: Date.now() + Math.random()
            };
            securityLogs.unshift(logEntry);
            // ìµœëŒ€ 200ê°œ ë¡œê·¸ë§Œ ë©”ëª¨ë¦¬ì— ë³´ê´€
            if (securityLogs.length > 200) {
                securityLogs.pop();
            }
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            switch(level) {
                case 'ERROR':
                    console.error(`[${level}] ${message}`);
                    break;
                case 'WARNING':
                    console.warn(`[${level}] ${message}`);
                    break;
                case 'INFO':
                default:
                    console.log(`[${level}] ${message}`);
                    break;
            }
            // ë³´ì•ˆ ë¡œê·¸ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            if (currentTab === 'security') {
                displaySecurityLogs();
            }
            // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
            updateDashboardStats();
        }

        // ë³´ì•ˆ ë¡œê·¸ í‘œì‹œ
        function displaySecurityLogs() {
            const logDisplay = document.getElementById('securityLogDisplay');
            const filter = document.getElementById('logFilter').value;
            let filteredLogs = securityLogs;
            if (filter !== 'all') {
                filteredLogs = securityLogs.filter(log => log.level === filter);
            }
            if (filteredLogs.length === 0) {
                logDisplay.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            let html = '';
            filteredLogs.forEach(log => {
                const levelClass = log.level.toLowerCase();
                html += `
                    <div class="log-entry ${levelClass}">
                        [${log.timestamp}] [${log.level}] ${log.message}
                    </div>
                `;
            });
            logDisplay.innerHTML = html;
            // ë¡œê·¸ í†µê³„ ì—…ë°ì´íŠ¸
            updateLogStats();
        }

        // ë¡œê·¸ í†µê³„ ì—…ë°ì´íŠ¸
        function updateLogStats() {
            const totalCount = securityLogs.length;
            const errorCount = securityLogs.filter(log => log.level === 'ERROR').length;
            const warningCount = securityLogs.filter(log => log.level === 'WARNING').length;
            const infoCount = securityLogs.filter(log => log.level === 'INFO').length;
            document.getElementById('totalLogCount').textContent = totalCount;
            document.getElementById('errorLogCount').textContent = errorCount;
            document.getElementById('warningLogCount').textContent = warningCount;
            document.getElementById('infoLogCount').textContent = infoCount;
        }

        // ë¡œê·¸ í•„í„°ë§
        function filterLogs() {
            displaySecurityLogs();
        }

        // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
        function refreshLogs() {
            displaySecurityLogs();
            addSecurityLog('INFO', 'ë³´ì•ˆ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨');
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLogs() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë³´ì•ˆ ë¡œê·¸ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                securityLogs = [];
                displaySecurityLogs();
                addSecurityLog('WARNING', 'ë³´ì•ˆ ë¡œê·¸ê°€ ê´€ë¦¬ìì— ì˜í•´ ì‚­ì œë¨');
            }
        }

        // ë¡œê·¸ ë‚´ë³´ë‚´ê¸°
        function exportLogs() {
            const filter = document.getElementById('logFilter').value;
            let filteredLogs = securityLogs;
            if (filter !== 'all') {
                filteredLogs = securityLogs.filter(log => log.level === filter);
            }
            let content = 'ë³´ì•ˆ ë¡œê·¸ ë‚´ë³´ë‚´ê¸°\n';
            content += '='.repeat(50) + '\n';
            content += `ë‚´ë³´ë‚¸ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}\n`;
            content += `í•„í„°: ${filter === 'all' ? 'ì „ì²´' : filter}\n`;
            content += `ì´ ë¡œê·¸ ìˆ˜: ${filteredLogs.length}\n`;
            content += '='.repeat(50) + '\n\n';
            filteredLogs.forEach(log => {
                content += `[${log.timestamp}] [${log.level}] ${log.message}\n`;
            });
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_logs_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            addSecurityLog('INFO', `ë³´ì•ˆ ë¡œê·¸ ë‚´ë³´ë‚´ê¸° (${filteredLogs.length}ê°œ)`);
        }

        // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸ (ğŸ“Š ìƒˆë¡œìš´ í†µê³„ ì¶”ê°€)
        function updateDashboardStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.isActive).length;
            const pendingDevicesCount = deviceRequests.filter(req => req.status === 'pending').length;
            
            // ğŸ“Š ìƒˆë¡œìš´ í†µê³„ ê³„ì‚°
            let totalFoundContacts = 0;
            let totalPhoneCalls = 0;
            let totalSMS = 0;
            let totalUsageCount = 0;
            
            // ê° ì‚¬ìš©ìì˜ í†µê³„ í•©ê³„ ê³„ì‚°
            allUsers.forEach(user => {
                totalFoundContacts += (user.foundContactsCount || 0);
                totalPhoneCalls += (user.phoneCallCount || 0);
                totalSMS += (user.smsCount || 0);
                totalUsageCount += (user.usageCount || 0);
            });
            
            // í‰ê·  ê³„ì‚° (í™œì„± ì‚¬ìš©ì ê¸°ì¤€)
            const avgFoundContacts = activeUsers > 0 ? (totalFoundContacts / activeUsers).toFixed(1) : '0';
            const avgPhoneCalls = activeUsers > 0 ? (totalPhoneCalls / activeUsers).toFixed(1) : '0';
            const avgSMS = activeUsers > 0 ? (totalSMS / activeUsers).toFixed(1) : '0';
            const avgUsage = activeUsers > 0 ? (totalUsageCount / activeUsers).toFixed(1) : '0';
            
            // ê¸°ë³¸ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('pendingDevices').textContent = pendingDevicesCount;
            document.getElementById('totalRegions').textContent = availableRegions.length;
            document.getElementById('totalLogs').textContent = securityLogs.length;
            
            // ğŸ“Š ìƒˆë¡œìš´ ì•± ì‚¬ìš© í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalFoundContacts').textContent = totalFoundContacts.toLocaleString();
            document.getElementById('totalPhoneCalls').textContent = totalPhoneCalls.toLocaleString();
            document.getElementById('totalSMS').textContent = totalSMS.toLocaleString();
            
            // ğŸ“Š í‰ê·  í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('avgFoundContacts').textContent = avgFoundContacts;
            document.getElementById('avgPhoneCalls').textContent = avgPhoneCalls;
            document.getElementById('avgSMS').textContent = avgSMS;
            document.getElementById('avgUsage').textContent = avgUsage;
            
            // ì‚¬ìš©ì ê´€ë¦¬ íƒ­ì˜ ì‚¬ìš©ì ìˆ˜ë„ ì—…ë°ì´íŠ¸
            const userCountEl = document.getElementById('userCount');
            if (userCountEl) {
                userCountEl.textContent = totalUsers;
            }
            
            // ì§€ì—­ í†µê³„ ì—…ë°ì´íŠ¸
            updateRegionStats();
            
            // ìµœê·¼ í™œë™ í‘œì‹œ (ë¡œê·¸ì¸ê³¼ ì‚¬ìš©ì ì¶”ê°€ë§Œ í•„í„°ë§)
            const recentActivity = document.getElementById('recentActivity');
            if (securityLogs.length > 0) {
                // ê´€ë¦¬ì ë¡œê·¸ì¸ê³¼ ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ ë¡œê·¸ë§Œ í•„í„°ë§
                const importantLogs = securityLogs.filter(log => {
                    const message = log.message.toLowerCase();
                    return (
                        (message.includes('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ') && log.level === 'INFO') ||
                        (message.includes('ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ') && log.level === 'INFO') ||
                        (message.includes('ê¸°ê¸° ë“±ë¡ ìŠ¹ì¸ ì™„ë£Œ') && log.level === 'INFO') ||
                        (message.includes('ê¶Œí•œ ì—…ë°ì´íŠ¸ ì™„ë£Œ') && log.level === 'INFO') ||
                        (message.includes('ì„¸ì…˜ ë³µì› ì„±ê³µ') && log.level === 'INFO')
                    );
                });
                if (importantLogs.length > 0) {
                    let html = '';
                    importantLogs.slice(0, 5).forEach(log => {
                        let displayMessage = log.message;
                        let icon = 'â„¹ï¸';
                        // ë©”ì‹œì§€ í¬ë§·íŒ…
                        if (log.message.includes('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ') || log.message.includes('ì„¸ì…˜ ë³µì› ì„±ê³µ')) {
                            const match = log.message.match(/(ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ|ì„¸ì…˜ ë³µì› ì„±ê³µ): (\w+)/);
                            if (match) {
                                displayMessage = `${match[1] === 'ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ' ? 'ê´€ë¦¬ì ë¡œê·¸ì¸' : 'ì„¸ì…˜ ë³µì›'}: ${match[2]}`;
                                icon = 'ğŸ”';
                            }
                        } else if (log.message.includes('ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ')) {
                            const phoneMatch = log.message.match(/ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ: (\d+)/);
                            const nameMatch = log.message.match(/ë“±ë¡ì: ([^,)]+)/);
                            const referrerMatch = log.message.match(/ì¶”ì²œì¸: ([^)]+)/);
                            if (phoneMatch) {
                                const formattedPhone = formatPhoneNumber(phoneMatch[1]);
                                const userName = nameMatch ? nameMatch[1] : 'ì´ë¦„ ì—†ìŒ';
                                const referrerInfo = referrerMatch ? ` [ì¶”ì²œì¸: ${referrerMatch[1]}]` : '';
                                displayMessage = `ì‚¬ìš©ì ì¶”ê°€: ${formattedPhone} (${userName})${referrerInfo}`;
                                icon = 'ğŸ‘¤';
                            }
                        } else if (log.message.includes('ê¸°ê¸° ë“±ë¡ ìŠ¹ì¸ ì™„ë£Œ')) {
                            const phoneMatch = log.message.match(/ê¸°ê¸° ë“±ë¡ ìŠ¹ì¸ ì™„ë£Œ: ([^ ]+)/);
                            const deviceMatch = log.message.match(/\(([^)]+)\)/);
                            if (phoneMatch) {
                                const deviceInfo = deviceMatch ? ` (${deviceMatch[1]})` : '';
                                displayMessage = `ê¸°ê¸° ë“±ë¡ ìŠ¹ì¸: ${phoneMatch[1]}${deviceInfo}`;
                                icon = 'ğŸ“±';
                            }
                        } else if (log.message.includes('ê¶Œí•œ ì—…ë°ì´íŠ¸ ì™„ë£Œ')) {
                            const phoneMatch = log.message.match(/ê¶Œí•œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ([^ ]+)/);
                            const regionMatch = log.message.match(/ì§€ì—­: ([^)]+)/);
                            if (phoneMatch) {
                                const regionInfo = regionMatch ? ` (${regionMatch[1]})` : '';
                                displayMessage = `ê¶Œí•œ ì—…ë°ì´íŠ¸: ${phoneMatch[1]}${regionInfo}`;
                                icon = 'ğŸ—ºï¸';
                            }
                        }
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">${icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #2d3748;">${displayMessage}</div>
                                    <small style="color: #718096;">${log.timestamp}</small>
                                </div>
                            </div>
                        `;
                    });
                    recentActivity.innerHTML = html;
                } else {
                    recentActivity.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">ì•„ì§ ì£¼ìš” í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } else {
                recentActivity.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            // ğŸ“Š ì¶”ê°€ í†µê³„ ë¡œê·¸ ì¶œë ¥
            console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸:', {
                totalUsers,
                activeUsers,
                totalFoundContacts,
                totalPhoneCalls,
                totalSMS,
                avgFoundContacts,
                avgPhoneCalls,
                avgSMS,
                avgUsage
            });
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(element, message, type) {
            const className = type === 'error' ? 'error-message' : 'success-message';
            element.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // ì „í™”ë²ˆí˜¸ ì •ê·œí™” (ê°•í™”ëœ ë²„ì „)
        function normalizePhoneNumber(phone) {
            if (!phone) return null;
            // ëª¨ë“  ê³µë°±, í•˜ì´í”ˆ, ê´„í˜¸, ì  ë“± ì œê±°í•˜ê³  ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
            const cleaned = phone.replace(/[^\d]/g, '');
            // í•œêµ­ ì „í™”ë²ˆí˜¸ í˜•ì‹ ì²´í¬
            if (cleaned.length === 10) {
                // 0101234567 -> 01012345678 í˜•íƒœë¡œ ê°€ì • (ì˜ëª»ëœ ì…ë ¥)
                return null;
            } else if (cleaned.length === 11) {
                // 01012345678 í˜•íƒœ
                if (cleaned.startsWith('010') || cleaned.startsWith('011') || 
                    cleaned.startsWith('016') || cleaned.startsWith('017') || 
                    cleaned.startsWith('018') || cleaned.startsWith('019')) {
                    return cleaned;
                }
            } else if (cleaned.length === 12 && cleaned.startsWith('82')) {
                // 821012345678 -> 01012345678 ë³€í™˜ (êµ­ê°€ë²ˆí˜¸ ì œê±°)
                return cleaned.substring(2);
            } else if (cleaned.length === 13 && cleaned.startsWith('8210')) {
                // 82101234567 -> 01012345678 ë³€í™˜ (êµ­ê°€ë²ˆí˜¸ ì œê±°)
                return cleaned.substring(2);
            }
            return null;
        }

        // ì „í™”ë²ˆí˜¸ í˜•ì‹ í‘œì‹œìš© í•¨ìˆ˜
        function formatPhoneNumber(phone) {
            if (!phone || phone.length !== 11) return phone;
            return `${phone.substring(0,3)}-${phone.substring(3,7)}-${phone.substring(7)}`;
        }

        // ========================================
        // 10. íƒ­ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ========================================
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // ëª¨ë“  íƒ­ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            currentTab = tabName;
            // íƒ­ë³„ íŠ¹ë³„í•œ ë™ì‘
            switch(tabName) {
                case 'dashboard':
                    updateDashboardStats();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'devices':
                    loadDeviceRequests();
                    loadRegisteredDevices();
                    break;
                case 'referrers':
                    updateReferrerStats();
                    break;
                case 'regions':
                    updateRegionCheckboxes();
                    displayRegionsList();
                    updateRegionStats();
                    break;
                case 'security':
                    displaySecurityLogs();
                    break;
                case 'settings':
                    updateAdminInfo();
                    break;
            }
            addSecurityLog('INFO', `íƒ­ ì „í™˜: ${tabName}`);
        }

        // ========================================
        // 11. ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ğŸ“Š ìƒˆë¡œìš´ í†µê³„ í¬í•¨)
        // ========================================
        
        // ì‹¤ì‹œê°„ ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ (Firebase í˜¸ì¶œ ìµœì†Œí™”)
        async function checkPhoneDuplicate(phoneNumber) {
            if (!phoneNumber || !db) return false;
            const normalizedPhone = normalizePhoneNumber(phoneNumber);
            if (!normalizedPhone) return false;
            try {
                // ë¡œì»¬ ì‚¬ìš©ì ëª©ë¡ì—ì„œë§Œ ì²´í¬ (Firebase í˜¸ì¶œ ì œê±°)
                const localDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                return !!localDuplicate;
            } catch (error) {
                addSecurityLog('WARNING', `ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                return false;
            }
        }

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì‹œ ë¡œì»¬ ì¤‘ë³µ ì²´í¬ë§Œ ìˆ˜í–‰ (Firebase í˜¸ì¶œ ì œê±°)
        let duplicateCheckTimeout;
        function handlePhoneInput() {
            const phoneInput = document.getElementById('newUserPhone');
            const phone = phoneInput.value.trim();
            clearTimeout(duplicateCheckTimeout);
            // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            phoneInput.classList.remove('duplicate', 'valid');
            if (phone.length >= 10) {
                duplicateCheckTimeout = setTimeout(async () => {
                    const normalizedPhone = normalizePhoneNumber(phone);
                    if (normalizedPhone) {
                        // ë¡œì»¬ ë°ì´í„°ì—ì„œë§Œ ì¤‘ë³µ ì²´í¬ (Firebase í˜¸ì¶œ ì—†ìŒ)
                        const isDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                        if (isDuplicate) {
                            phoneInput.classList.add('duplicate');
                            showMessage(document.getElementById('addUserMessage'), 
                                      'ğŸš« ë“±ë¡í•  ìˆ˜ ì—†ëŠ” ì „í™”ë²ˆí˜¸ ì…ë‹ˆë‹¤!', 'error');
                        } else {
                            phoneInput.classList.add('valid');
                            document.getElementById('addUserMessage').innerHTML = '';
                        }
                    }
                }, 300); // ì‘ë‹µ ì‹œê°„ë„ ë‹¨ì¶•
            }
        }

        // ì‚¬ìš©ì ì¶”ê°€ (ê°•í™”ëœ ì¤‘ë³µ ë°©ì§€, ì§€ì—­ ê¶Œí•œ í¬í•¨)
        async function addUser() {
            const phone = document.getElementById('newUserPhone').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const referrer = document.getElementById('newUserReferrer').value.trim();
            const messageEl = document.getElementById('addUserMessage');
            const phoneInput = document.getElementById('newUserPhone');
            
            console.log('=== ì‚¬ìš©ì ì¶”ê°€ ì‹œì‘ ===');
            console.log('ì…ë ¥ëœ ì „í™”ë²ˆí˜¸:', phone);
            console.log('ì…ë ¥ëœ ì´ë¦„:', name);
            console.log('ì…ë ¥ëœ ì¶”ì²œì¸:', referrer);
            
            if (!phone) {
                showMessage(messageEl, 'ğŸ“ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                return;
            }
            
            const normalizedPhone = normalizePhoneNumber(phone);
            console.log('ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸:', normalizedPhone);
            
            if (!normalizedPhone) {
                showMessage(messageEl, 'âŒ ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                phoneInput.select();
                return;
            }
            
            // ì„ íƒëœ ì§€ì—­ ê¶Œí•œ ê°€ì ¸ì˜¤ê¸°
            const selectedRegions = getSelectedRegions();
            console.log('ì„ íƒëœ ì§€ì—­ ê¶Œí•œ:', selectedRegions);
            
            try {
                addSecurityLog('INFO', `ì‚¬ìš©ì ì¶”ê°€ ì‹œë„: ${normalizedPhone}`);
                
                // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
                console.log('Firebase db ê°ì²´:', db);
                if (!db) {
                    console.error('Firebase dbê°€ nullì…ë‹ˆë‹¤!');
                    showMessage(messageEl, 'âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // 1ì°¨: ë¡œì»¬ ë©”ëª¨ë¦¬ì—ì„œ ë¹ ë¥¸ ì¤‘ë³µ ì²´í¬
                console.log('ë¡œì»¬ ì¤‘ë³µ ì²´í¬ ì‹œì‘', 'ì „ì²´ ì‚¬ìš©ì ìˆ˜:', allUsers.length);
                const localDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                if (localDuplicate) {
                    console.log('ë¡œì»¬ ì¤‘ë³µ ë°œê²¬:', localDuplicate);
                    showMessage(messageEl, `ğŸš« ë“±ë¡í•  ìˆ˜ ì—†ëŠ” ì „í™”ë²ˆí˜¸ ì…ë‹ˆë‹¤! (ë“±ë¡ì: ${localDuplicate.name})`, 'error');
                    addSecurityLog('WARNING', `ë¡œì»¬ ì¤‘ë³µ ì‚¬ìš©ì ë“±ë¡ ì‹œë„: ${normalizedPhone}`);
                    phoneInput.classList.add('duplicate');
                    phoneInput.focus();
                    phoneInput.select();
                    return;
                }
                
                // 2ì°¨: Firebaseì—ì„œ ìµœì¢… ì¤‘ë³µ ì²´í¬ (1íšŒë§Œ)
                console.log('Firebase ìµœì¢… ì¤‘ë³µ ì²´í¬...');
                try {
                    const existingUser = await db.collection('authorized_users')
                        .where('phoneNumber', '==', normalizedPhone)
                        .get();
                    console.log('Firebase ì¿¼ë¦¬ ê²°ê³¼:', existingUser.size);
                    
                    if (!existingUser.empty) {
                        // ì¤‘ë³µ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        const duplicateUser = existingUser.docs[0].data();
                        console.log('ì¤‘ë³µ ì‚¬ìš©ì ì •ë³´:', duplicateUser);
                        showMessage(messageEl, 
                                  `ğŸš« ë“±ë¡í•  ìˆ˜ ì—†ëŠ” ì „í™”ë²ˆí˜¸ ì…ë‹ˆë‹¤!\në“±ë¡ì: ${duplicateUser.name}\në“±ë¡ì¼: ${duplicateUser.createdAt ? duplicateUser.createdAt.toDate().toLocaleDateString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ'}`, 
                                  'error');
                        addSecurityLog('WARNING', `Firebase ì¤‘ë³µ ì‚¬ìš©ì ë“±ë¡ ì‹œë„: ${normalizedPhone} (ê¸°ì¡´ ë“±ë¡ì: ${duplicateUser.name})`);
                        phoneInput.classList.add('duplicate');
                        phoneInput.focus();
                        phoneInput.select();
                        return;
                    }
                } catch (queryError) {
                    console.error('Firebase ì¿¼ë¦¬ ì˜¤ë¥˜:', queryError);
                    addSecurityLog('ERROR', `Firebase ì¿¼ë¦¬ ì‹¤íŒ¨: ${queryError.message}`);
                    showMessage(messageEl, `âŒ ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜: ${queryError.message}`, 'error');
                    return;
                }
                
                // 3ì°¨: ì•ˆì „í•œ ì‚¬ìš©ì ì¶”ê°€
                console.log('ì‚¬ìš©ì ì¶”ê°€ ì‹œì‘...');
                const userData = {
                    phoneNumber: normalizedPhone,
                    name: name || 'ì´ë¦„ ì—†ìŒ',
                    referrer: referrer || null,
                    regions: selectedRegions.length > 0 ? selectedRegions : null, // ì§€ì—­ ê¶Œí•œ ì¶”ê°€
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    usageCount: 0,
                    lastUsed: null,
                    addedBy: currentUser ? currentUser.username : 'unknown',
                    addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceId: null, // ê¸°ê¸° ë“±ë¡ ë°©ì‹ ì§€ì›
                    deviceName: null,
                    deviceRegisteredAt: null,
                    // ğŸ“Š ìƒˆë¡œìš´ í†µê³„ í•„ë“œë“¤ ì´ˆê¸°í™”
                    foundContactsCount: 0,
                    phoneCallCount: 0,
                    smsCount: 0
                };
                console.log('ì¶”ê°€í•  ì‚¬ìš©ì ë°ì´í„°:', userData);
                
                const docRef = await db.collection('authorized_users').add(userData);
                console.log('ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ, ë¬¸ì„œ ID:', docRef.id);
                
                // ì„±ê³µ ì²˜ë¦¬
                showMessage(messageEl, 'âœ… ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                document.getElementById('newUserPhone').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserReferrer').value = '';
                phoneInput.classList.remove('duplicate', 'valid');
                
                // ì§€ì—­ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                clearAllRegions();
                
                // ë¡œê·¸ì— ì§€ì—­ ê¶Œí•œ ì •ë³´ë„ í¬í•¨
                const regionInfo = selectedRegions.length > 0 ? ` (ì§€ì—­: ${selectedRegions.join(', ')})` : ' (ë¬´ì œí•œ ì ‘ê·¼)';
                const logMessage = referrer 
                    ? `ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ: ${normalizedPhone} (ID: ${docRef.id}, ë“±ë¡ì: ${name || 'ì´ë¦„ ì—†ìŒ'}, ì¶”ì²œì¸: ${referrer})${regionInfo}`
                    : `ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ: ${normalizedPhone} (ID: ${docRef.id}, ë“±ë¡ì: ${name || 'ì´ë¦„ ì—†ìŒ'})${regionInfo}`;
                addSecurityLog('INFO', logMessage);
                
                // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    console.log('ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
                    loadUsers();
                    updateDashboardStats();
                    // ì¶”ì²œì¸ í†µê³„ë„ ì—…ë°ì´íŠ¸ (ì¶”ì²œì¸ì´ ìˆëŠ” ê²½ìš°)
                    if (referrer && currentTab === 'referrers') {
                        updateReferrerStats();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('=== ì‚¬ìš©ì ì¶”ê°€ ì˜¤ë¥˜ ===');
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì˜¤ë¥˜ ì½”ë“œ:', error.code);
                console.error('ì „ì²´ ì˜¤ë¥˜ ê°ì²´:', error);
                addSecurityLog('ERROR', `ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ${error.message} (ì½”ë“œ: ${error.code})`);
                let errorMessage = 'âŒ ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'âŒ Firebase ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'âŒ Firebase ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMessage = `âŒ ì˜¤ë¥˜: ${error.message}`;
                }
                showMessage(messageEl, errorMessage, 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                phoneInput.select();
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ (ê·¹í•œ ìºì‹±)
        async function loadUsers(forceRefresh = false) {
            try {
                const now = Date.now();
                // ìºì‹œê°€ ìœ íš¨í•˜ê³  ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ ê²½ìš°
                if (!forceRefresh && usersCache.loaded && 
                    (now - usersCache.timestamp < CACHE_DURATION) && 
                    usersCache.data.length > 0) {
                    addSecurityLog('INFO', `ì‚¬ìš©ì ëª©ë¡ ìºì‹œ ì‚¬ìš© (${usersCache.data.length}ëª…)`);
                    allUsers = [...usersCache.data];
                    displayUsers(allUsers);
                    updateDashboardStats();
                    return;
                }
                
                addSecurityLog('INFO', 'ì‚¬ìš©ì ëª©ë¡ Firebase ë¡œë“œ ì‹œë„');
                if (!db) {
                    // Firebase ì—†ì´ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                    addSecurityLog('WARNING', 'Firebase ë¯¸ì´ˆê¸°í™” - ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©');
                    allUsers = [];
                    displayUsers(allUsers);
                    return;
                }
                
                // Firebase í˜¸ì¶œ ì œí•œ
                const snapshot = await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users')
                        .orderBy('createdAt', 'desc')
                        .limit(500) // ìµœëŒ€ 500ëª…ìœ¼ë¡œ ì œí•œ
                        .get();
                });
                
                addSecurityLog('INFO', `Firestoreì—ì„œ ${snapshot.size}ê°œ ë¬¸ì„œ ì¡°íšŒ`);
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // ìºì‹œ ì—…ë°ì´íŠ¸
                usersCache = {
                    data: [...allUsers],
                    timestamp: now,
                    loaded: true
                };
                
                displayUsers(allUsers);
                addSecurityLog('INFO', `ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${allUsers.length}ëª… (ìºì‹œë¨)`);
                
                // ëŒ€ì‹œë³´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
                updateDashboardStats();
                
                // ì¶”ì²œì¸ í†µê³„ ì—…ë°ì´íŠ¸ (ì¶”ì²œì¸ íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°)
                if (currentTab === 'referrers') {
                    updateReferrerStats();
                }
                
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ - ìºì‹œëœ ë°ì´í„° ì‚¬ìš©');
                    if (usersCache.data.length > 0) {
                        allUsers = [...usersCache.data];
                        displayUsers(allUsers);
                        addSecurityLog('INFO', `ìºì‹œëœ ì‚¬ìš©ì ë°ì´í„° ì‚¬ìš© (${allUsers.length}ëª…)`);
                    } else {
                        addSecurityLog('WARNING', 'ìºì‹œëœ ë°ì´í„° ì—†ìŒ - ë¹ˆ ëª©ë¡ í‘œì‹œ');
                        allUsers = [];
                        displayUsers(allUsers);
                    }
                } else {
                    addSecurityLog('ERROR', `ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                    document.getElementById('userList').innerHTML = `<div class="error-message">ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}<br><button onclick="loadUsers(true)" class="btn btn-secondary">ğŸ”„ ì¬ì‹œë„</button></div>`;
                }
            }
        }

        // ğŸ“Š ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ (ìƒˆë¡œìš´ í†µê³„ ì¶”ê°€)
        function displayUsers(users) {
            const userListEl = document.getElementById('userList');
            if (users.length === 0) {
                userListEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            let html = '';
            users.forEach(user => {
                const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleDateString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const formattedPhone = formatPhoneNumber(user.phoneNumber);
                const referrerText = user.referrer ? ` | ì¶”ì²œì¸: ${user.referrer}` : '';
                
                // ê¶Œí•œ ì •ë³´ í‘œì‹œ
                const permissionText = getUserPermissionText(user);
                const permissionTags = user.regions && user.regions.length > 0 
                    ? user.regions.map(region => `<span class="permission-tag limited">${region}</span>`).join('')
                    : '<span class="permission-tag all-regions">ëª¨ë“  ì§€ì—­</span>';
                
                // ğŸ“Š ìƒˆë¡œìš´ í†µê³„ ì •ë³´ ì¶”ê°€
                const foundContacts = user.foundContactsCount || 0;
                const phoneCallCount = user.phoneCallCount || 0;
                const smsCount = user.smsCount || 0;
                const usageCount = user.usageCount || 0;
                
                // í†µê³„ í…ìŠ¤íŠ¸ ìƒì„±
                const statsText = `ì°¾ì€ ì§€ì¸: ${foundContacts}ëª… | ì „í™”: ${phoneCallCount}íšŒ | ë¬¸ì: ${smsCount}íšŒ`;
                
                html += `
                    <div class="user-item">
                        <div>
                            <strong>${formattedPhone}</strong> (${user.name || 'ì´ë¦„ ì—†ìŒ'})<br>
                            <small>ê°€ì…: ${createdAt} | ì‚¬ìš©íšŸìˆ˜: ${usageCount}íšŒ${referrerText}</small>
                            <div class="user-permissions">
                                <span style="font-size: 12px; color: #666; margin-right: 8px;">ê¶Œí•œ:</span>
                                ${permissionTags}
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #495057;">
                                <span style="font-weight: bold; color: #667eea;">ğŸ“Š ì´ìš© í†µê³„:</span> ${statsText}
                            </div>
                        </div>
                        <div class="user-actions">
                            <button onclick="openPermissionsModal('${user.id}')" class="btn btn-edit">
                                ğŸ—ºï¸ ê¶Œí•œ í¸ì§‘
                            </button>
                            <button onclick="toggleUserStatus('${user.id}', ${!user.isActive})" 
                                    class="btn ${user.isActive ? 'btn-danger' : 'btn-primary'}">
                                ${user.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}
                            </button>
                            <button onclick="deleteUser('${user.id}', '${formattedPhone}')" 
                                    class="btn btn-danger">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            userListEl.innerHTML = html;
        }

        // ì‚¬ìš©ì ìƒíƒœ í† ê¸€ (Firebase í˜¸ì¶œ ì œí•œ)
        async function toggleUserStatus(userId, newStatus) {
            try {
                const user = allUsers.find(u => u.id === userId);
                const formattedPhone = formatPhoneNumber(user?.phoneNumber);
                addSecurityLog('INFO', `ì‚¬ìš©ì ìƒíƒœ ë³€ê²½: ${formattedPhone} -> ${newStatus ? 'í™œì„±' : 'ë¹„í™œì„±'}`);
                
                // ë¡œì»¬ì—ì„œ ë¨¼ì € ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ UI ë°˜ì˜)
                if (user) {
                    user.isActive = newStatus;
                }
                displayUsers(allUsers);
                
                // Firebase ì—…ë°ì´íŠ¸ (ì œí•œ ì ìš©)
                await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users').doc(userId).update({
                        isActive: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.username
                    });
                });
                
                alert(`ì‚¬ìš©ì ${formattedPhone}ì´(ê°€) ${newStatus ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ - ë¡œì»¬ ë³€ê²½ë§Œ ì ìš©');
                    alert(`ë¡œì»¬ì—ì„œ ${formattedPhone}ì´(ê°€) ${newStatus ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤. (Firebase ì €ì¥ ì‹¤íŒ¨)`);
                } else {
                    addSecurityLog('ERROR', `ì‚¬ìš©ì ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`);
                    alert('ì‚¬ìš©ì ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    // ì‹¤íŒ¨ì‹œ ë¡œì»¬ ë³€ê²½ ë¡¤ë°±
                    if (user) {
                        user.isActive = !newStatus;
                        displayUsers(allUsers);
                    }
                }
            }
        }

        // ì‚¬ìš©ì ì‚­ì œ
        async function deleteUser(userId, formattedPhoneNumber) {
            if (confirm(`ì •ë§ë¡œ ${formattedPhoneNumber} ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                try {
                    const user = allUsers.find(u => u.id === userId);
                    addSecurityLog('WARNING', `ì‚¬ìš©ì ì‚­ì œ: ${formattedPhoneNumber} (${user?.name})`);
                    await db.collection('authorized_users').doc(userId).delete();
                    loadUsers();
                    alert(`ì‚¬ìš©ì ${formattedPhoneNumber}ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    addSecurityLog('ERROR', `ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                    alert('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ========================================
        // 12. ì¶”ì²œì¸ í†µê³„ ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ========================================
        
        // ì¶”ì²œì¸ í†µê³„ ì—…ë°ì´íŠ¸
        function updateReferrerStats() {
            calculateReferrerStats();
            displayReferrerRanking();
            updateReferrerFilter();
        }

        // ì¶”ì²œì¸ë³„ í†µê³„ ê³„ì‚°
        function calculateReferrerStats() {
            console.log('ì¶”ì²œì¸ í†µê³„ ê³„ì‚° ì‹œì‘', 'ì „ì²´ ì‚¬ìš©ì:', allUsers.length);
            // ì¶”ì²œì¸ë³„ ë°ì´í„° ì§‘ê³„
            const referrerData = {};
            let selfRegistered = 0;
            let totalReferred = 0;
            
            allUsers.forEach(user => {
                if (user.referrer && user.referrer.trim()) {
                    const referrer = user.referrer.trim();
                    if (!referrerData[referrer]) {
                        referrerData[referrer] = {
                            name: referrer,
                            totalUsers: 0,
                            activeUsers: 0,
                            users: []
                        };
                    }
                    referrerData[referrer].totalUsers++;
                    referrerData[referrer].users.push(user);
                    totalReferred++;
                    if (user.isActive) {
                        referrerData[referrer].activeUsers++;
                    }
                } else {
                    selfRegistered++;
                }
            });
            
            // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
            window.referrerStats = referrerData;
            
            // í†µê³„ í‘œì‹œ
            const totalReferrers = Object.keys(referrerData).length;
            const avgReferrals = totalReferrers > 0 ? (totalReferred / totalReferrers).toFixed(1) : 0;
            
            document.getElementById('totalReferrers').textContent = totalReferrers;
            document.getElementById('referredUsers').textContent = totalReferred;
            document.getElementById('selfRegistered').textContent = selfRegistered;
            document.getElementById('avgReferrals').textContent = avgReferrals;
            
            console.log('ì¶”ì²œì¸ í†µê³„:', {
                totalReferrers,
                totalReferred,
                selfRegistered,
                avgReferrals,
                referrerData
            });
        }

        // ì¶”ì²œì¸ ìˆœìœ„ í‘œì‹œ
        function displayReferrerRanking() {
            const rankingEl = document.getElementById('referrerRanking');
            const referrerData = window.referrerStats || {};
            
            // ì¶”ì²œ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
            const sortedReferrers = Object.values(referrerData).sort((a, b) => b.totalUsers - a.totalUsers);
            
            if (sortedReferrers.length === 0) {
                rankingEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ì¶”ì²œì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            sortedReferrers.forEach((referrer, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}ìœ„`;
                const activeRate = referrer.totalUsers > 0 ? ((referrer.activeUsers / referrer.totalUsers) * 100).toFixed(1) : 0;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${rank <= 3 ? '#667eea' : '#e2e8f0'}; cursor: pointer;" onclick="selectReferrer('${referrer.name}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #2d3748;">
                                    ${medal} ${referrer.name}
                                </div>
                                <small style="color: #718096;">í™œì„±ë¥ : ${activeRate}%</small>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;">
                                    ${referrer.totalUsers}ëª…
                                </div>
                                <small style="color: #718096;">ì¶”ì²œ</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            rankingEl.innerHTML = html;
        }

        // ì¶”ì²œì¸ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateReferrerFilter() {
            const filterEl = document.getElementById('referrerFilter');
            const referrerData = window.referrerStats || {};
            
            // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
            filterEl.innerHTML = '<option value="">ì „ì²´ ì¶”ì²œì¸</option>';
            
            // ì¶”ì²œì¸ë³„ ì˜µì…˜ ì¶”ê°€
            const sortedReferrers = Object.values(referrerData).sort((a, b) => b.totalUsers - a.totalUsers);
            sortedReferrers.forEach(referrer => {
                const option = document.createElement('option');
                option.value = referrer.name;
                option.textContent = `${referrer.name} (${referrer.totalUsers}ëª…)`;
                filterEl.appendChild(option);
            });
        }

        // íŠ¹ì • ì¶”ì²œì¸ ì„ íƒ
        function selectReferrer(referrerName) {
            const filterEl = document.getElementById('referrerFilter');
            filterEl.value = referrerName;
            filterByReferrer();
        }

        // ì¶”ì²œì¸ë³„ ì‚¬ìš©ì ëª©ë¡ í•„í„°ë§
        function filterByReferrer() {
            const selectedReferrer = document.getElementById('referrerFilter').value;
            const listEl = document.getElementById('referredUsersList');
            const referrerData = window.referrerStats || {};
            
            if (!selectedReferrer) {
                listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ì¶”ì²œì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            const referrerInfo = referrerData[selectedReferrer];
            if (!referrerInfo || referrerInfo.users.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">í•´ë‹¹ ì¶”ì²œì¸ì˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = `
                <div style="background: #667eea; color: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
                    <strong>${selectedReferrer}</strong>ì˜ ì¶”ì²œ ì‚¬ìš©ì (${referrerInfo.totalUsers}ëª…)
                </div>
            `;
            
            referrerInfo.users.forEach((user, index) => {
                const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleDateString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const formattedPhone = formatPhoneNumber(user.phoneNumber);
                html += `
                    <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid ${user.isActive ? '#28a745' : '#dc3545'};">
                        <div style="font-weight: bold; color: #2d3748;">
                            ${index + 1}. ${formattedPhone} (${user.name || 'ì´ë¦„ ì—†ìŒ'})
                        </div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                            ê°€ì…: ${createdAt} | ì‚¬ìš©: ${user.usageCount || 0}íšŒ | ìƒíƒœ: ${user.isActive ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }

        // ========================================
        // 13. ê¸°ê¸° ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ìˆ˜ì •ëœ ë²„ì „)
        // ========================================
        
        // ê¸°ê¸° ë“±ë¡ ìš”ì²­ ëª©ë¡ ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadDeviceRequests(forceRefresh = false) {
            try {
                const now = Date.now();
                // ê¸°ê¸° ìš”ì²­ì€ ì‹¤ì‹œê°„ì„±ì´ ì¤‘ìš”í•˜ì§€ë§Œ, 1ë¶„ ìºì‹œ ì ìš©
                if (!forceRefresh && devicesCache.timestamp && 
                    (now - devicesCache.timestamp < 60 * 1000) && 
                    devicesCache.data.length >= 0) {
                    addSecurityLog('INFO', `ê¸°ê¸° ìš”ì²­ ìºì‹œ ì‚¬ìš© (${devicesCache.data.length}ê±´)`);
                    deviceRequests = [...devicesCache.data];
                    displayDeviceRequests();
                    return;
                }
                
                addSecurityLog('INFO', 'ê¸°ê¸° ë“±ë¡ ìš”ì²­ ëª©ë¡ ë¡œë“œ ì‹œë„');
                if (!db) {
                    document.getElementById('deviceRequests').innerHTML = '<div class="error-message">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                // ìˆ˜ì •ëœ ì¿¼ë¦¬ - orderBy ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ì—ëŸ¬ ë°©ì§€
                const snapshot = await throttledFirebaseCall(async () => {
                    return await db.collection('device_registration_requests')
                        .where('status', '==', 'pending') // pendingë§Œ ì¡°íšŒ
                        .limit(50) // ìµœëŒ€ 50ê±´ìœ¼ë¡œ ì œí•œ
                        .get();
                });
                
                deviceRequests = [];
                snapshot.forEach(doc => {
                    deviceRequests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // ë©”ëª¨ë¦¬ì—ì„œ ì •ë ¬ (requestedAtì´ ìˆëŠ” ê²½ìš°ë§Œ)
                deviceRequests.sort((a, b) => {
                    if (a.requestedAt && b.requestedAt) {
                        return b.requestedAt.seconds - a.requestedAt.seconds;
                    }
                    return 0;
                });
                
                // ìºì‹œ ì—…ë°ì´íŠ¸
                devicesCache = {
                    data: [...deviceRequests],
                    timestamp: now
                };
                
                displayDeviceRequests();
                addSecurityLog('INFO', `ê¸°ê¸° ë“±ë¡ ìš”ì²­ ë¡œë“œ ì™„ë£Œ: ${deviceRequests.length}ê±´`);
                
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ - ê¸°ê¸° ìš”ì²­ ìºì‹œ ì‚¬ìš©');
                    if (devicesCache.data) {
                        deviceRequests = [...devicesCache.data];
                        displayDeviceRequests();
                    }
                } else if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                    addSecurityLog('ERROR', `Firebase ê¶Œí•œ ë¶€ì¡±: ${error.message}`);
                    // ê¶Œí•œ ë¶€ì¡±ì‹œ ë¹ˆ ëª©ë¡ìœ¼ë¡œ ì²˜ë¦¬ (ëª¨ì˜ ë°ì´í„° ì‚¬ìš© ê°€ëŠ¥)
                    deviceRequests = [];
                    document.getElementById('deviceRequests').innerHTML = `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ ê¶Œí•œ ë¶€ì¡±</h4>
                            <p style="color: #856404; margin-bottom: 15px;">ê¸°ê¸° ë“±ë¡ ìš”ì²­ ë°ì´í„°ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                                <strong>í•´ê²° ë°©ë²•:</strong><br>
                                1. Firebase Console â†’ Firestore â†’ ê·œì¹™<br>
                                2. device_registration_requests ì»¬ë ‰ì…˜ì— ì½ê¸° ê¶Œí•œ ì¶”ê°€<br>
                                3. ë˜ëŠ” ê´€ë¦¬ìì—ê²Œ ê¶Œí•œ ì„¤ì • ìš”ì²­
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="loadDeviceRequests(true)" class="btn btn-secondary">ğŸ”„ ì¬ì‹œë„</button>
                            </div>
                        </div>
                    `;
                    displayDeviceRequests(); // ë¹ˆ ëª©ë¡ í‘œì‹œ
                } else {
                    addSecurityLog('ERROR', `ê¸°ê¸° ë“±ë¡ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                    document.getElementById('deviceRequests').innerHTML = `<div class="error-message">ê¸°ê¸° ë“±ë¡ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨: ${error.message}<br><button onclick="loadDeviceRequests(true)" class="btn btn-secondary">ğŸ”„ ì¬ì‹œë„</button></div>`;
                }
            }
        }

        // ê¸°ê¸° ë“±ë¡ ìš”ì²­ í‘œì‹œ
        function displayDeviceRequests() {
            const requestsEl = document.getElementById('deviceRequests');
            const pendingRequests = deviceRequests.filter(req => req.status === 'pending');
            document.getElementById('pendingRequestsCount').textContent = pendingRequests.length;
            
            if (pendingRequests.length === 0) {
                requestsEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">ğŸ‰ ì²˜ë¦¬í•  ê¸°ê¸° ë“±ë¡ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤!</div>';
                return;
            }
            
            let html = '';
            pendingRequests.forEach(request => {
                const requestedAt = request.requestedAt ? request.requestedAt.toDate().toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const formattedPhone = formatPhoneNumber(request.phoneNumber);
                html += `
                    <div class="device-item pending">
                        <div class="status-badge pending">ëŒ€ê¸° ì¤‘</div>
                        <div class="device-info">
                            <div class="device-field">
                                <label>ğŸ“ ì „í™”ë²ˆí˜¸</label>
                                <span>${formattedPhone}</span>
                            </div>
                            <div class="device-field">
                                <label>ğŸ‘¤ ì‚¬ìš©ìëª…</label>
                                <span>${request.userName || 'ì´ë¦„ ì—†ìŒ'}</span>
                            </div>
                            <div class="device-field">
                                <label>ğŸ“± ê¸°ê¸° ID</label>
                                <span style="font-family: monospace; font-size: 12px;">${request.deviceId}</span>
                            </div>
                            <div class="device-field">
                                <label>ğŸ“‹ ê¸°ê¸°ëª…</label>
                                <span>${request.deviceName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                            </div>
                            <div class="device-field">
                                <label>ğŸ• ìš”ì²­ ì‹œê°„</label>
                                <span>${requestedAt}</span>
                            </div>
                            <div class="device-field">
                                <label>ğŸ’¬ ìš”ì²­ ë©”ì‹œì§€</label>
                                <span>${request.userMessage || 'ë©”ì‹œì§€ ì—†ìŒ'}</span>
                            </div>
                        </div>
                        <div class="device-actions">
                            <button onclick="approveDeviceRequest('${request.id}')" class="btn btn-success">
                                âœ… ìŠ¹ì¸
                            </button>
                            <button onclick="rejectDeviceRequest('${request.id}')" class="btn btn-danger">
                                âŒ ê±°ë¶€
                            </button>
                        </div>
                    </div>
                `;
            });
            requestsEl.innerHTML = html;
        }

        // ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadRegisteredDevices() {
            try {
                addSecurityLog('INFO', 'ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹œì‘');
                if (!db) {
                    document.getElementById('registeredDevices').innerHTML = '<div class="error-message">Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                // ìˆ˜ì •ëœ ì¿¼ë¦¬ - orderBy ì œê±°í•˜ì—¬ ì•ˆì •ì„± í–¥ìƒ
                const snapshot = await db.collection('authorized_users')
                    .where('deviceId', '!=', null)
                    .limit(200) // ì œí•œ ì¶”ê°€
                    .get();
                
                registeredDevices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.deviceId) { // deviceIdê°€ ì‹¤ì œë¡œ ìˆëŠ” ê²½ìš°ë§Œ
                        registeredDevices.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // ë©”ëª¨ë¦¬ì—ì„œ ì •ë ¬ (deviceRegisteredAtì´ ìˆëŠ” ê²½ìš°ë§Œ)
                registeredDevices.sort((a, b) => {
                    if (a.deviceRegisteredAt && b.deviceRegisteredAt) {
                        return b.deviceRegisteredAt.seconds - a.deviceRegisteredAt.seconds;
                    }
                    return 0;
                });
                
                displayRegisteredDevices();
                addSecurityLog('INFO', `ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${registeredDevices.length}ëŒ€`);
                
            } catch (error) {
                addSecurityLog('ERROR', `ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                document.getElementById('registeredDevices').innerHTML = `<div class="error-message">ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡ í‘œì‹œ
        function displayRegisteredDevices(devices = registeredDevices) {
            const devicesEl = document.getElementById('registeredDevices');
            document.getElementById('registeredDevicesCount').textContent = devices.length;
            
            if (devices.length === 0) {
                devicesEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">ğŸ“± ë“±ë¡ëœ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const registeredAt = device.deviceRegisteredAt ? device.deviceRegisteredAt.toDate().toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const formattedPhone = formatPhoneNumber(device.phoneNumber);
                html += `
                    <div class="device-item approved">
                        <div>
                            <strong>${formattedPhone}</strong> (${device.name || 'ì´ë¦„ ì—†ìŒ'}) | ë“±ë¡: ${registeredAt}
                        </div>
                        <div class="device-actions">
                            <button onclick="resetUserDevice('${device.id}', '${formattedPhone}')" class="btn btn-warning">
                                ğŸ”„ ê¸°ê¸° ì´ˆê¸°í™”
                            </button>
                            <button onclick="toggleUserStatus('${device.id}', ${!device.isActive})" 
                                    class="btn ${device.isActive ? 'btn-danger' : 'btn-success'}">
                                ${device.isActive ? 'âŒ ë¹„í™œì„±í™”' : 'âœ… í™œì„±í™”'}
                            </button>
                        </div>
                    </div>
                `;
            });
            devicesEl.innerHTML = html;
        }

        // ëª¨ë“  ìºì‹œ ê°•ì œ ë¬´íš¨í™” (ìƒˆë¡œ ì¶”ê°€)
        async function forceRefreshAllCaches() {
            try {
                addSecurityLog('INFO', 'ëª¨ë“  ìºì‹œ ê°•ì œ ë¬´íš¨í™” ì‹œì‘');
                // ëª¨ë“  ìºì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë¬´íš¨í™”
                usersCache.timestamp = 0;
                usersCache.loaded = false;
                devicesCache.timestamp = 0;
                regionsCache.timestamp = 0;
                
                // ë¡œì»¬ ë°°ì—´ë“¤ë„ ì´ˆê¸°í™”
                deviceRequests = [];
                registeredDevices = [];
                
                // UIì— ë¡œë”© ìƒíƒœ í‘œì‹œ
                document.getElementById('deviceRequests').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ”„ ìºì‹œ ë¬´íš¨í™” ì¤‘...</div>';
                document.getElementById('registeredDevices').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ”„ ìºì‹œ ë¬´íš¨í™” ì¤‘...</div>';
                
                // ëª¨ë“  ë°ì´í„° ê°•ì œ ìƒˆë¡œê³ ì¹¨
                await Promise.all([
                    loadDeviceRequests(true), // forceRefresh = true
                    loadRegisteredDevices(),
                    loadUsers(true) // forceRefresh = true
                ]);
                
                updateDashboardStats();
                addSecurityLog('INFO', 'ëª¨ë“  ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ');
                alert('âœ… ìºì‹œê°€ ë¬´íš¨í™”ë˜ê³  ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                addSecurityLog('ERROR', `ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨: ${error.message}`);
                alert('âŒ ìºì‹œ ë¬´íš¨í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // ê¸°ê¸° ìŠ¹ì¸/ê±°ë¶€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼...
        async function approveDeviceRequest(requestId) {
            // ê¸°ì¡´ êµ¬í˜„ê³¼ ë™ì¼
            alert('ê¸°ê¸° ìŠ¹ì¸ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        async function rejectDeviceRequest(requestId) {
            // ê¸°ì¡´ êµ¬í˜„ê³¼ ë™ì¼
            alert('ê¸°ê¸° ê±°ë¶€ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ê¸°ê¸° ê²€ìƒ‰
        function searchDevices() {
            const searchTerm = document.getElementById('deviceSearchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                displayRegisteredDevices();
                return;
            }
            const filteredDevices = registeredDevices.filter(device => {
                const phoneNumber = formatPhoneNumber(device.phoneNumber).toLowerCase();
                const deviceName = (device.deviceName || '').toLowerCase();
                const userName = (device.name || '').toLowerCase();
                const deviceId = (device.deviceId || '').toLowerCase();
                return phoneNumber.includes(searchTerm) || 
                       deviceName.includes(searchTerm) || 
                       userName.includes(searchTerm) ||
                       deviceId.includes(searchTerm);
            });
            displayRegisteredDevices(filteredDevices);
            addSecurityLog('INFO', `ê¸°ê¸° ê²€ìƒ‰: "${searchTerm}" (${filteredDevices.length}ê±´ ë°œê²¬)`);
        }

        // ì‚¬ìš©ì ê¸°ê¸° ì´ˆê¸°í™”
        async function resetUserDevice(userId, formattedPhone) {
            if (!confirm(`${formattedPhone} ì‚¬ìš©ìì˜ ê¸°ê¸° ë“±ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´ ì‚¬ìš©ìê°€ ìƒˆë¡œìš´ ê¸°ê¸° ë“±ë¡ì„ ìš”ì²­í•´ì•¼ í•©ë‹ˆë‹¤.`)) {
                return;
            }
            try {
                addSecurityLog('WARNING', `ì‚¬ìš©ì ê¸°ê¸° ì´ˆê¸°í™”: ${formattedPhone}`);
                await db.collection('authorized_users').doc(userId).update({
                    deviceId: firebase.firestore.FieldValue.delete(),
                    deviceName: firebase.firestore.FieldValue.delete(),
                    deviceRegisteredAt: firebase.firestore.FieldValue.delete(),
                    deviceResetAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceResetBy: currentUser.username
                });
                addSecurityLog('WARNING', `ê¸°ê¸° ì´ˆê¸°í™” ì™„ë£Œ: ${formattedPhone}`);
                alert(`âœ… ${formattedPhone} ì‚¬ìš©ìì˜ ê¸°ê¸°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadRegisteredDevices();
                loadUsers();
            } catch (error) {
                addSecurityLog('ERROR', `ê¸°ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                alert(`âŒ ê¸°ê¸° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // ========================================
        // 14. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥
        // ========================================
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageEl = document.getElementById('adminSettingsMessage');
            
            // ì…ë ¥ ê²€ì¦
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage(messageEl, 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessage(messageEl, 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (newPassword.length < 8) {
                showMessage(messageEl, 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            // ë¹„ë°€ë²ˆí˜¸ ë³µì¡ì„± ê²€ì¦
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/;
            if (!passwordRegex.test(newPassword)) {
                showMessage(messageEl, 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            try {
                addSecurityLog('INFO', `ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œë„: ${currentUser.username}`);
                // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                const currentPasswordHash = CryptoJS.SHA256(currentPassword).toString();
                if (currentUser.password !== currentPasswordHash) {
                    showMessage(messageEl, 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    addSecurityLog('WARNING', `ì˜ëª»ëœ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: ${currentUser.username}`);
                    return;
                }
                
                // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
                const newPasswordHash = CryptoJS.SHA256(newPassword).toString();
                
                // Firebase ì—…ë°ì´íŠ¸
                await db.collection('admin_users').doc(currentUser.id).update({
                    password: newPasswordHash,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    changedBy: currentUser.username
                });
                
                // ë¡œì»¬ currentUser ì •ë³´ ì—…ë°ì´íŠ¸
                currentUser.password = newPasswordHash;
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showMessage(messageEl, 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                addSecurityLog('INFO', `ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ: ${currentUser.username}`);
                
            } catch (error) {
                addSecurityLog('ERROR', `ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`);
                showMessage(messageEl, 'âŒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì•± ë§Œë£Œì¼ ì €ì¥ í•¨ìˆ˜
        async function saveExpiryDate() {
            const dateValue = document.getElementById('expiryDateInput').value;
            if (!dateValue) {
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:red;'>âŒ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</span>";
                return;
            }
            const selectedDate = new Date(dateValue + "T00:00:00");
            try {
                await db.collection('config').doc('settings').set({
                    expiryDate: firebase.firestore.Timestamp.fromDate(selectedDate)
                }, { merge: true });
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:green;'>âœ… ë§Œë£Œì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>";
            } catch (e) {
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:red;'>âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message + "</span>";
            }
        }

        // ========================================
        // 15. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // ========================================
        
        // DOMì´ ë¡œë“œëœ í›„ ì´ˆê¸°í™” (ì„¸ì…˜ ë³µì› ê¸°ëŠ¥ ì¶”ê°€)
        document.addEventListener('DOMContentLoaded', async function() {
            addSecurityLog('INFO', 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹œì‘');
            
            // ë¡œë”© í™”ë©´ í‘œì‹œ
            showLoadingScreen('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            
            // Firebase ì´ˆê¸°í™” (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            try {
                const firebaseInitSuccess = initializeFirebase();
                if (firebaseInitSuccess) {
                    addSecurityLog('INFO', 'Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                } else {
                    addSecurityLog('WARNING', 'Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
                }
            } catch (initError) {
                addSecurityLog('ERROR', `Firebase ì´ˆê¸°í™” ì¤‘ ì˜ˆì™¸: ${initError.message}`);
                // Firebase ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ í´ë°±
                adminUsers = [{
                    id: 'emergency_admin',
                    username: 'admin',
                    password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                    role: 'admin',
                    permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                    isActive: true,
                    isLocal: true,
                    isEmergency: true
                }];
                addSecurityLog('INFO', 'ì‘ê¸‰ ê´€ë¦¬ì ê³„ì • ìƒì„± - ì™„ì „ ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
            }
            
            // ë³´ì•ˆ ê¸°ëŠ¥ í™œì„±í™”
            try {
                blockDevTools();
                addSecurityLog('INFO', 'ë³´ì•ˆ ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ');
            } catch (securityError) {
                addSecurityLog('WARNING', `ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: ${securityError.message}`);
            }
            
            // ì„¸ì…˜ ë³µì› ì‹œë„
            showLoadingScreen('ì„¸ì…˜ í™•ì¸ ì¤‘...');
            try {
                const sessionRestored = await restoreSession();
                if (sessionRestored) {
                    addSecurityLog('INFO', 'ì„¸ì…˜ ë³µì› ì„±ê³µ - ìë™ ë¡œê·¸ì¸');
                    hideLoadingScreen();
                    return; // ì„¸ì…˜ ë³µì› ì„±ê³µì‹œ ì—¬ê¸°ì„œ ì¢…ë£Œ
                } else {
                    addSecurityLog('INFO', 'ë³µì›í•  ì„¸ì…˜ ì—†ìŒ - ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ');
                }
            } catch (sessionError) {
                addSecurityLog('ERROR', `ì„¸ì…˜ ë³µì› ì¤‘ ì˜¤ë¥˜: ${sessionError.message}`);
            }
            
            // ì„¸ì…˜ ë³µì› ì‹¤íŒ¨ì‹œ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
            hideLoadingScreen();
            showLoginScreen();
            
            // í¬ì»¤ìŠ¤ ì„¤ì •
            const usernameInput = document.getElementById('adminUsername');
            if (usernameInput) {
                usernameInput.focus();
            }
            
            // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('adminUsername').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('adminPassword').focus();
                }
            });
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticateAdmin();
                }
            });
            
            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—”í„°í‚¤ ì´ë²¤íŠ¸
            document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changePassword();
                }
            });
            
            // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ì‹¤ì‹œê°„ ì¤‘ë³µ ì²´í¬
            const phoneInput = document.getElementById('newUserPhone');
            phoneInput.addEventListener('input', handlePhoneInput);
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newUserName').focus();
                }
            });
            
            // ì „í™”ë²ˆí˜¸ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ê°€ë©´ ì˜¤ë¥˜ ìŠ¤íƒ€ì¼ ì œê±°
            phoneInput.addEventListener('focus', function() {
                this.classList.remove('duplicate');
                document.getElementById('addUserMessage').innerHTML = '';
            });
            
            // ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ í›„ ì—”í„°í‚¤ë¡œ ì¶”ì²œì¸ í•„ë“œë¡œ ì´ë™
            document.getElementById('newUserName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newUserReferrer').focus();
                }
            });
            
            // ì¶”ì²œì¸ ì…ë ¥ í›„ ì—”í„°í‚¤ë¡œ ì¶”ê°€
            document.getElementById('newUserReferrer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addUser();
                }
            });
            
            // ê¸°ê¸° ê²€ìƒ‰ ì—”í„°í‚¤ ì´ë²¤íŠ¸
            const deviceSearchInput = document.getElementById('deviceSearchInput');
            if (deviceSearchInput) {
                deviceSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchDevices();
                    }
                });
            }
            
            // ì§€ì—­ ê²€ìƒ‰ ì—”í„°í‚¤ ì´ë²¤íŠ¸
            const regionSearchInput = document.getElementById('regionSearchInput');
            if (regionSearchInput) {
                regionSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchRegions();
                    }
                });
            }
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('editPermissionsModal');
                if (event.target === modal) {
                    closePermissionsModal();
                }
            });
            
            // í™œë™ ê°ì§€ ì´ë²¤íŠ¸ ìµœì í™” (Firebase ì—…ë°ì´íŠ¸ ì™„ì „ ì œê±°)
            let activityTimer;
            function resetActivityTimer() {
                clearTimeout(activityTimer);
                // ë¡œì»¬ ì‹œê°„ë§Œ ì—…ë°ì´íŠ¸ (Firebase í˜¸ì¶œ ì œê±°)
                if (currentUser) {
                    document.getElementById('lastActivity').textContent = new Date().toLocaleString('ko-KR');
                }
                // 30ë¶„ ë¹„í™œì„±ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ
                activityTimer = setTimeout(() => {
                    if (currentUser) {
                        addSecurityLog('WARNING', 'ë¹„í™œì„±ìœ¼ë¡œ ì¸í•œ ìë™ ë¡œê·¸ì•„ì›ƒ');
                        alert('30ë¶„ê°„ ë¹„í™œì„± ìƒíƒœë¡œ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.');
                        logout();
                    }
                }, 30 * 60 * 1000);
            }
            
            // í™œë™ ê°ì§€ ì´ë²¤íŠ¸ ìµœì†Œí™”
            ['keypress', 'click'].forEach(event => {
                document.addEventListener(event, resetActivityTimer, true);
            });
            
            addSecurityLog('INFO', 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
            
            // Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ ë° ì²˜ë¦¬ (ê°•í™”ëœ ë²„ì „)
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && 
                    (event.reason.code === 'resource-exhausted' || 
                     event.reason.message?.includes('Quota exceeded') ||
                     event.reason.message?.includes('quota'))) {
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ - ì „ì—­ ì²˜ë¦¬');
                    showQuotaExceededMessage();
                    event.preventDefault();
                }
            });
            
            // Firebase ì—ëŸ¬ ì „ì—­ ê°ì§€
            window.addEventListener('error', function(event) {
                const errorMessage = event.error?.message || event.message || '';
                if (errorMessage.includes('resource-exhausted') || 
                    errorMessage.includes('Quota exceeded')) {
                    addSecurityLog('ERROR', 'Firebase í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€ - ì—ëŸ¬ ì´ë²¤íŠ¸');
                    showQuotaExceededMessage();
                }
            });
            
            // ì§€ì—­ ì •ë³´ ì¦‰ì‹œ ì´ˆê¸°í™” (Firebase ì—†ì´ ê³ ì • ë°ì´í„° ì‚¬ìš©)
            updateRegionCheckboxes();
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                addSecurityLog('INFO', `ê´€ë¦¬ì ì„¸ì…˜ ì¢…ë£Œ: ${currentUser.username}`);
            }
            // ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ ì •ë¦¬
            stopSessionMonitoring();
        });
    </script>
</body>
</html>