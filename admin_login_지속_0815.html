<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지인찾기 관리자 대시보드</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            user-select: none;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .security-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }
        .header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 3em;
            font-weight: bold;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .admin-auth {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 100px auto;
        }
        .dashboard {
            display: none;
        }
        /* 로딩 화면 스타일 */
        .loading-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        /* 세션 정보 표시 스타일 */
        .session-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        /* 탭 메뉴 스타일 */
        .tab-menu {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
            overflow-x: auto;
        }
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            min-width: 140px;
        }
        .tab-button:first-child {
            border-radius: 20px 0 0 0;
        }
        .tab-button:last-child {
            border-radius: 0 20px 0 0;
        }
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            box-shadow: 0 -2px 10px rgba(102, 126, 234, 0.1);
        }
        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 500px;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .admin-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            margin-bottom: 25px;
        }
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 10px 15px;
            font-size: 12px;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .btn-edit {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .error-message {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #feb2b2;
        }
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }
        .form-input {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            margin: 10px;
            flex: 1;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-input.duplicate {
            border-color: #e53e3e;
            background-color: #fed7d7;
            animation: shake 0.5s ease-in-out;
        }
        .form-input.valid {
            border-color: #38a169 !important;
            background-color: #f0fff4 !important;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        .user-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        .user-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .user-form-row.basic-info {
            flex-wrap: wrap;
        }
        .user-form-row.basic-info > * {
            flex: 1;
            min-width: 200px;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* 지역 권한 선택 스타일 */
        .region-permissions {
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 10px;
        }
        .region-permissions h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .region-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .region-checkbox:hover {
            background-color: #f1f3f4;
        }
        .region-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        .region-checkbox label {
            cursor: pointer;
            font-size: 14px;
            color: #2d3748;
            user-select: none;
        }
        .region-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .region-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            color: #667eea;
        }
        .region-controls button:hover {
            background: #667eea;
            color: white;
        }
        /* 사용자 정보에서 권한 표시 */
        .user-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .permission-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .permission-tag.all-regions {
            background: #28a745;
        }
        .permission-tag.limited {
            background: #ffc107;
            color: #333;
        }
        /* 권한 편집 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        /* 기기 관리 관련 스타일 */
        .device-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .device-item.pending {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }
        .device-item.approved {
            border-left: 4px solid #28a745;
        }
        .device-item.rejected {
            border-left: 4px solid #dc3545;
            background: #fdf2f2;
        }
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .device-field {
            display: flex;
            flex-direction: column;
        }
        .device-field label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .device-field span {
            font-size: 14px;
            color: #2d3748;
        }
        .device-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        /* 보안 로그 스타일 */
        .security-log {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            border-left: 3px solid;
        }
        .log-entry.info {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #1565c0;
        }
        .log-entry.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #e65100;
        }
        .log-entry.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .log-filter {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .log-stats {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        /* 체크박스 스타일 */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        .remember-me input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .tab-menu {
                flex-wrap: wrap;
            }
            .tab-button {
                min-width: 120px;
                font-size: 12px;
                padding: 12px 15px;
            }
            .device-info {
                grid-template-columns: 1fr;
            }
            .user-form-row {
                flex-direction: column;
            }
            .user-actions {
                flex-direction: column;
                gap: 5px;
            }
            .region-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로딩 화면 -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">세션 확인 중...</div>
        </div>

        <!-- 보안 헤더 -->
        <div class="security-header">
            <h2>🔒 보안 관리 시스템</h2>
            <div>이 시스템은 승인된 관리자만 접근 가능합니다. 모든 활동이 기록됩니다.</div>
        </div>

        <!-- 관리자 인증 화면 -->
        <div id="adminAuth" class="admin-auth">
            <h2>🔐 관리자 인증</h2>
            <p style="margin: 20px 0; color: #666;">관리자 자격증명을 입력해주세요</p>
            <input type="text" id="adminUsername" class="admin-input" placeholder="관리자 아이디">
            <input type="password" id="adminPassword" class="admin-input" placeholder="관리자 비밀번호">
            
            <!-- 로그인 상태 유지 체크박스 -->
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">로그인 상태 유지 (24시간)</label>
            </div>
            
            <button onclick="authenticateAdmin()" class="btn btn-primary" style="width: 100%;">
                🚀 로그인
            </button>
            <div id="authMessage"></div>
        </div>

        <!-- 대시보드 메인 화면 -->
        <div id="dashboard" class="dashboard">
            <!-- 헤더 -->
            <div class="header">
                <button onclick="logout()" class="logout-btn">🚪 로그아웃</button>
                <!-- 세션 정보 표시 -->
                <div class="session-info" id="sessionInfo" style="display: none;">
                    <div style="font-size: 10px; opacity: 0.8;">세션 유효</div>
                    <div id="sessionExpiry" style="font-size: 11px;"></div>
                </div>
                <h1>🛡️ 지인찾기 관리자 대시보드</h1>
                <p>사용자 권한 관리 및 시스템 모니터링을 실시간으로 확인할 수 있습니다</p>
            </div>

            <!-- 탭 메뉴 -->
            <div class="tab-menu">
                <button class="tab-button active" onclick="switchTab('dashboard')">📊 대시보드</button>
                <button class="tab-button" onclick="switchTab('users')">👥 사용자 관리</button>
                <button class="tab-button" onclick="switchTab('devices')">📱 기기 관리</button>
                <button class="tab-button" onclick="switchTab('referrers')">🎯 추천인 통계</button>
                <button class="tab-button" onclick="switchTab('regions')">🗺️ 지역 관리</button>
                <button class="tab-button" onclick="switchTab('settings')">⚙️ 설정</button>
                <button class="tab-button" onclick="switchTab('security')">🛡️ 보안 로그</button>
            </div>

            <!-- 탭 내용 -->
            <div class="tab-content">
                <!-- 대시보드 탭 -->
                <div id="dashboard-tab" class="tab-panel active">
                    <h3>📊 시스템 현황</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                        <!-- 기본 통계 -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="totalUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">이 사용자</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #17a2b8;" id="activeUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">활성 사용자</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #fd7e14;" id="pendingDevices">-</div>
                            <div style="color: #666; margin-top: 5px;">기기 요청 대기</div>
                        </div>
                        <!-- 새로운 앱 사용 통계 -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalFoundContacts">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">이 찾은 지인</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalPhoneCalls">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">이 전화 횟수</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="totalSMS">-</div>
                            <div style="margin-top: 5px; opacity: 0.9;">이 문자 횟수</div>
                        </div>
                        <!-- 기타 통계 -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalRegions">-</div>
                            <div style="color: #666; margin-top: 5px;">등록된 지역</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="totalLogs">-</div>
                            <div style="color: #666; margin-top: 5px;">보안 로그</div>
                        </div>
                    </div>
                    <!-- 평균 통계 섹션 -->
                    <div style="background: #f1f3f4; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">📊 평균 사용 통계</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;" id="avgFoundContacts">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">사용자당 평균 지인</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #28a745;" id="avgPhoneCalls">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">사용자당 평균 전화</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #ff6b6b;" id="avgSMS">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">사용자당 평균 문자</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #ffc107;" id="avgUsage">-</div>
                                <div style="color: #666; font-size: 12px; margin-top: 4px;">사용자당 평균 이용</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: #f1f3f4; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4>📈 최근 활동</h4>
                        <div id="recentActivity" style="margin-top: 15px;">
                            <div>시스템 준비중...</div>
                        </div>
                    </div>
                </div>

                <!-- 사용자 관리 탭 -->
                <div id="users-tab" class="tab-panel">
                    <h3>👤 신규 사용자 등록</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        💡 <strong>팁:</strong> 전화번호는 자동으로 중복 체크됩니다. 지역 권한을 설정하면 해당 지역의 지인만 검색할 수 있습니다. 권한을 선택하지 않으면 모든 지역에 접근할 수 있습니다.
                        <br>📊 <strong>통계 안내:</strong> 앱에서 자동으로 수집되는 통계 - 찾은 지인 수, 전화 횟수, 문자 횟수, 앱 사용 횟수
                    </div>
                    <div class="user-form">
                        <!-- 기본 정보 입력 -->
                        <div class="user-form-row basic-info">
                            <div style="position: relative; flex: 1;">
                                <input type="tel" id="newUserPhone" class="form-input" 
                                       placeholder="전화번호 (010-1234-5678)" 
                                       autocomplete="tel"
                                       style="transition: border-color 0.3s, background-color 0.3s; margin: 0;">
                            </div>
                            <input type="text" id="newUserName" class="form-input" 
                                   placeholder="이름 (선택사항)" 
                                   autocomplete="name"
                                   style="margin: 0;">
                            <input type="text" id="newUserReferrer" class="form-input" 
                                   placeholder="추천인 (선택사항)" 
                                   autocomplete="off"
                                   style="margin: 0;">
                        </div>
                        <!-- 지역 권한 선택 -->
                        <div class="region-permissions">
                            <h4>🗺️ 지역 접근 권한 설정</h4>
                            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                                ℹ️ 선택한 지역의 지인만 검색할 수 있습니다. 아무것도 선택하지 않으면 모든 지역에 접근 가능합니다.
                            </div>
                            <div class="region-controls">
                                <button type="button" onclick="selectAllRegions()">전체 선택</button>
                                <button type="button" onclick="clearAllRegions()">전체 해제</button>
                            </div>
                            <div id="regionCheckboxes" class="region-grid">
                                <div style="text-align: center; color: #666; padding: 20px;">지역 정보를 불러오는 중...</div>
                            </div>
                        </div>
                        <!-- 추가 버튼 -->
                        <div class="user-form-row">
                            <button onclick="addUser()" class="btn btn-primary" style="width: 100%; padding: 15px;">
                                ➕ 사용자 추가
                            </button>
                        </div>
                    </div>
                    <div id="addUserMessage"></div>
                    <h3 style="margin-top: 30px;">👥 등록된 사용자 목록 (이 <span id="userCount">0</span>명)</h3>
                    <div id="userList" class="user-list">
                        <div>사용자 목록을 불러오는 중...</div>
                    </div>
                </div>

                <!-- 기기 관리 탭 -->
                <div id="devices-tab" class="tab-panel">
                    <h3>📱 기기 등록 관리</h3>
                    <!-- 기기 등록 요청 섹션 -->
                    <div style="margin-bottom: 40px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">📋 기기 등록 요청 (<span id="pendingRequestsCount">0</span>건)</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                            📋 <strong>안내:</strong> 사용자들이 새로운 기기에서 앱을 사용하려고 할 때 등록 요청이 생성됩니다. 각 사용자는 하나의 기기만 사용할 수 있습니다.
                        </div>
                        <div id="deviceRequests">
                            <div style="text-align: center; color: #666; padding: 20px;">기기 등록 요청을 불러오는 중...</div>
                        </div>
                    </div>
                    <!-- 등록된 기기 목록 섹션 -->
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">💻 등록된 기기 목록 (<span id="registeredDevicesCount">0</span>대)</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="deviceSearchInput" placeholder="전화번호 또는 기기명으로 검색..." 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="searchDevices()" class="btn btn-secondary">🔍 검색</button>
                            <button onclick="loadRegisteredDevices()" class="btn btn-secondary">🔄 새로고침</button>
                            <button onclick="forceRefreshAllCaches()" class="btn btn-warning">⚡ 캐시 무효화</button>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #856404;">
                            💡 <strong>기능 안내:</strong><br>
                            • <strong>🔄 기기 초기화</strong>: 사용자는 유지하고 기기 정보만 제거 (사용자가 새 기기 등록 가능)<br>
                            • <strong>❌ 비활성화</strong>: 사용자 계정 일시 중지
                        </div>
                        <div id="registeredDevices">
                            <div style="text-align: center; color: #666; padding: 20px;">등록된 기기 목록을 불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <!-- 추천인 통계 탭 -->
                <div id="referrers-tab" class="tab-panel">
                    <h3>🎯 추천인별 통계</h3>
                    <!-- 전체 추천 통계 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalReferrers">-</div>
                            <div style="color: #666; margin-top: 5px;">이 추천인 수</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="referredUsers">-</div>
                            <div style="color: #666; margin-top: 5px;">추천으로 가입한 사용자</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="selfRegistered">-</div>
                            <div style="color: #666; margin-top: 5px;">직접 가입한 사용자</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #17a2b8;" id="avgReferrals">-</div>
                            <div style="color: #666; margin-top: 5px;">추천인당 평균 추천수</div>
                        </div>
                    </div>
                    <!-- 추천인 목록 및 통계 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>🏆 추천인 순위</h4>
                            <div id="referrerRanking" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <div>통계를 계산하는 중...</div>
                            </div>
                        </div>
                        <div>
                            <h4>📋 추천된 사용자 목록</h4>
                            <div style="margin-bottom: 10px;">
                                <select id="referrerFilter" onchange="filterByReferrer()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">전체 추천인</option>
                                </select>
                            </div>
                            <div id="referredUsersList" style="max-height: 350px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <div>추천인을 선택해주세요.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 지역 관리 탭 -->
                <div id="regions-tab" class="tab-panel">
                    <h3>🗺️ 지역 관리</h3>
                    <!-- 지역별 통계 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="totalRegionsCount">-</div>
                            <div style="color: #666; margin-top: 5px;">전체 지역 수</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;" id="usersWithRegionLimits">-</div>
                            <div style="color: #666; margin-top: 5px;">지역 제한 사용자</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #ffc107;" id="usersWithoutLimits">-</div>
                            <div style="color: #666; margin-top: 5px;">무제한 접근 사용자</div>
                        </div>
                    </div>
                    <!-- 지역 목록 -->
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">📋 등록된 지역 목록</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="regionSearchInput" placeholder="지역명으로 검색..." 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="searchRegions()" class="btn btn-secondary">🔍 검색</button>
                        </div>
                        <div id="regionsList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #666; padding: 20px;">지역 목록을 불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <!-- 설정 탭 -->
                <div id="settings-tab" class="tab-panel">
                    <h3>⚙️ 관리자 설정</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div style="margin-top: 40px;">
                            <h4>📅 앱 만료일 설정</h4>
                            <input type="date" id="expiryDateInput" class="form-input" style="max-width: 300px;">
                            <button onclick="saveExpiryDate()" class="btn btn-primary" style="margin-left: 10px;">💾 저장</button>
                            <div id="expiryDateMessage" style="margin-top: 10px; font-size: 14px;"></div>
                        </div>
                        <div>
                            <h4>🔑 비밀번호 변경</h4>
                            <input type="password" id="currentPassword" class="form-input" placeholder="현재 비밀번호" style="margin: 5px 0;">
                            <input type="password" id="newPassword" class="form-input" placeholder="새 비밀번호" style="margin: 5px 0;">
                            <input type="password" id="confirmPassword" class="form-input" placeholder="새 비밀번호 확인" style="margin: 5px 0;">
                            <button onclick="changePassword()" class="btn btn-primary" style="width: 100%;">🔑 비밀번호 변경</button>
                        </div>
                        <div>
                            <h4>📋 현재 로그인 정보</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 14px;">
                                <div><strong>계정:</strong> <span id="currentAdminInfo">-</span></div>
                                <div><strong>로그인 시간:</strong> <span id="loginTime">-</span></div>
                                <div><strong>마지막 활동:</strong> <span id="lastActivity">-</span></div>
                                <div><strong>권한:</strong> <span id="userRole">-</span></div>
                                <div><strong>세션 상태:</strong> <span id="sessionStatus">-</span></div>
                            </div>
                            <!-- 세션 관리 버튼들 -->
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button onclick="clearStoredSession()" class="btn btn-warning" style="flex: 1;">
                                    🗑️ 저장된 세션 삭제
                                </button>
                                <button onclick="extendSession()" class="btn btn-success" style="flex: 1;">
                                    ⏰ 세션 연장
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="adminSettingsMessage"></div>
                </div>

                <!-- 보안 로그 탭 -->
                <div id="security-tab" class="tab-panel">
                    <h3>🛡️ 보안 로그</h3>
                    <!-- 로그 통계 -->
                    <div class="log-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalLogCount">0</div>
                            <div class="stat-label">전체 로그</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="errorLogCount">0</div>
                            <div class="stat-label">오류</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="warningLogCount">0</div>
                            <div class="stat-label">경고</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="infoLogCount">0</div>
                            <div class="stat-label">정보</div>
                        </div>
                    </div>
                    <!-- 로그 컨트롤 -->
                    <div class="log-controls">
                        <select id="logFilter" class="log-filter" onchange="filterLogs()">
                            <option value="all">전체 로그</option>
                            <option value="ERROR">오류만</option>
                            <option value="WARNING">경고만</option>
                            <option value="INFO">정보만</option>
                        </select>
                        <button onclick="refreshLogs()" class="btn btn-secondary">🔄 새로고침</button>
                        <button onclick="clearLogs()" class="btn btn-danger">🗑️ 로그 지우기</button>
                        <button onclick="exportLogs()" class="btn btn-primary">📥 내보내기</button>
                    </div>
                    <!-- 로그 표시 영역 -->
                    <div class="security-log" id="securityLogDisplay">
                        <div>로그를 불러오는 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 권한 편집 모달 -->
    <div id="editPermissionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🗺️ 사용자 권한 편집</h3>
                <span class="close" onclick="closePermissionsModal()">&times;</span>
            </div>
            <div id="modalUserInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- 사용자 정보가 여기에 표시됩니다 -->
            </div>
            <div class="region-permissions">
                <h4>🗺️ 지역 접근 권한 설정</h4>
                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                    ℹ️ 선택한 지역의 지인만 검색할 수 있습니다. 아무것도 선택하지 않으면 모든 지역에 접근 가능합니다.
                </div>
                <div class="region-controls">
                    <button type="button" onclick="selectAllRegionsModal()">전체 선택</button>
                    <button type="button" onclick="clearAllRegionsModal()">전체 해제</button>
                </div>
                <div id="modalRegionCheckboxes" class="region-grid">
                    <!-- 지역 체크박스가 여기에 표시됩니다 -->
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closePermissionsModal()" class="btn btn-secondary">취소</button>
                <button onclick="saveUserPermissions()" class="btn btn-primary">✅ 권한 저장</button>
            </div>
            <div id="modalMessage"></div>
        </div>
    </div>

    <script>
        // ========================================
        // 1. 전역 변수 선언 (세션 관리 추가)
        // ========================================
        let currentUser = null;
        let loginAttempts = 0;
        let allUsers = [];
        let securityLogs = [];
        let deviceRequests = [];
        let registeredDevices = [];
        let currentEditingUserId = null;
        let db = null;
        let currentTab = 'dashboard';
        
        // 캐싱 관련 변수들
        let usersCache = { data: [], timestamp: 0, loaded: false };
        let devicesCache = { data: [], timestamp: 0, loaded: false };
        let regionsCache = { data: [], timestamp: 0, loaded: false };
        const CACHE_DURATION = 15 * 60 * 1000; // 15분 캐시
        
        // Firebase 호출 제한
        let lastFirebaseCall = 0;
        const MIN_FIREBASE_INTERVAL = 2000; // 최소 2초 간격
        let pendingFirebaseCalls = 0;
        const MAX_CONCURRENT_CALLS = 3;
        
        // 관리자 계정 정보
        let adminUsers = [];
        
        // 세션 관리 관련 변수들
        const SESSION_KEY = 'admin_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24시간
        let sessionCheckInterval = null;
        let sessionExpiry = null;

        // ========================================
        // 2. 세션 관리 함수들
        // ========================================
        
        // 세션 정보 암호화하여 저장
        function saveSession(user, rememberMe = false) {
            if (!rememberMe) return;
            
            try {
                const sessionData = {
                    id: user.id,
                    username: user.username,
                    role: user.role,
                    isLocal: user.isLocal,
                    loginTime: Date.now(),
                    expiry: Date.now() + SESSION_DURATION
                };
                
                // 암호화하여 저장
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(sessionData), 'SecureAdminSession2024!@#').toString();
                localStorage.setItem(SESSION_KEY, encrypted);
                
                sessionExpiry = sessionData.expiry;
                updateSessionDisplay();
                startSessionMonitoring();
                
                addSecurityLog('INFO', `세션 저장됨: ${user.username} (만료: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`);
            } catch (error) {
                addSecurityLog('ERROR', `세션 저장 실패: ${error.message}`);
            }
        }
        
        // 저장된 세션 로드
        function loadSession() {
            try {
                const encrypted = localStorage.getItem(SESSION_KEY);
                if (!encrypted) return null;
                
                // 복호화
                const decrypted = CryptoJS.AES.decrypt(encrypted, 'SecureAdminSession2024!@#').toString(CryptoJS.enc.Utf8);
                if (!decrypted) return null;
                
                const sessionData = JSON.parse(decrypted);
                
                // 세션 만료 체크
                if (Date.now() > sessionData.expiry) {
                    clearStoredSession();
                    addSecurityLog('WARNING', '만료된 세션 감지됨 - 자동 삭제');
                    return null;
                }
                
                sessionExpiry = sessionData.expiry;
                return sessionData;
            } catch (error) {
                addSecurityLog('ERROR', `세션 로드 실패: ${error.message}`);
                clearStoredSession();
                return null;
            }
        }
        
        // 세션 자동 복원
        async function restoreSession() {
            const sessionData = loadSession();
            if (!sessionData) return false;
            
            try {
                addSecurityLog('INFO', `세션 복원 시도: ${sessionData.username}`);
                
                // 로컬 관리자 계정 확인
                const localAdmin = adminUsers.find(admin => 
                    admin.id === sessionData.id && 
                    admin.username === sessionData.username && 
                    admin.isActive
                );
                
                if (localAdmin) {
                    currentUser = localAdmin;
                    addSecurityLog('INFO', `세션 복원 성공: ${sessionData.username} (로컬 계정)`);
                    
                    // UI 전환
                    showDashboard();
                    updateSessionDisplay();
                    startSessionMonitoring();
                    
                    // 기본 데이터 로드
                    setTimeout(() => {
                        loadUsers().catch(error => {
                            addSecurityLog('WARNING', `초기 데이터 로드 실패: ${error.message}`);
                        });
                    }, 1000);
                    
                    return true;
                }
                
                // 원격 계정 확인 (Firebase 사용 가능한 경우)
                if (db && !sessionData.isLocal) {
                    try {
                        const userDoc = await db.collection('admin_users').doc(sessionData.id).get();
                        if (userDoc.exists && userDoc.data().isActive) {
                            currentUser = { id: userDoc.id, ...userDoc.data() };
                            addSecurityLog('INFO', `세션 복원 성공: ${sessionData.username} (원격 계정)`);
                            
                            showDashboard();
                            updateSessionDisplay();
                            startSessionMonitoring();
                            
                            setTimeout(() => {
                                loadUsers().catch(error => {
                                    addSecurityLog('WARNING', `초기 데이터 로드 실패: ${error.message}`);
                                });
                            }, 1000);
                            
                            return true;
                        }
                    } catch (error) {
                        addSecurityLog('WARNING', `원격 세션 복원 실패: ${error.message}`);
                    }
                }
                
                // 세션 복원 실패
                clearStoredSession();
                addSecurityLog('WARNING', `세션 복원 실패: 유효하지 않은 계정 - ${sessionData.username}`);
                return false;
                
            } catch (error) {
                addSecurityLog('ERROR', `세션 복원 중 오류: ${error.message}`);
                clearStoredSession();
                return false;
            }
        }
        
        // 저장된 세션 삭제
        function clearStoredSession() {
            try {
                localStorage.removeItem(SESSION_KEY);
                sessionExpiry = null;
                updateSessionDisplay();
                stopSessionMonitoring();
                addSecurityLog('INFO', '저장된 세션이 삭제되었습니다');
                
                // 메시지 표시 (설정 탭에서 수동 삭제한 경우)
                if (currentTab === 'settings') {
                    showMessage(document.getElementById('adminSettingsMessage'), 
                              '✅ 저장된 세션이 삭제되었습니다.', 'success');
                }
            } catch (error) {
                addSecurityLog('ERROR', `세션 삭제 실패: ${error.message}`);
            }
        }
        
        // 세션 연장
        function extendSession() {
            try {
                const encrypted = localStorage.getItem(SESSION_KEY);
                if (!encrypted) {
                    showMessage(document.getElementById('adminSettingsMessage'), 
                              '❌ 저장된 세션이 없습니다.', 'error');
                    return;
                }
                
                const decrypted = CryptoJS.AES.decrypt(encrypted, 'SecureAdminSession2024!@#').toString(CryptoJS.enc.Utf8);
                const sessionData = JSON.parse(decrypted);
                
                // 세션 만료 시간 연장
                sessionData.expiry = Date.now() + SESSION_DURATION;
                sessionExpiry = sessionData.expiry;
                
                // 다시 암호화하여 저장
                const newEncrypted = CryptoJS.AES.encrypt(JSON.stringify(sessionData), 'SecureAdminSession2024!@#').toString();
                localStorage.setItem(SESSION_KEY, newEncrypted);
                
                updateSessionDisplay();
                addSecurityLog('INFO', `세션 연장: ${sessionData.username} (새 만료: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`);
                
                showMessage(document.getElementById('adminSettingsMessage'), 
                          `✅ 세션이 24시간 연장되었습니다. (만료: ${new Date(sessionData.expiry).toLocaleString('ko-KR')})`, 'success');
            } catch (error) {
                addSecurityLog('ERROR', `세션 연장 실패: ${error.message}`);
                showMessage(document.getElementById('adminSettingsMessage'), 
                          '❌ 세션 연장에 실패했습니다.', 'error');
            }
        }
        
        // 세션 정보 UI 업데이트
        function updateSessionDisplay() {
            const sessionInfo = document.getElementById('sessionInfo');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionExpiryEl = document.getElementById('sessionExpiry');
            
            if (sessionExpiry && currentUser) {
                const timeLeft = sessionExpiry - Date.now();
                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / (60 * 60 * 1000));
                    const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                    
                    sessionInfo.style.display = 'block';
                    sessionExpiryEl.textContent = `${hours}시간 ${minutes}분 남음`;
                    
                    if (sessionStatus) {
                        sessionStatus.textContent = `자동 로그인 활성 (${hours}시간 ${minutes}분 남음)`;
                    }
                } else {
                    sessionInfo.style.display = 'none';
                    if (sessionStatus) {
                        sessionStatus.textContent = '세션 만료됨';
                    }
                }
            } else {
                sessionInfo.style.display = 'none';
                if (sessionStatus) {
                    sessionStatus.textContent = '세션 없음';
                }
            }
        }
        
        // 세션 모니터링 시작
        function startSessionMonitoring() {
            stopSessionMonitoring(); // 기존 모니터링 중지
            
            sessionCheckInterval = setInterval(() => {
                if (sessionExpiry && Date.now() > sessionExpiry) {
                    addSecurityLog('WARNING', '세션 만료로 인한 자동 로그아웃');
                    alert('세션이 만료되어 자동으로 로그아웃됩니다.');
                    logout();
                } else {
                    updateSessionDisplay();
                }
            }, 60000); // 1분마다 체크
        }
        
        // 세션 모니터링 중지
        function stopSessionMonitoring() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
                sessionCheckInterval = null;
            }
        }

        // ========================================
        // 3. Firebase 설정
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBlm_IxqmV4Kfr5eklto0lME2QDpTbXdB0",
            authDomain: "contacts-wonju.firebaseapp.com",
            projectId: "contacts-wonju",
            storageBucket: "contacts-wonju.firebasestorage.app",
            messagingSenderId: "866369356970",
            appId: "1:866369356970:web:75c30d24b7e089363e7cd3",
            measurementId: "G-LPE3WHDTZV"
        };

        // ========================================
        // 4. 지역 관리 함수들
        // ========================================
        let availableRegions = ['귀래면', '단계동', '무실동', '문막읍', '부론면', '우산동', '원인동', '일산동', '지정면', '중앙동', '태장1동', '태장2동', '학성동', '호저면'];
        console.log("Regions loaded from a predefined list.");

        // 지역 체크박스 업데이트
        function updateRegionCheckboxes() {
            const container = document.getElementById('regionCheckboxes');
            let html = '';
            availableRegions.forEach(region => {
                const checkboxId = `region_${region.replace(/[^a-zA-Z0-9]/g, '_')}`;
                html += `
                    <div class="region-checkbox">
                        <input type="checkbox" id="${checkboxId}" value="${region}">
                        <label for="${checkboxId}">${region}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 모달의 지역 체크박스 업데이트
        function updateModalRegionCheckboxes(userRegions = []) {
            const container = document.getElementById('modalRegionCheckboxes');
            if (availableRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">등록된 지역이 없습니다.</div>';
                return;
            }
            let html = '';
            availableRegions.forEach(region => {
                const checkboxId = `modal_region_${region.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const isChecked = userRegions.includes(region) ? 'checked' : '';
                html += `
                    <div class="region-checkbox">
                        <input type="checkbox" id="${checkboxId}" value="${region}" ${isChecked}>
                        <label for="${checkboxId}">${region}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 모든 지역 선택
        function selectAllRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        // 모든 지역 해제
        function clearAllRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // 모달에서 모든 지역 선택
        function selectAllRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        // 모달에서 모든 지역 해제
        function clearAllRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // 선택된 지역 가져오기
        function getSelectedRegions() {
            const checkboxes = document.querySelectorAll('#regionCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 모달에서 선택된 지역 가져오기
        function getSelectedRegionsModal() {
            const checkboxes = document.querySelectorAll('#modalRegionCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 지역 목록 표시
        function displayRegionsList() {
            const container = document.getElementById('regionsList');
            if (availableRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">등록된 지역이 없습니다.</div>';
                return;
            }
            let html = '';
            availableRegions.forEach((region, index) => {
                // 해당 지역에 권한이 있는 사용자 수 계산
                const usersWithThisRegion = allUsers.filter(user => 
                    user.regions && user.regions.includes(region)
                ).length;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${region}</div>
                            <small style="color: #718096;">권한 보유 사용자: ${usersWithThisRegion}명</small>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editRegion('${region}')" class="btn btn-edit">✏️ 편집</button>
                            <button onclick="deleteRegion('${region}')" class="btn btn-danger">🗑️ 삭제</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 지역 편집 (이름 변경)
        function editRegion(oldRegionName) {
            const newRegionName = prompt(`지역명을 수정하세요:`, oldRegionName);
            if (!newRegionName || newRegionName.trim() === '') {
                return;
            }
            const trimmedName = newRegionName.trim();
            if (trimmedName === oldRegionName) {
                return; // 변경사항 없음
            }
            if (availableRegions.includes(trimmedName)) {
                alert('이미 존재하는 지역명입니다.');
                return;
            }
            // 지역명 업데이트
            const index = availableRegions.indexOf(oldRegionName);
            if (index !== -1) {
                availableRegions[index] = trimmedName;
                availableRegions.sort();
                // 사용자들의 권한도 업데이트 (실제 구현시에는 Firebase 업데이트 필요)
                allUsers.forEach(user => {
                    if (user.regions && user.regions.includes(oldRegionName)) {
                        const regionIndex = user.regions.indexOf(oldRegionName);
                        if (regionIndex !== -1) {
                            user.regions[regionIndex] = trimmedName;
                        }
                    }
                });
                // UI 업데이트
                updateRegionCheckboxes();
                displayRegionsList();
                displayUsers(allUsers);
                addSecurityLog('INFO', `지역명 변경: ${oldRegionName} → ${trimmedName}`);
            }
        }

        // 지역 삭제
        function deleteRegion(regionName) {
            const usersWithThisRegion = allUsers.filter(user => 
                user.regions && user.regions.includes(regionName)
            ).length;
            if (usersWithThisRegion > 0) {
                if (!confirm(`"${regionName}" 지역에 권한을 가진 사용자가 ${usersWithThisRegion}명 있습니다.\n정말로 삭제하시겠습니까?\n\n※ 해당 사용자들의 권한에서 이 지역이 제거됩니다.`)) {
                    return;
                }
            } else {
                if (!confirm(`"${regionName}" 지역을 삭제하시겠습니까?`)) {
                    return;
                }
            }
            // 지역 제거
            const index = availableRegions.indexOf(regionName);
            if (index !== -1) {
                availableRegions.splice(index, 1);
                // 사용자들의 권한에서도 제거 (실제 구현시에는 Firebase 업데이트 필요)
                allUsers.forEach(user => {
                    if (user.regions && user.regions.includes(regionName)) {
                        user.regions = user.regions.filter(region => region !== regionName);
                    }
                });
                // UI 업데이트
                updateRegionCheckboxes();
                displayRegionsList();
                displayUsers(allUsers);
                updateRegionStats();
                addSecurityLog('WARNING', `지역 삭제: ${regionName} (영향받은 사용자: ${usersWithThisRegion}명)`);
            }
        }

        // 지역 검색
        function searchRegions() {
            const searchTerm = document.getElementById('regionSearchInput').value.trim().toLowerCase();
            const container = document.getElementById('regionsList');
            if (!searchTerm) {
                displayRegionsList();
                return;
            }
            const filteredRegions = availableRegions.filter(region => 
                region.toLowerCase().includes(searchTerm)
            );
            if (filteredRegions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">검색 결과가 없습니다.</div>';
                return;
            }
            let html = '';
            filteredRegions.forEach(region => {
                const usersWithThisRegion = allUsers.filter(user => 
                    user.regions && user.regions.includes(region)
                ).length;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${region}</div>
                            <small style="color: #718096;">권한 보유 사용자: ${usersWithThisRegion}명</small>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editRegion('${region}')" class="btn btn-edit">✏️ 편집</button>
                            <button onclick="deleteRegion('${region}')" class="btn btn-danger">🗑️ 삭제</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 지역 통계 업데이트
        function updateRegionStats() {
            const totalRegions = availableRegions.length;
            const usersWithLimits = allUsers.filter(user => user.regions && user.regions.length > 0).length;
            const usersWithoutLimits = allUsers.length - usersWithLimits;
            document.getElementById('totalRegionsCount').textContent = totalRegions;
            document.getElementById('usersWithRegionLimits').textContent = usersWithLimits;
            document.getElementById('usersWithoutLimits').textContent = usersWithoutLimits;
            document.getElementById('totalRegions').textContent = totalRegions; // 대시보드용
        }

        // ========================================
        // 5. 권한 편집 모달 관련 함수들
        // ========================================
        
        // 권한 편집 모달 열기
        function openPermissionsModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                alert('사용자를 찾을 수 없습니다.');
                return;
            }
            currentEditingUserId = userId;
            const formattedPhone = formatPhoneNumber(user.phoneNumber);
            // 사용자 정보 표시
            document.getElementById('modalUserInfo').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; font-size: 16px; color: #2d3748;">
                            ${formattedPhone} (${user.name || '이름 없음'})
                        </div>
                        <div style="font-size: 14px; color: #718096; margin-top: 4px;">
                            현재 권한: ${getUserPermissionText(user)}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        사용횟수: ${user.usageCount || 0}회<br>
                        상태: ${user.isActive ? '✅ 활성' : '❌ 비활성'}
                    </div>
                </div>
            `;
            // 지역 체크박스 업데이트
            updateModalRegionCheckboxes(user.regions || []);
            // 모달 표시
            document.getElementById('editPermissionsModal').style.display = 'block';
            document.getElementById('modalMessage').innerHTML = '';
            addSecurityLog('INFO', `권한 편집 모달 열림: ${formattedPhone}`);
        }

        // 권한 편집 모달 닫기
        function closePermissionsModal() {
            document.getElementById('editPermissionsModal').style.display = 'none';
            currentEditingUserId = null;
        }

        // 사용자 권한 저장 (Firebase 호출 제한)
        async function saveUserPermissions() {
            if (!currentEditingUserId) {
                alert('편집 중인 사용자가 없습니다.');
                return;
            }
            const selectedRegions = getSelectedRegionsModal();
            const messageEl = document.getElementById('modalMessage');
            try {
                addSecurityLog('INFO', `사용자 권한 업데이트 시도: ${currentEditingUserId}`);
                // 로컬에서 먼저 업데이트
                const user = allUsers.find(u => u.id === currentEditingUserId);
                if (user) {
                    user.regions = selectedRegions.length > 0 ? selectedRegions : null;
                }
                // Firebase 업데이트 (제한 적용)
                const updateData = {
                    regions: selectedRegions.length > 0 ? selectedRegions : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.username
                };
                await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users').doc(currentEditingUserId).update(updateData);
                });
                showMessage(messageEl, '✅ 권한이 성공적으로 업데이트되었습니다.', 'success');
                addSecurityLog('INFO', `권한 업데이트 완료: ${formatPhoneNumber(user?.phoneNumber)} (지역: ${selectedRegions.length > 0 ? selectedRegions.join(', ') : '무제한'})`);
                // UI 새로고침
                displayUsers(allUsers);
                updateRegionStats();
                // 2초 후 모달 닫기
                setTimeout(() => {
                    closePermissionsModal();
                }, 2000);
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    showMessage(messageEl, '✅ 권한이 로컬에서 업데이트되었습니다. (Firebase 저장은 할당량 초과로 실패)', 'success');
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 - 로컬 권한 변경만 적용');
                    // UI는 업데이트
                    displayUsers(allUsers);
                    updateRegionStats();
                    setTimeout(() => {
                        closePermissionsModal();
                    }, 3000);
                } else {
                    addSecurityLog('ERROR', `권한 업데이트 실패: ${error.message}`);
                    showMessage(messageEl, '❌ 권한 업데이트 중 오류가 발생했습니다.', 'error');
                }
            }
        }

        // 사용자 권한 텍스트 생성
        function getUserPermissionText(user) {
            if (!user.regions || user.regions.length === 0) {
                return '모든 지역 접근 가능';
            } else if (user.regions.length === 1) {
                return `${user.regions[0]} 지역만`;
            } else if (user.regions.length <= 3) {
                return `${user.regions.join(', ')} 지역`;
            } else {
                return `${user.regions.length}개 지역 (${user.regions.slice(0, 2).join(', ')} 외)`;
            }
        }

        // ========================================
        // 6. Firebase 관련 함수들 (극한 최적화)
        // ========================================

        // Firebase 호출 제한기 (할당량 초과시 영구 차단, 로그인 시 제한 완화)
        async function throttledFirebaseCall(operation, isLoginCall = false) {
            const now = Date.now();
            
            // 이미 할당량 초과가 감지된 경우 즉시 오프라인 모드
            const quotaExceeded = localStorage.getItem('firebase_quota_exceeded');
            if (quotaExceeded === 'true') {
                addSecurityLog('WARNING', 'Firebase 할당량 초과 상태 - 호출 차단');
                throw new Error('QUOTA_EXCEEDED');
            }
            
            // 동시 호출 수 제한
            if (pendingFirebaseCalls >= MAX_CONCURRENT_CALLS) {
                addSecurityLog('WARNING', 'Firebase 동시 호출 수 제한으로 대기');
                await new Promise(resolve => setTimeout(resolve, 1000));
                return throttledFirebaseCall(operation, isLoginCall);
            }
            
            // 로그인 호출의 경우 제한 완화 (500ms), 일반 호출은 기존 제한 (2000ms)
            const minInterval = isLoginCall ? 500 : MIN_FIREBASE_INTERVAL;
            
            // 최소 간격 제한
            const timeSinceLastCall = now - lastFirebaseCall;
            if (timeSinceLastCall < minInterval) {
                const waitTime = minInterval - timeSinceLastCall;
                addSecurityLog('INFO', `Firebase 호출 제한: ${waitTime}ms 대기 ${isLoginCall ? '(로그인)' : ''}`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            pendingFirebaseCalls++;
            lastFirebaseCall = Date.now();
            
            try {
                const result = await operation();
                return result;
            } catch (error) {
                // 할당량 초과 감지 강화
                if (error.code === 'resource-exhausted' || 
                    error.message?.includes('Quota exceeded') ||
                    error.message?.includes('quota')) {
                    
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 감지 - 영구 오프라인 모드 전환');
                    
                    // localStorage에 할당량 초과 플래그 저장 (다음 세션까지 유지)
                    localStorage.setItem('firebase_quota_exceeded', 'true');
                    localStorage.setItem('quota_exceeded_time', new Date().toISOString());
                    
                    // Firebase 연결 차단
                    db = null;
                    
                    // 즉시 오프라인 모드 전환
                    setTimeout(() => {
                        showQuotaExceededMessage();
                    }, 100);
                    
                    throw new Error('QUOTA_EXCEEDED');
                }
                throw error;
            } finally {
                pendingFirebaseCalls--;
            }
        }

        // 할당량 초과 상태 초기화 (관리자가 수동으로 호출)
        function resetQuotaStatus() {
            localStorage.removeItem('firebase_quota_exceeded');
            localStorage.removeItem('quota_exceeded_time');
            addSecurityLog('INFO', 'Firebase 할당량 상태 초기화 - 재연결 시도 가능');
            if (confirm('Firebase 할당량 상태가 초기화되었습니다. 페이지를 새로고침하시겠습니까?')) {
                window.location.reload();
            }
        }

        // 할당량 초과 메시지 표시 (관리 기능 포함)
        function showQuotaExceededMessage() {
            const existingBanner = document.getElementById('quotaExceededBanner');
            if (existingBanner) return; // 이미 표시 중
            const quotaTime = localStorage.getItem('quota_exceeded_time');
            const timeInfo = quotaTime ? new Date(quotaTime).toLocaleString('ko-KR') : '알 수 없음';
            const banner = document.createElement('div');
            banner.id = 'quotaExceededBanner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                padding: 20px;
                text-align: center;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                animation: slideDown 0.5s ease-out;
            `;
            banner.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="font-size: 18px; margin-bottom: 10px;">⚠️ Firebase 일일 할당량이 초과되었습니다</div>
                    <div style="font-size: 14px; margin-bottom: 15px; opacity: 0.9;">
                        🕐 발생 시간: ${timeInfo}<br>
                        🔄 완전 오프라인 모드로 작동 중입니다. 기존 데이터는 캐시에서 제공됩니다.<br>
                        📅 할당량은 내일 자정(UTC 기준)에 자동 초기화됩니다.
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="resetQuotaStatus()" style="background: #fbbf24; color: #92400e; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;" title="할당량 상태를 초기화하고 Firebase 재연결을 시도합니다">
                            🔄 상태 초기화
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;" title="이 메시지를 숨깁니다">
                            ✕ 닫기
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(banner);
            // 30초 후 자동 제거
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                }
            }, 30000);
        }

        // Firebase 초기화 (할당량 초과시 완전 비활성화)
        function initializeFirebase() {
            try {
                // 우선 할당량 초과 여부 확인
                const quotaExceeded = localStorage.getItem('firebase_quota_exceeded');
                if (quotaExceeded === 'true') {
                    addSecurityLog('WARNING', 'Firebase 할당량 초과 감지 - 완전 오프라인 모드');
                    return initializeOfflineMode();
                }
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                // 오프라인 지원은 조용히 활성화 (실패해도 계속 진행)
                try {
                    db.enablePersistence({ synchronizeTabs: true })
                        .then(() => {
                            addSecurityLog('INFO', 'Firebase 오프라인 지원 활성화');
                        })
                        .catch((err) => {
                            addSecurityLog('WARNING', `Firebase 오프라인 설정 실패: ${err.code}`);
                        });
                } catch (persistenceError) {
                    addSecurityLog('WARNING', `Firebase 오프라인 설정 오류: ${persistenceError.message}`);
                }
                addSecurityLog('INFO', 'Firebase 초기화 성공 (오프라인 지원 포함)');
                // 관리자 계정 초기화 (Firebase 호출 없음)
                initializeAdminAccounts();
                return true;
            } catch (error) {
                addSecurityLog('ERROR', `Firebase 초기화 실패: ${error.message}`);
                // Firebase 실패시 오프라인 모드로 전환
                return initializeOfflineMode();
            }
        }

        // 완전 오프라인 모드 초기화
        function initializeOfflineMode() {
            addSecurityLog('INFO', '완전 오프라인 모드로 초기화');
            // Firebase 완전 비활성화
            db = null;
            // 로컬 관리자 계정만 사용
            adminUsers = [{
                id: 'offline_admin',
                username: 'admin',
                password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                role: 'admin',
                permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                isActive: true,
                isLocal: true,
                isOffline: true
            }];
            addSecurityLog('INFO', '오프라인 관리자 계정 생성 완료');
            // 할당량 초과 표시
            setTimeout(() => {
                showQuotaExceededMessage();
            }, 2000);
            return false; // Firebase 사용 불가
        }

        // 관리자 계정 초기화 (Firebase 호출 완전 제거)
        async function initializeAdminAccounts() {
            try {
                // 로컬 관리자 계정만 생성 (Firebase 호출 완전 없음)
                adminUsers = [{
                    id: 'local_admin',
                    username: 'admin',
                    password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                    role: 'admin',
                    permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                    isActive: true,
                    isLocal: true
                }];
                addSecurityLog('INFO', '로컬 관리자 계정 생성 완료 (Firebase 호출 없음)');
                // Firebase 원격 계정 확인은 완전히 제거 (할당량 초과 방지)
                addSecurityLog('INFO', '완전 오프라인 모드 - Firebase 동기화 비활성화');
            } catch (error) {
                addSecurityLog('ERROR', `관리자 계정 초기화 실패: ${error.message}`);
            }
        }

        // ========================================
        // 7. 보안 기능들
        // ========================================
        
        // 개발자 도구 차단
        function blockDevTools() {
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || // F12
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                    (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
                    e.preventDefault();
                    addSecurityLog('WARNING', '개발자 도구 접근 시도 차단');
                    return false;
                }
            });
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                addSecurityLog('WARNING', '우클릭 메뉴 차단');
                return false;
            });
        }

        // ========================================
        // 8. 인증 관련 함수들 (세션 지속 기능 추가)
        // ========================================
        
        // 대시보드 표시/숨김 함수들
        function showDashboard() {
            document.getElementById('adminAuth').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateDashboardStats();
            loadUsers();
        }
        
        function showLoginScreen() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminUsername').focus();
        }

        // 로딩 화면 표시/숨김
        function showLoadingScreen(text = '로딩 중...') {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.querySelector('.loading-text');
            loadingText.textContent = text;
            loadingScreen.style.display = 'flex';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // 관리자 인증 (세션 저장 기능 포함)
        async function authenticateAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!username || !password) {
                showAuthMessage('아이디와 비밀번호를 입력해주세요.', 'error');
                return;
            }
            
            showLoadingScreen('인증 중...');
            
            try {
                addSecurityLog('INFO', `로그인 시도: ${username}`);
                
                // 1단계: 로컬 관리자 계정 우선 확인 (Firebase 호출 없음)
                const hashedPassword = CryptoJS.SHA256(password).toString();
                const localAdmin = adminUsers.find(admin => 
                    admin.username === username && 
                    admin.password === hashedPassword && 
                    admin.isActive
                );
                
                if (localAdmin) {
                    // 로컬 계정으로 로그인 성공
                    loginAttempts = 0;
                    currentUser = localAdmin;
                    addSecurityLog('INFO', `로컬 관리자 로그인 성공: ${username} (${localAdmin.role})`);
                    
                    // 세션 저장 (체크박스에 따라)
                    if (rememberMe) {
                        saveSession(localAdmin, true);
                    }
                    
                    // UI 전환
                    hideLoadingScreen();
                    showDashboard();
                    
                    // 입력 필드 초기화
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                    
                    // 관리자 정보 표시
                    updateAdminInfo();
                    
                    // 기본 사용자 목록 로드 시도 (실패해도 계속 진행)
                    try {
                        await loadUsers();
                    } catch (error) {
                        addSecurityLog('WARNING', 'Firebase 초기 로드 실패 - 로컬 데이터 사용');
                        allUsers = [];
                        updateDashboardStats();
                    }
                    return; // 로컬 로그인 성공시 여기서 종료
                }
                
                // 2단계: Firebase 원격 계정 확인 (선택적, 할당량 허용시에만)
                if (db) {
                    try {
                        addSecurityLog('INFO', `원격 관리자 계정 확인 시도: ${username}`);
                        // Firebase 호출 제한 적용
                        const snapshot = await throttledFirebaseCall(async () => {
                            return await db.collection('admin_users')
                                .where('username', '==', username)
                                .where('password', '==', hashedPassword)
                                .where('isActive', '==', true)
                                .limit(1)
                                .get();
                        }, true); // 로그인 호출임을 표시
                        
                        if (!snapshot.empty) {
                            const remoteAdmin = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            loginAttempts = 0;
                            currentUser = remoteAdmin;
                            
                            // 마지막 로그인 시간 업데이트 (선택적)
                            try {
                                await throttledFirebaseCall(async () => {
                                    return await db.collection('admin_users').doc(remoteAdmin.id).update({
                                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }, true);
                            } catch (updateError) {
                                addSecurityLog('WARNING', `로그인 시간 업데이트 실패: ${updateError.message}`);
                            }
                            
                            addSecurityLog('INFO', `원격 관리자 로그인 성공: ${username} (${remoteAdmin.role})`);
                            
                            // 세션 저장 (체크박스에 따라)
                            if (rememberMe) {
                                saveSession(remoteAdmin, true);
                            }
                            
                            // UI 전환
                            hideLoadingScreen();
                            showDashboard();
                            
                            // 입력 필드 초기화
                            document.getElementById('adminUsername').value = '';
                            document.getElementById('adminPassword').value = '';
                            updateAdminInfo();
                            
                            try {
                                await loadUsers();
                            } catch (error) {
                                addSecurityLog('WARNING', 'Firebase 초기 로드 실패 - 로컬 데이터 사용');
                                allUsers = [];
                                updateDashboardStats();
                            }
                            return; // 원격 로그인 성공시 여기서 종료
                        }
                    } catch (firebaseError) {
                        if (firebaseError.message === 'QUOTA_EXCEEDED') {
                            addSecurityLog('WARNING', 'Firebase 할당량 초과 - 로컬 계정만 사용');
                            showQuotaExceededMessage();
                        } else {
                            addSecurityLog('WARNING', `원격 인증 실패: ${firebaseError.message}`);
                        }
                        // Firebase 오류시에도 계속 진행하여 로그인 실패 처리
                    }
                }
                
                // 3단계: 로그인 실패 처리
                hideLoadingScreen();
                loginAttempts++;
                addSecurityLog('ERROR', `로그인 실패 (${loginAttempts}회): ${username}`);
                
                if (loginAttempts >= 3) {
                    showAuthMessage('너무 많은 로그인 실패로 인해 접근이 차단됩니다.', 'error');
                    setTimeout(() => {
                        window.location.href = 'about:blank';
                    }, 3000);
                } else {
                    showAuthMessage(`잘못된 자격증명입니다. (${loginAttempts}/3)`, 'error');
                }
                
            } catch (error) {
                hideLoadingScreen();
                addSecurityLog('ERROR', `인증 중 오류: ${error.message}`);
                showAuthMessage('인증 중 오류가 발생했습니다.', 'error');
            }
        }

        // 관리자 정보 업데이트
        function updateAdminInfo() {
            if (currentUser) {
                document.getElementById('currentAdminInfo').textContent = `${currentUser.username} (${currentUser.role})`;
                document.getElementById('loginTime').textContent = new Date().toLocaleString('ko-KR');
                document.getElementById('lastActivity').textContent = new Date().toLocaleString('ko-KR');
                document.getElementById('userRole').textContent = currentUser.role;
                
                // 세션 상태 업데이트
                updateSessionDisplay();
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            const className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 5000);
        }

        function logout() {
            if (confirm('정말로 로그아웃하시겠습니까?')) {
                addSecurityLog('INFO', `관리자 로그아웃: ${currentUser?.username}`);
                
                // 세션 정리
                clearStoredSession();
                currentUser = null;
                
                showLoginScreen();
                document.getElementById('adminUsername').focus();
                
                // 첫 번째 탭으로 리셋
                currentTab = 'dashboard';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.querySelector('.tab-button').classList.add('active');
                document.getElementById('dashboard-tab').classList.add('active');
            }
        }

        // ========================================
        // 9. 유틸리티 함수들
        // ========================================
        
        // 보안 로그 기능
        function addSecurityLog(level, message) {
            // 매개변수가 1개만 전달된 경우 처리
            if (typeof message === 'undefined') {
                message = level;
                level = 'INFO';
            }
            const timestamp = new Date().toLocaleString('ko-KR');
            const logEntry = {
                timestamp: timestamp,
                level: level,
                message: message,
                id: Date.now() + Math.random()
            };
            securityLogs.unshift(logEntry);
            // 최대 200개 로그만 메모리에 보관
            if (securityLogs.length > 200) {
                securityLogs.pop();
            }
            // 콘솔에도 출력
            switch(level) {
                case 'ERROR':
                    console.error(`[${level}] ${message}`);
                    break;
                case 'WARNING':
                    console.warn(`[${level}] ${message}`);
                    break;
                case 'INFO':
                default:
                    console.log(`[${level}] ${message}`);
                    break;
            }
            // 보안 로그 탭이 활성화되어 있으면 실시간 업데이트
            if (currentTab === 'security') {
                displaySecurityLogs();
            }
            // 대시보드 통계 업데이트
            updateDashboardStats();
        }

        // 보안 로그 표시
        function displaySecurityLogs() {
            const logDisplay = document.getElementById('securityLogDisplay');
            const filter = document.getElementById('logFilter').value;
            let filteredLogs = securityLogs;
            if (filter !== 'all') {
                filteredLogs = securityLogs.filter(log => log.level === filter);
            }
            if (filteredLogs.length === 0) {
                logDisplay.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">표시할 로그가 없습니다.</div>';
                return;
            }
            let html = '';
            filteredLogs.forEach(log => {
                const levelClass = log.level.toLowerCase();
                html += `
                    <div class="log-entry ${levelClass}">
                        [${log.timestamp}] [${log.level}] ${log.message}
                    </div>
                `;
            });
            logDisplay.innerHTML = html;
            // 로그 통계 업데이트
            updateLogStats();
        }

        // 로그 통계 업데이트
        function updateLogStats() {
            const totalCount = securityLogs.length;
            const errorCount = securityLogs.filter(log => log.level === 'ERROR').length;
            const warningCount = securityLogs.filter(log => log.level === 'WARNING').length;
            const infoCount = securityLogs.filter(log => log.level === 'INFO').length;
            document.getElementById('totalLogCount').textContent = totalCount;
            document.getElementById('errorLogCount').textContent = errorCount;
            document.getElementById('warningLogCount').textContent = warningCount;
            document.getElementById('infoLogCount').textContent = infoCount;
        }

        // 로그 필터링
        function filterLogs() {
            displaySecurityLogs();
        }

        // 로그 새로고침
        function refreshLogs() {
            displaySecurityLogs();
            addSecurityLog('INFO', '보안 로그 새로고침');
        }

        // 로그 지우기
        function clearLogs() {
            if (confirm('정말로 모든 보안 로그를 지우시겠습니까?')) {
                securityLogs = [];
                displaySecurityLogs();
                addSecurityLog('WARNING', '보안 로그가 관리자에 의해 삭제됨');
            }
        }

        // 로그 내보내기
        function exportLogs() {
            const filter = document.getElementById('logFilter').value;
            let filteredLogs = securityLogs;
            if (filter !== 'all') {
                filteredLogs = securityLogs.filter(log => log.level === filter);
            }
            let content = '보안 로그 내보내기\n';
            content += '='.repeat(50) + '\n';
            content += `내보낸 시간: ${new Date().toLocaleString('ko-KR')}\n`;
            content += `필터: ${filter === 'all' ? '전체' : filter}\n`;
            content += `이 로그 수: ${filteredLogs.length}\n`;
            content += '='.repeat(50) + '\n\n';
            filteredLogs.forEach(log => {
                content += `[${log.timestamp}] [${log.level}] ${log.message}\n`;
            });
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_logs_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            addSecurityLog('INFO', `보안 로그 내보내기 (${filteredLogs.length}개)`);
        }

        // 대시보드 통계 업데이트 (📊 새로운 통계 추가)
        function updateDashboardStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.isActive).length;
            const pendingDevicesCount = deviceRequests.filter(req => req.status === 'pending').length;
            
            // 📊 새로운 통계 계산
            let totalFoundContacts = 0;
            let totalPhoneCalls = 0;
            let totalSMS = 0;
            let totalUsageCount = 0;
            
            // 각 사용자의 통계 합계 계산
            allUsers.forEach(user => {
                totalFoundContacts += (user.foundContactsCount || 0);
                totalPhoneCalls += (user.phoneCallCount || 0);
                totalSMS += (user.smsCount || 0);
                totalUsageCount += (user.usageCount || 0);
            });
            
            // 평균 계산 (활성 사용자 기준)
            const avgFoundContacts = activeUsers > 0 ? (totalFoundContacts / activeUsers).toFixed(1) : '0';
            const avgPhoneCalls = activeUsers > 0 ? (totalPhoneCalls / activeUsers).toFixed(1) : '0';
            const avgSMS = activeUsers > 0 ? (totalSMS / activeUsers).toFixed(1) : '0';
            const avgUsage = activeUsers > 0 ? (totalUsageCount / activeUsers).toFixed(1) : '0';
            
            // 기본 통계 업데이트
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('pendingDevices').textContent = pendingDevicesCount;
            document.getElementById('totalRegions').textContent = availableRegions.length;
            document.getElementById('totalLogs').textContent = securityLogs.length;
            
            // 📊 새로운 앱 사용 통계 업데이트
            document.getElementById('totalFoundContacts').textContent = totalFoundContacts.toLocaleString();
            document.getElementById('totalPhoneCalls').textContent = totalPhoneCalls.toLocaleString();
            document.getElementById('totalSMS').textContent = totalSMS.toLocaleString();
            
            // 📊 평균 통계 업데이트
            document.getElementById('avgFoundContacts').textContent = avgFoundContacts;
            document.getElementById('avgPhoneCalls').textContent = avgPhoneCalls;
            document.getElementById('avgSMS').textContent = avgSMS;
            document.getElementById('avgUsage').textContent = avgUsage;
            
            // 사용자 관리 탭의 사용자 수도 업데이트
            const userCountEl = document.getElementById('userCount');
            if (userCountEl) {
                userCountEl.textContent = totalUsers;
            }
            
            // 지역 통계 업데이트
            updateRegionStats();
            
            // 최근 활동 표시 (로그인과 사용자 추가만 필터링)
            const recentActivity = document.getElementById('recentActivity');
            if (securityLogs.length > 0) {
                // 관리자 로그인과 사용자 추가 성공 로그만 필터링
                const importantLogs = securityLogs.filter(log => {
                    const message = log.message.toLowerCase();
                    return (
                        (message.includes('관리자 로그인 성공') && log.level === 'INFO') ||
                        (message.includes('사용자 추가 성공') && log.level === 'INFO') ||
                        (message.includes('기기 등록 승인 완료') && log.level === 'INFO') ||
                        (message.includes('권한 업데이트 완료') && log.level === 'INFO') ||
                        (message.includes('세션 복원 성공') && log.level === 'INFO')
                    );
                });
                if (importantLogs.length > 0) {
                    let html = '';
                    importantLogs.slice(0, 5).forEach(log => {
                        let displayMessage = log.message;
                        let icon = 'ℹ️';
                        // 메시지 포맷팅
                        if (log.message.includes('관리자 로그인 성공') || log.message.includes('세션 복원 성공')) {
                            const match = log.message.match(/(관리자 로그인 성공|세션 복원 성공): (\w+)/);
                            if (match) {
                                displayMessage = `${match[1] === '관리자 로그인 성공' ? '관리자 로그인' : '세션 복원'}: ${match[2]}`;
                                icon = '🔐';
                            }
                        } else if (log.message.includes('사용자 추가 성공')) {
                            const phoneMatch = log.message.match(/사용자 추가 성공: (\d+)/);
                            const nameMatch = log.message.match(/등록자: ([^,)]+)/);
                            const referrerMatch = log.message.match(/추천인: ([^)]+)/);
                            if (phoneMatch) {
                                const formattedPhone = formatPhoneNumber(phoneMatch[1]);
                                const userName = nameMatch ? nameMatch[1] : '이름 없음';
                                const referrerInfo = referrerMatch ? ` [추천인: ${referrerMatch[1]}]` : '';
                                displayMessage = `사용자 추가: ${formattedPhone} (${userName})${referrerInfo}`;
                                icon = '👤';
                            }
                        } else if (log.message.includes('기기 등록 승인 완료')) {
                            const phoneMatch = log.message.match(/기기 등록 승인 완료: ([^ ]+)/);
                            const deviceMatch = log.message.match(/\(([^)]+)\)/);
                            if (phoneMatch) {
                                const deviceInfo = deviceMatch ? ` (${deviceMatch[1]})` : '';
                                displayMessage = `기기 등록 승인: ${phoneMatch[1]}${deviceInfo}`;
                                icon = '📱';
                            }
                        } else if (log.message.includes('권한 업데이트 완료')) {
                            const phoneMatch = log.message.match(/권한 업데이트 완료: ([^ ]+)/);
                            const regionMatch = log.message.match(/지역: ([^)]+)/);
                            if (phoneMatch) {
                                const regionInfo = regionMatch ? ` (${regionMatch[1]})` : '';
                                displayMessage = `권한 업데이트: ${phoneMatch[1]}${regionInfo}`;
                                icon = '🗺️';
                            }
                        }
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">${icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #2d3748;">${displayMessage}</div>
                                    <small style="color: #718096;">${log.timestamp}</small>
                                </div>
                            </div>
                        `;
                    });
                    recentActivity.innerHTML = html;
                } else {
                    recentActivity.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">아직 주요 활동이 없습니다.</div>';
                }
            } else {
                recentActivity.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 20px;">활동 내역이 없습니다.</div>';
            }
            
            // 📊 추가 통계 로그 출력
            console.log('📊 대시보드 통계 업데이트:', {
                totalUsers,
                activeUsers,
                totalFoundContacts,
                totalPhoneCalls,
                totalSMS,
                avgFoundContacts,
                avgPhoneCalls,
                avgSMS,
                avgUsage
            });
        }

        // 메시지 표시 함수
        function showMessage(element, message, type) {
            const className = type === 'error' ? 'error-message' : 'success-message';
            element.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // 전화번호 정규화 (강화된 버전)
        function normalizePhoneNumber(phone) {
            if (!phone) return null;
            // 모든 공백, 하이픈, 괄호, 점 등 제거하고 숫자만 남기기
            const cleaned = phone.replace(/[^\d]/g, '');
            // 한국 전화번호 형식 체크
            if (cleaned.length === 10) {
                // 0101234567 -> 01012345678 형태로 가정 (잘못된 입력)
                return null;
            } else if (cleaned.length === 11) {
                // 01012345678 형태
                if (cleaned.startsWith('010') || cleaned.startsWith('011') || 
                    cleaned.startsWith('016') || cleaned.startsWith('017') || 
                    cleaned.startsWith('018') || cleaned.startsWith('019')) {
                    return cleaned;
                }
            } else if (cleaned.length === 12 && cleaned.startsWith('82')) {
                // 821012345678 -> 01012345678 변환 (국가번호 제거)
                return cleaned.substring(2);
            } else if (cleaned.length === 13 && cleaned.startsWith('8210')) {
                // 82101234567 -> 01012345678 변환 (국가번호 제거)
                return cleaned.substring(2);
            }
            return null;
        }

        // 전화번호 형식 표시용 함수
        function formatPhoneNumber(phone) {
            if (!phone || phone.length !== 11) return phone;
            return `${phone.substring(0,3)}-${phone.substring(3,7)}-${phone.substring(7)}`;
        }

        // ========================================
        // 10. 탭 관리 함수들
        // ========================================
        function switchTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 모든 탭 패널 숨기기
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            currentTab = tabName;
            // 탭별 특별한 동작
            switch(tabName) {
                case 'dashboard':
                    updateDashboardStats();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'devices':
                    loadDeviceRequests();
                    loadRegisteredDevices();
                    break;
                case 'referrers':
                    updateReferrerStats();
                    break;
                case 'regions':
                    updateRegionCheckboxes();
                    displayRegionsList();
                    updateRegionStats();
                    break;
                case 'security':
                    displaySecurityLogs();
                    break;
                case 'settings':
                    updateAdminInfo();
                    break;
            }
            addSecurityLog('INFO', `탭 전환: ${tabName}`);
        }

        // ========================================
        // 11. 사용자 관리 함수들 (📊 새로운 통계 포함)
        // ========================================
        
        // 실시간 전화번호 중복 체크 (Firebase 호출 최소화)
        async function checkPhoneDuplicate(phoneNumber) {
            if (!phoneNumber || !db) return false;
            const normalizedPhone = normalizePhoneNumber(phoneNumber);
            if (!normalizedPhone) return false;
            try {
                // 로컬 사용자 목록에서만 체크 (Firebase 호출 제거)
                const localDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                return !!localDuplicate;
            } catch (error) {
                addSecurityLog('WARNING', `중복 체크 중 오류: ${error.message}`);
                return false;
            }
        }

        // 전화번호 입력 시 로컬 중복 체크만 수행 (Firebase 호출 제거)
        let duplicateCheckTimeout;
        function handlePhoneInput() {
            const phoneInput = document.getElementById('newUserPhone');
            const phone = phoneInput.value.trim();
            clearTimeout(duplicateCheckTimeout);
            // 입력 필드 스타일 초기화
            phoneInput.classList.remove('duplicate', 'valid');
            if (phone.length >= 10) {
                duplicateCheckTimeout = setTimeout(async () => {
                    const normalizedPhone = normalizePhoneNumber(phone);
                    if (normalizedPhone) {
                        // 로컬 데이터에서만 중복 체크 (Firebase 호출 없음)
                        const isDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                        if (isDuplicate) {
                            phoneInput.classList.add('duplicate');
                            showMessage(document.getElementById('addUserMessage'), 
                                      '🚫 등록할 수 없는 전화번호 입니다!', 'error');
                        } else {
                            phoneInput.classList.add('valid');
                            document.getElementById('addUserMessage').innerHTML = '';
                        }
                    }
                }, 300); // 응답 시간도 단축
            }
        }

        // 사용자 추가 (강화된 중복 방지, 지역 권한 포함)
        async function addUser() {
            const phone = document.getElementById('newUserPhone').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const referrer = document.getElementById('newUserReferrer').value.trim();
            const messageEl = document.getElementById('addUserMessage');
            const phoneInput = document.getElementById('newUserPhone');
            
            console.log('=== 사용자 추가 시작 ===');
            console.log('입력된 전화번호:', phone);
            console.log('입력된 이름:', name);
            console.log('입력된 추천인:', referrer);
            
            if (!phone) {
                showMessage(messageEl, '📞 전화번호를 입력해주세요.', 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                return;
            }
            
            const normalizedPhone = normalizePhoneNumber(phone);
            console.log('정규화된 전화번호:', normalizedPhone);
            
            if (!normalizedPhone) {
                showMessage(messageEl, '❌ 올바른 전화번호 형식이 아닙니다. (예: 010-1234-5678)', 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                phoneInput.select();
                return;
            }
            
            // 선택된 지역 권한 가져오기
            const selectedRegions = getSelectedRegions();
            console.log('선택된 지역 권한:', selectedRegions);
            
            try {
                addSecurityLog('INFO', `사용자 추가 시도: ${normalizedPhone}`);
                
                // Firebase 연결 상태 확인
                console.log('Firebase db 객체:', db);
                if (!db) {
                    console.error('Firebase db가 null입니다!');
                    showMessage(messageEl, '❌ Firebase가 초기화되지 않았습니다.', 'error');
                    return;
                }
                
                // 1차: 로컬 메모리에서 빠른 중복 체크
                console.log('로컬 중복 체크 시작', '전체 사용자 수:', allUsers.length);
                const localDuplicate = allUsers.find(user => user.phoneNumber === normalizedPhone);
                if (localDuplicate) {
                    console.log('로컬 중복 발견:', localDuplicate);
                    showMessage(messageEl, `🚫 등록할 수 없는 전화번호 입니다! (등록자: ${localDuplicate.name})`, 'error');
                    addSecurityLog('WARNING', `로컬 중복 사용자 등록 시도: ${normalizedPhone}`);
                    phoneInput.classList.add('duplicate');
                    phoneInput.focus();
                    phoneInput.select();
                    return;
                }
                
                // 2차: Firebase에서 최종 중복 체크 (1회만)
                console.log('Firebase 최종 중복 체크...');
                try {
                    const existingUser = await db.collection('authorized_users')
                        .where('phoneNumber', '==', normalizedPhone)
                        .get();
                    console.log('Firebase 쿼리 결과:', existingUser.size);
                    
                    if (!existingUser.empty) {
                        // 중복 사용자 정보 가져오기
                        const duplicateUser = existingUser.docs[0].data();
                        console.log('중복 사용자 정보:', duplicateUser);
                        showMessage(messageEl, 
                                  `🚫 등록할 수 없는 전화번호 입니다!\n등록자: ${duplicateUser.name}\n등록일: ${duplicateUser.createdAt ? duplicateUser.createdAt.toDate().toLocaleDateString('ko-KR') : '알 수 없음'}`, 
                                  'error');
                        addSecurityLog('WARNING', `Firebase 중복 사용자 등록 시도: ${normalizedPhone} (기존 등록자: ${duplicateUser.name})`);
                        phoneInput.classList.add('duplicate');
                        phoneInput.focus();
                        phoneInput.select();
                        return;
                    }
                } catch (queryError) {
                    console.error('Firebase 쿼리 오류:', queryError);
                    addSecurityLog('ERROR', `Firebase 쿼리 실패: ${queryError.message}`);
                    showMessage(messageEl, `❌ 중복 체크 중 오류: ${queryError.message}`, 'error');
                    return;
                }
                
                // 3차: 안전한 사용자 추가
                console.log('사용자 추가 시작...');
                const userData = {
                    phoneNumber: normalizedPhone,
                    name: name || '이름 없음',
                    referrer: referrer || null,
                    regions: selectedRegions.length > 0 ? selectedRegions : null, // 지역 권한 추가
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    usageCount: 0,
                    lastUsed: null,
                    addedBy: currentUser ? currentUser.username : 'unknown',
                    addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceId: null, // 기기 등록 방식 지원
                    deviceName: null,
                    deviceRegisteredAt: null,
                    // 📊 새로운 통계 필드들 초기화
                    foundContactsCount: 0,
                    phoneCallCount: 0,
                    smsCount: 0
                };
                console.log('추가할 사용자 데이터:', userData);
                
                const docRef = await db.collection('authorized_users').add(userData);
                console.log('사용자 추가 성공, 문서 ID:', docRef.id);
                
                // 성공 처리
                showMessage(messageEl, '✅ 사용자가 성공적으로 추가되었습니다!', 'success');
                document.getElementById('newUserPhone').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserReferrer').value = '';
                phoneInput.classList.remove('duplicate', 'valid');
                
                // 지역 체크박스 초기화
                clearAllRegions();
                
                // 로그에 지역 권한 정보도 포함
                const regionInfo = selectedRegions.length > 0 ? ` (지역: ${selectedRegions.join(', ')})` : ' (무제한 접근)';
                const logMessage = referrer 
                    ? `사용자 추가 성공: ${normalizedPhone} (ID: ${docRef.id}, 등록자: ${name || '이름 없음'}, 추천인: ${referrer})${regionInfo}`
                    : `사용자 추가 성공: ${normalizedPhone} (ID: ${docRef.id}, 등록자: ${name || '이름 없음'})${regionInfo}`;
                addSecurityLog('INFO', logMessage);
                
                // 사용자 목록 새로고침
                setTimeout(() => {
                    console.log('사용자 목록 새로고침 시작...');
                    loadUsers();
                    updateDashboardStats();
                    // 추천인 통계도 업데이트 (추천인이 있는 경우)
                    if (referrer && currentTab === 'referrers') {
                        updateReferrerStats();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('=== 사용자 추가 오류 ===');
                console.error('오류 메시지:', error.message);
                console.error('오류 코드:', error.code);
                console.error('전체 오류 객체:', error);
                addSecurityLog('ERROR', `사용자 추가 실패: ${error.message} (코드: ${error.code})`);
                let errorMessage = '❌ 사용자 추가 중 오류가 발생했습니다.';
                if (error.code === 'permission-denied') {
                    errorMessage = '❌ Firebase 권한이 없습니다. 관리자에게 문의하세요.';
                } else if (error.code === 'unavailable') {
                    errorMessage = '❌ Firebase 서버에 연결할 수 없습니다. 나중에 다시 시도해주세요.';
                } else if (error.message) {
                    errorMessage = `❌ 오류: ${error.message}`;
                }
                showMessage(messageEl, errorMessage, 'error');
                phoneInput.classList.add('duplicate');
                phoneInput.focus();
                phoneInput.select();
            }
        }

        // 사용자 목록 로드 (극한 캐싱)
        async function loadUsers(forceRefresh = false) {
            try {
                const now = Date.now();
                // 캐시가 유효하고 강제 새로고침이 아닐 경우
                if (!forceRefresh && usersCache.loaded && 
                    (now - usersCache.timestamp < CACHE_DURATION) && 
                    usersCache.data.length > 0) {
                    addSecurityLog('INFO', `사용자 목록 캐시 사용 (${usersCache.data.length}명)`);
                    allUsers = [...usersCache.data];
                    displayUsers(allUsers);
                    updateDashboardStats();
                    return;
                }
                
                addSecurityLog('INFO', '사용자 목록 Firebase 로드 시도');
                if (!db) {
                    // Firebase 없이 기본 데이터 사용
                    addSecurityLog('WARNING', 'Firebase 미초기화 - 기본 데이터 사용');
                    allUsers = [];
                    displayUsers(allUsers);
                    return;
                }
                
                // Firebase 호출 제한
                const snapshot = await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users')
                        .orderBy('createdAt', 'desc')
                        .limit(500) // 최대 500명으로 제한
                        .get();
                });
                
                addSecurityLog('INFO', `Firestore에서 ${snapshot.size}개 문서 조회`);
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // 캐시 업데이트
                usersCache = {
                    data: [...allUsers],
                    timestamp: now,
                    loaded: true
                };
                
                displayUsers(allUsers);
                addSecurityLog('INFO', `사용자 목록 로드 완료: ${allUsers.length}명 (캐시됨)`);
                
                // 대시보드 통계 업데이트
                updateDashboardStats();
                
                // 추천인 통계 업데이트 (추천인 탭이 활성화된 경우)
                if (currentTab === 'referrers') {
                    updateReferrerStats();
                }
                
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 - 캐시된 데이터 사용');
                    if (usersCache.data.length > 0) {
                        allUsers = [...usersCache.data];
                        displayUsers(allUsers);
                        addSecurityLog('INFO', `캐시된 사용자 데이터 사용 (${allUsers.length}명)`);
                    } else {
                        addSecurityLog('WARNING', '캐시된 데이터 없음 - 빈 목록 표시');
                        allUsers = [];
                        displayUsers(allUsers);
                    }
                } else {
                    addSecurityLog('ERROR', `사용자 목록 로드 실패: ${error.message}`);
                    document.getElementById('userList').innerHTML = `<div class="error-message">사용자 목록 로드 실패: ${error.message}<br><button onclick="loadUsers(true)" class="btn btn-secondary">🔄 재시도</button></div>`;
                }
            }
        }

        // 📊 사용자 목록 표시 (새로운 통계 추가)
        function displayUsers(users) {
            const userListEl = document.getElementById('userList');
            if (users.length === 0) {
                userListEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">등록된 사용자가 없습니다.</div>';
                return;
            }
            let html = '';
            users.forEach(user => {
                const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleDateString('ko-KR') : '알 수 없음';
                const formattedPhone = formatPhoneNumber(user.phoneNumber);
                const referrerText = user.referrer ? ` | 추천인: ${user.referrer}` : '';
                
                // 권한 정보 표시
                const permissionText = getUserPermissionText(user);
                const permissionTags = user.regions && user.regions.length > 0 
                    ? user.regions.map(region => `<span class="permission-tag limited">${region}</span>`).join('')
                    : '<span class="permission-tag all-regions">모든 지역</span>';
                
                // 📊 새로운 통계 정보 추가
                const foundContacts = user.foundContactsCount || 0;
                const phoneCallCount = user.phoneCallCount || 0;
                const smsCount = user.smsCount || 0;
                const usageCount = user.usageCount || 0;
                
                // 통계 텍스트 생성
                const statsText = `찾은 지인: ${foundContacts}명 | 전화: ${phoneCallCount}회 | 문자: ${smsCount}회`;
                
                html += `
                    <div class="user-item">
                        <div>
                            <strong>${formattedPhone}</strong> (${user.name || '이름 없음'})<br>
                            <small>가입: ${createdAt} | 사용횟수: ${usageCount}회${referrerText}</small>
                            <div class="user-permissions">
                                <span style="font-size: 12px; color: #666; margin-right: 8px;">권한:</span>
                                ${permissionTags}
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #495057;">
                                <span style="font-weight: bold; color: #667eea;">📊 이용 통계:</span> ${statsText}
                            </div>
                        </div>
                        <div class="user-actions">
                            <button onclick="openPermissionsModal('${user.id}')" class="btn btn-edit">
                                🗺️ 권한 편집
                            </button>
                            <button onclick="toggleUserStatus('${user.id}', ${!user.isActive})" 
                                    class="btn ${user.isActive ? 'btn-danger' : 'btn-primary'}">
                                ${user.isActive ? '비활성화' : '활성화'}
                            </button>
                            <button onclick="deleteUser('${user.id}', '${formattedPhone}')" 
                                    class="btn btn-danger">삭제</button>
                        </div>
                    </div>
                `;
            });
            userListEl.innerHTML = html;
        }

        // 사용자 상태 토글 (Firebase 호출 제한)
        async function toggleUserStatus(userId, newStatus) {
            try {
                const user = allUsers.find(u => u.id === userId);
                const formattedPhone = formatPhoneNumber(user?.phoneNumber);
                addSecurityLog('INFO', `사용자 상태 변경: ${formattedPhone} -> ${newStatus ? '활성' : '비활성'}`);
                
                // 로컬에서 먼저 업데이트 (즉시 UI 반영)
                if (user) {
                    user.isActive = newStatus;
                }
                displayUsers(allUsers);
                
                // Firebase 업데이트 (제한 적용)
                await throttledFirebaseCall(async () => {
                    return await db.collection('authorized_users').doc(userId).update({
                        isActive: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.username
                    });
                });
                
                alert(`사용자 ${formattedPhone}이(가) ${newStatus ? '활성화' : '비활성화'}되었습니다.`);
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 - 로컬 변경만 적용');
                    alert(`로컬에서 ${formattedPhone}이(가) ${newStatus ? '활성화' : '비활성화'}되었습니다. (Firebase 저장 실패)`);
                } else {
                    addSecurityLog('ERROR', `사용자 상태 변경 실패: ${error.message}`);
                    alert('사용자 상태 변경 중 오류가 발생했습니다.');
                    // 실패시 로컬 변경 롤백
                    if (user) {
                        user.isActive = !newStatus;
                        displayUsers(allUsers);
                    }
                }
            }
        }

        // 사용자 삭제
        async function deleteUser(userId, formattedPhoneNumber) {
            if (confirm(`정말로 ${formattedPhoneNumber} 사용자를 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다!`)) {
                try {
                    const user = allUsers.find(u => u.id === userId);
                    addSecurityLog('WARNING', `사용자 삭제: ${formattedPhoneNumber} (${user?.name})`);
                    await db.collection('authorized_users').doc(userId).delete();
                    loadUsers();
                    alert(`사용자 ${formattedPhoneNumber}이(가) 삭제되었습니다.`);
                } catch (error) {
                    addSecurityLog('ERROR', `사용자 삭제 실패: ${error.message}`);
                    alert('사용자 삭제 중 오류가 발생했습니다.');
                }
            }
        }

        // ========================================
        // 12. 추천인 통계 관련 함수들
        // ========================================
        
        // 추천인 통계 업데이트
        function updateReferrerStats() {
            calculateReferrerStats();
            displayReferrerRanking();
            updateReferrerFilter();
        }

        // 추천인별 통계 계산
        function calculateReferrerStats() {
            console.log('추천인 통계 계산 시작', '전체 사용자:', allUsers.length);
            // 추천인별 데이터 집계
            const referrerData = {};
            let selfRegistered = 0;
            let totalReferred = 0;
            
            allUsers.forEach(user => {
                if (user.referrer && user.referrer.trim()) {
                    const referrer = user.referrer.trim();
                    if (!referrerData[referrer]) {
                        referrerData[referrer] = {
                            name: referrer,
                            totalUsers: 0,
                            activeUsers: 0,
                            users: []
                        };
                    }
                    referrerData[referrer].totalUsers++;
                    referrerData[referrer].users.push(user);
                    totalReferred++;
                    if (user.isActive) {
                        referrerData[referrer].activeUsers++;
                    }
                } else {
                    selfRegistered++;
                }
            });
            
            // 전역 변수로 저장
            window.referrerStats = referrerData;
            
            // 통계 표시
            const totalReferrers = Object.keys(referrerData).length;
            const avgReferrals = totalReferrers > 0 ? (totalReferred / totalReferrers).toFixed(1) : 0;
            
            document.getElementById('totalReferrers').textContent = totalReferrers;
            document.getElementById('referredUsers').textContent = totalReferred;
            document.getElementById('selfRegistered').textContent = selfRegistered;
            document.getElementById('avgReferrals').textContent = avgReferrals;
            
            console.log('추천인 통계:', {
                totalReferrers,
                totalReferred,
                selfRegistered,
                avgReferrals,
                referrerData
            });
        }

        // 추천인 순위 표시
        function displayReferrerRanking() {
            const rankingEl = document.getElementById('referrerRanking');
            const referrerData = window.referrerStats || {};
            
            // 추천 수 기준으로 정렬
            const sortedReferrers = Object.values(referrerData).sort((a, b) => b.totalUsers - a.totalUsers);
            
            if (sortedReferrers.length === 0) {
                rankingEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">추천인이 없습니다.</div>';
                return;
            }
            
            let html = '';
            sortedReferrers.forEach((referrer, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}위`;
                const activeRate = referrer.totalUsers > 0 ? ((referrer.activeUsers / referrer.totalUsers) * 100).toFixed(1) : 0;
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${rank <= 3 ? '#667eea' : '#e2e8f0'}; cursor: pointer;" onclick="selectReferrer('${referrer.name}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #2d3748;">
                                    ${medal} ${referrer.name}
                                </div>
                                <small style="color: #718096;">활성률: ${activeRate}%</small>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;">
                                    ${referrer.totalUsers}명
                                </div>
                                <small style="color: #718096;">추천</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            rankingEl.innerHTML = html;
        }

        // 추천인 필터 옵션 업데이트
        function updateReferrerFilter() {
            const filterEl = document.getElementById('referrerFilter');
            const referrerData = window.referrerStats || {};
            
            // 기존 옵션 초기화
            filterEl.innerHTML = '<option value="">전체 추천인</option>';
            
            // 추천인별 옵션 추가
            const sortedReferrers = Object.values(referrerData).sort((a, b) => b.totalUsers - a.totalUsers);
            sortedReferrers.forEach(referrer => {
                const option = document.createElement('option');
                option.value = referrer.name;
                option.textContent = `${referrer.name} (${referrer.totalUsers}명)`;
                filterEl.appendChild(option);
            });
        }

        // 특정 추천인 선택
        function selectReferrer(referrerName) {
            const filterEl = document.getElementById('referrerFilter');
            filterEl.value = referrerName;
            filterByReferrer();
        }

        // 추천인별 사용자 목록 필터링
        function filterByReferrer() {
            const selectedReferrer = document.getElementById('referrerFilter').value;
            const listEl = document.getElementById('referredUsersList');
            const referrerData = window.referrerStats || {};
            
            if (!selectedReferrer) {
                listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">추천인을 선택해주세요.</div>';
                return;
            }
            
            const referrerInfo = referrerData[selectedReferrer];
            if (!referrerInfo || referrerInfo.users.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">해당 추천인의 사용자가 없습니다.</div>';
                return;
            }
            
            let html = `
                <div style="background: #667eea; color: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
                    <strong>${selectedReferrer}</strong>의 추천 사용자 (${referrerInfo.totalUsers}명)
                </div>
            `;
            
            referrerInfo.users.forEach((user, index) => {
                const createdAt = user.createdAt ? user.createdAt.toDate().toLocaleDateString('ko-KR') : '알 수 없음';
                const formattedPhone = formatPhoneNumber(user.phoneNumber);
                html += `
                    <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid ${user.isActive ? '#28a745' : '#dc3545'};">
                        <div style="font-weight: bold; color: #2d3748;">
                            ${index + 1}. ${formattedPhone} (${user.name || '이름 없음'})
                        </div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                            가입: ${createdAt} | 사용: ${user.usageCount || 0}회 | 상태: ${user.isActive ? '✅ 활성' : '❌ 비활성'}
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }

        // ========================================
        // 13. 기기 관리 함수들 (수정된 버전)
        // ========================================
        
        // 기기 등록 요청 목록 로드 (수정된 버전)
        async function loadDeviceRequests(forceRefresh = false) {
            try {
                const now = Date.now();
                // 기기 요청은 실시간성이 중요하지만, 1분 캐시 적용
                if (!forceRefresh && devicesCache.timestamp && 
                    (now - devicesCache.timestamp < 60 * 1000) && 
                    devicesCache.data.length >= 0) {
                    addSecurityLog('INFO', `기기 요청 캐시 사용 (${devicesCache.data.length}건)`);
                    deviceRequests = [...devicesCache.data];
                    displayDeviceRequests();
                    return;
                }
                
                addSecurityLog('INFO', '기기 등록 요청 목록 로드 시도');
                if (!db) {
                    document.getElementById('deviceRequests').innerHTML = '<div class="error-message">Firebase가 초기화되지 않았습니다.</div>';
                    return;
                }
                
                // 수정된 쿼리 - orderBy 제거하여 인덱스 에러 방지
                const snapshot = await throttledFirebaseCall(async () => {
                    return await db.collection('device_registration_requests')
                        .where('status', '==', 'pending') // pending만 조회
                        .limit(50) // 최대 50건으로 제한
                        .get();
                });
                
                deviceRequests = [];
                snapshot.forEach(doc => {
                    deviceRequests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // 메모리에서 정렬 (requestedAt이 있는 경우만)
                deviceRequests.sort((a, b) => {
                    if (a.requestedAt && b.requestedAt) {
                        return b.requestedAt.seconds - a.requestedAt.seconds;
                    }
                    return 0;
                });
                
                // 캐시 업데이트
                devicesCache = {
                    data: [...deviceRequests],
                    timestamp: now
                };
                
                displayDeviceRequests();
                addSecurityLog('INFO', `기기 등록 요청 로드 완료: ${deviceRequests.length}건`);
                
            } catch (error) {
                if (error.message === 'QUOTA_EXCEEDED') {
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 - 기기 요청 캐시 사용');
                    if (devicesCache.data) {
                        deviceRequests = [...devicesCache.data];
                        displayDeviceRequests();
                    }
                } else if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                    addSecurityLog('ERROR', `Firebase 권한 부족: ${error.message}`);
                    // 권한 부족시 빈 목록으로 처리 (모의 데이터 사용 가능)
                    deviceRequests = [];
                    document.getElementById('deviceRequests').innerHTML = `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #856404; margin-bottom: 10px;">⚠️ 권한 부족</h4>
                            <p style="color: #856404; margin-bottom: 15px;">기기 등록 요청 데이터에 접근할 권한이 없습니다.</p>
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                                <strong>해결 방법:</strong><br>
                                1. Firebase Console → Firestore → 규칙<br>
                                2. device_registration_requests 컬렉션에 읽기 권한 추가<br>
                                3. 또는 관리자에게 권한 설정 요청
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="loadDeviceRequests(true)" class="btn btn-secondary">🔄 재시도</button>
                            </div>
                        </div>
                    `;
                    displayDeviceRequests(); // 빈 목록 표시
                } else {
                    addSecurityLog('ERROR', `기기 등록 요청 로드 실패: ${error.message}`);
                    document.getElementById('deviceRequests').innerHTML = `<div class="error-message">기기 등록 요청 로드 실패: ${error.message}<br><button onclick="loadDeviceRequests(true)" class="btn btn-secondary">🔄 재시도</button></div>`;
                }
            }
        }

        // 기기 등록 요청 표시
        function displayDeviceRequests() {
            const requestsEl = document.getElementById('deviceRequests');
            const pendingRequests = deviceRequests.filter(req => req.status === 'pending');
            document.getElementById('pendingRequestsCount').textContent = pendingRequests.length;
            
            if (pendingRequests.length === 0) {
                requestsEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">🎉 처리할 기기 등록 요청이 없습니다!</div>';
                return;
            }
            
            let html = '';
            pendingRequests.forEach(request => {
                const requestedAt = request.requestedAt ? request.requestedAt.toDate().toLocaleString('ko-KR') : '알 수 없음';
                const formattedPhone = formatPhoneNumber(request.phoneNumber);
                html += `
                    <div class="device-item pending">
                        <div class="status-badge pending">대기 중</div>
                        <div class="device-info">
                            <div class="device-field">
                                <label>📞 전화번호</label>
                                <span>${formattedPhone}</span>
                            </div>
                            <div class="device-field">
                                <label>👤 사용자명</label>
                                <span>${request.userName || '이름 없음'}</span>
                            </div>
                            <div class="device-field">
                                <label>📱 기기 ID</label>
                                <span style="font-family: monospace; font-size: 12px;">${request.deviceId}</span>
                            </div>
                            <div class="device-field">
                                <label>📋 기기명</label>
                                <span>${request.deviceName || '알 수 없음'}</span>
                            </div>
                            <div class="device-field">
                                <label>🕐 요청 시간</label>
                                <span>${requestedAt}</span>
                            </div>
                            <div class="device-field">
                                <label>💬 요청 메시지</label>
                                <span>${request.userMessage || '메시지 없음'}</span>
                            </div>
                        </div>
                        <div class="device-actions">
                            <button onclick="approveDeviceRequest('${request.id}')" class="btn btn-success">
                                ✅ 승인
                            </button>
                            <button onclick="rejectDeviceRequest('${request.id}')" class="btn btn-danger">
                                ❌ 거부
                            </button>
                        </div>
                    </div>
                `;
            });
            requestsEl.innerHTML = html;
        }

        // 등록된 기기 목록 로드 (수정된 버전)
        async function loadRegisteredDevices() {
            try {
                addSecurityLog('INFO', '등록된 기기 목록 로드 시작');
                if (!db) {
                    document.getElementById('registeredDevices').innerHTML = '<div class="error-message">Firebase가 초기화되지 않았습니다.</div>';
                    return;
                }
                
                // 수정된 쿼리 - orderBy 제거하여 안정성 향상
                const snapshot = await db.collection('authorized_users')
                    .where('deviceId', '!=', null)
                    .limit(200) // 제한 추가
                    .get();
                
                registeredDevices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.deviceId) { // deviceId가 실제로 있는 경우만
                        registeredDevices.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // 메모리에서 정렬 (deviceRegisteredAt이 있는 경우만)
                registeredDevices.sort((a, b) => {
                    if (a.deviceRegisteredAt && b.deviceRegisteredAt) {
                        return b.deviceRegisteredAt.seconds - a.deviceRegisteredAt.seconds;
                    }
                    return 0;
                });
                
                displayRegisteredDevices();
                addSecurityLog('INFO', `등록된 기기 목록 로드 완료: ${registeredDevices.length}대`);
                
            } catch (error) {
                addSecurityLog('ERROR', `등록된 기기 목록 로드 실패: ${error.message}`);
                document.getElementById('registeredDevices').innerHTML = `<div class="error-message">등록된 기기 목록 로드 실패: ${error.message}</div>`;
            }
        }

        // 등록된 기기 목록 표시
        function displayRegisteredDevices(devices = registeredDevices) {
            const devicesEl = document.getElementById('registeredDevices');
            document.getElementById('registeredDevicesCount').textContent = devices.length;
            
            if (devices.length === 0) {
                devicesEl.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">📱 등록된 기기가 없습니다.</div>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const registeredAt = device.deviceRegisteredAt ? device.deviceRegisteredAt.toDate().toLocaleString('ko-KR') : '알 수 없음';
                const formattedPhone = formatPhoneNumber(device.phoneNumber);
                html += `
                    <div class="device-item approved">
                        <div>
                            <strong>${formattedPhone}</strong> (${device.name || '이름 없음'}) | 등록: ${registeredAt}
                        </div>
                        <div class="device-actions">
                            <button onclick="resetUserDevice('${device.id}', '${formattedPhone}')" class="btn btn-warning">
                                🔄 기기 초기화
                            </button>
                            <button onclick="toggleUserStatus('${device.id}', ${!device.isActive})" 
                                    class="btn ${device.isActive ? 'btn-danger' : 'btn-success'}">
                                ${device.isActive ? '❌ 비활성화' : '✅ 활성화'}
                            </button>
                        </div>
                    </div>
                `;
            });
            devicesEl.innerHTML = html;
        }

        // 모든 캐시 강제 무효화 (새로 추가)
        async function forceRefreshAllCaches() {
            try {
                addSecurityLog('INFO', '모든 캐시 강제 무효화 시작');
                // 모든 캐시 타임스탬프를 0으로 설정하여 무효화
                usersCache.timestamp = 0;
                usersCache.loaded = false;
                devicesCache.timestamp = 0;
                regionsCache.timestamp = 0;
                
                // 로컬 배열들도 초기화
                deviceRequests = [];
                registeredDevices = [];
                
                // UI에 로딩 상태 표시
                document.getElementById('deviceRequests').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">🔄 캐시 무효화 중...</div>';
                document.getElementById('registeredDevices').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">🔄 캐시 무효화 중...</div>';
                
                // 모든 데이터 강제 새로고침
                await Promise.all([
                    loadDeviceRequests(true), // forceRefresh = true
                    loadRegisteredDevices(),
                    loadUsers(true) // forceRefresh = true
                ]);
                
                updateDashboardStats();
                addSecurityLog('INFO', '모든 캐시 무효화 완료');
                alert('✅ 캐시가 무효화되고 최신 데이터를 불러왔습니다!');
                
            } catch (error) {
                addSecurityLog('ERROR', `캐시 무효화 실패: ${error.message}`);
                alert('❌ 캐시 무효화 중 오류가 발생했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // 기기 승인/거부 함수들은 기존과 동일...
        async function approveDeviceRequest(requestId) {
            // 기존 구현과 동일
            alert('기기 승인 기능은 추후 구현될 예정입니다.');
        }

        async function rejectDeviceRequest(requestId) {
            // 기존 구현과 동일
            alert('기기 거부 기능은 추후 구현될 예정입니다.');
        }

        // 기기 검색
        function searchDevices() {
            const searchTerm = document.getElementById('deviceSearchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                displayRegisteredDevices();
                return;
            }
            const filteredDevices = registeredDevices.filter(device => {
                const phoneNumber = formatPhoneNumber(device.phoneNumber).toLowerCase();
                const deviceName = (device.deviceName || '').toLowerCase();
                const userName = (device.name || '').toLowerCase();
                const deviceId = (device.deviceId || '').toLowerCase();
                return phoneNumber.includes(searchTerm) || 
                       deviceName.includes(searchTerm) || 
                       userName.includes(searchTerm) ||
                       deviceId.includes(searchTerm);
            });
            displayRegisteredDevices(filteredDevices);
            addSecurityLog('INFO', `기기 검색: "${searchTerm}" (${filteredDevices.length}건 발견)`);
        }

        // 사용자 기기 초기화
        async function resetUserDevice(userId, formattedPhone) {
            if (!confirm(`${formattedPhone} 사용자의 기기 등록을 초기화하시겠습니까?\n\n⚠️ 이 작업을 수행하면 사용자가 새로운 기기 등록을 요청해야 합니다.`)) {
                return;
            }
            try {
                addSecurityLog('WARNING', `사용자 기기 초기화: ${formattedPhone}`);
                await db.collection('authorized_users').doc(userId).update({
                    deviceId: firebase.firestore.FieldValue.delete(),
                    deviceName: firebase.firestore.FieldValue.delete(),
                    deviceRegisteredAt: firebase.firestore.FieldValue.delete(),
                    deviceResetAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceResetBy: currentUser.username
                });
                addSecurityLog('WARNING', `기기 초기화 완료: ${formattedPhone}`);
                alert(`✅ ${formattedPhone} 사용자의 기기가 초기화되었습니다.`);
                // 목록 새로고침
                loadRegisteredDevices();
                loadUsers();
            } catch (error) {
                addSecurityLog('ERROR', `기기 초기화 실패: ${error.message}`);
                alert(`❌ 기기 초기화 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // ========================================
        // 14. 비밀번호 변경 기능
        // ========================================
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageEl = document.getElementById('adminSettingsMessage');
            
            // 입력 검증
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage(messageEl, '모든 필드를 입력해주세요.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessage(messageEl, '새 비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            if (newPassword.length < 8) {
                showMessage(messageEl, '새 비밀번호는 최소 8자 이상이어야 합니다.', 'error');
                return;
            }
            // 비밀번호 복잡성 검증
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/;
            if (!passwordRegex.test(newPassword)) {
                showMessage(messageEl, '새 비밀번호는 대문자, 소문자, 숫자, 특수문자를 포함해야 합니다.', 'error');
                return;
            }
            try {
                addSecurityLog('INFO', `비밀번호 변경 시도: ${currentUser.username}`);
                // 현재 비밀번호 확인
                const currentPasswordHash = CryptoJS.SHA256(currentPassword).toString();
                if (currentUser.password !== currentPasswordHash) {
                    showMessage(messageEl, '현재 비밀번호가 올바르지 않습니다.', 'error');
                    addSecurityLog('WARNING', `잘못된 현재 비밀번호: ${currentUser.username}`);
                    return;
                }
                
                // 새 비밀번호 해시
                const newPasswordHash = CryptoJS.SHA256(newPassword).toString();
                
                // Firebase 업데이트
                await db.collection('admin_users').doc(currentUser.id).update({
                    password: newPasswordHash,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    changedBy: currentUser.username
                });
                
                // 로컬 currentUser 정보 업데이트
                currentUser.password = newPasswordHash;
                
                // 입력 필드 초기화
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showMessage(messageEl, '✅ 비밀번호가 성공적으로 변경되었습니다.', 'success');
                addSecurityLog('INFO', `비밀번호 변경 성공: ${currentUser.username}`);
                
            } catch (error) {
                addSecurityLog('ERROR', `비밀번호 변경 실패: ${error.message}`);
                showMessage(messageEl, '❌ 비밀번호 변경 중 오류가 발생했습니다.', 'error');
            }
        }

        // 앱 만료일 저장 함수
        async function saveExpiryDate() {
            const dateValue = document.getElementById('expiryDateInput').value;
            if (!dateValue) {
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:red;'>❌ 날짜를 선택하세요.</span>";
                return;
            }
            const selectedDate = new Date(dateValue + "T00:00:00");
            try {
                await db.collection('config').doc('settings').set({
                    expiryDate: firebase.firestore.Timestamp.fromDate(selectedDate)
                }, { merge: true });
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:green;'>✅ 만료일이 저장되었습니다.</span>";
            } catch (e) {
                document.getElementById('expiryDateMessage').innerHTML = "<span style='color:red;'>❌ 저장 실패: " + e.message + "</span>";
            }
        }

        // ========================================
        // 15. 초기화 및 이벤트 리스너
        // ========================================
        
        // DOM이 로드된 후 초기화 (세션 복원 기능 추가)
        document.addEventListener('DOMContentLoaded', async function() {
            addSecurityLog('INFO', '관리자 대시보드 로드 시작');
            
            // 로딩 화면 표시
            showLoadingScreen('시스템 초기화 중...');
            
            // Firebase 초기화 (실패해도 계속 진행)
            try {
                const firebaseInitSuccess = initializeFirebase();
                if (firebaseInitSuccess) {
                    addSecurityLog('INFO', 'Firebase 초기화 완료');
                } else {
                    addSecurityLog('WARNING', 'Firebase 초기화 실패 - 오프라인 모드');
                }
            } catch (initError) {
                addSecurityLog('ERROR', `Firebase 초기화 중 예외: ${initError.message}`);
                // Firebase 없이도 작동하도록 폴백
                adminUsers = [{
                    id: 'emergency_admin',
                    username: 'admin',
                    password: CryptoJS.SHA256('SecureAdmin2024!@#').toString(),
                    role: 'admin',
                    permissions: ['view_users', 'add_users', 'toggle_users', 'delete_users', 'change_password', 'admin_management'],
                    isActive: true,
                    isLocal: true,
                    isEmergency: true
                }];
                addSecurityLog('INFO', '응급 관리자 계정 생성 - 완전 오프라인 모드');
            }
            
            // 보안 기능 활성화
            try {
                blockDevTools();
                addSecurityLog('INFO', '보안 시스템 활성화 완료');
            } catch (securityError) {
                addSecurityLog('WARNING', `보안 시스템 초기화 오류: ${securityError.message}`);
            }
            
            // 세션 복원 시도
            showLoadingScreen('세션 확인 중...');
            try {
                const sessionRestored = await restoreSession();
                if (sessionRestored) {
                    addSecurityLog('INFO', '세션 복원 성공 - 자동 로그인');
                    hideLoadingScreen();
                    return; // 세션 복원 성공시 여기서 종료
                } else {
                    addSecurityLog('INFO', '복원할 세션 없음 - 로그인 화면 표시');
                }
            } catch (sessionError) {
                addSecurityLog('ERROR', `세션 복원 중 오류: ${sessionError.message}`);
            }
            
            // 세션 복원 실패시 로그인 화면 표시
            hideLoadingScreen();
            showLoginScreen();
            
            // 포커스 설정
            const usernameInput = document.getElementById('adminUsername');
            if (usernameInput) {
                usernameInput.focus();
            }
            
            // 엔터키 이벤트 리스너
            document.getElementById('adminUsername').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('adminPassword').focus();
                }
            });
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticateAdmin();
                }
            });
            
            // 비밀번호 변경 엔터키 이벤트
            document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changePassword();
                }
            });
            
            // 전화번호 입력 필드 실시간 중복 체크
            const phoneInput = document.getElementById('newUserPhone');
            phoneInput.addEventListener('input', handlePhoneInput);
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newUserName').focus();
                }
            });
            
            // 전화번호 필드에 포커스가 가면 오류 스타일 제거
            phoneInput.addEventListener('focus', function() {
                this.classList.remove('duplicate');
                document.getElementById('addUserMessage').innerHTML = '';
            });
            
            // 사용자 이름 입력 후 엔터키로 추천인 필드로 이동
            document.getElementById('newUserName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newUserReferrer').focus();
                }
            });
            
            // 추천인 입력 후 엔터키로 추가
            document.getElementById('newUserReferrer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addUser();
                }
            });
            
            // 기기 검색 엔터키 이벤트
            const deviceSearchInput = document.getElementById('deviceSearchInput');
            if (deviceSearchInput) {
                deviceSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchDevices();
                    }
                });
            }
            
            // 지역 검색 엔터키 이벤트
            const regionSearchInput = document.getElementById('regionSearchInput');
            if (regionSearchInput) {
                regionSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchRegions();
                    }
                });
            }
            
            // 모달 외부 클릭시 닫기
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('editPermissionsModal');
                if (event.target === modal) {
                    closePermissionsModal();
                }
            });
            
            // 활동 감지 이벤트 최적화 (Firebase 업데이트 완전 제거)
            let activityTimer;
            function resetActivityTimer() {
                clearTimeout(activityTimer);
                // 로컬 시간만 업데이트 (Firebase 호출 제거)
                if (currentUser) {
                    document.getElementById('lastActivity').textContent = new Date().toLocaleString('ko-KR');
                }
                // 30분 비활성시 자동 로그아웃
                activityTimer = setTimeout(() => {
                    if (currentUser) {
                        addSecurityLog('WARNING', '비활성으로 인한 자동 로그아웃');
                        alert('30분간 비활성 상태로 자동 로그아웃됩니다.');
                        logout();
                    }
                }, 30 * 60 * 1000);
            }
            
            // 활동 감지 이벤트 최소화
            ['keypress', 'click'].forEach(event => {
                document.addEventListener(event, resetActivityTimer, true);
            });
            
            addSecurityLog('INFO', '관리자 대시보드 초기화 완료');
            
            // Firebase 할당량 초과 감지 및 처리 (강화된 버전)
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && 
                    (event.reason.code === 'resource-exhausted' || 
                     event.reason.message?.includes('Quota exceeded') ||
                     event.reason.message?.includes('quota'))) {
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 감지 - 전역 처리');
                    showQuotaExceededMessage();
                    event.preventDefault();
                }
            });
            
            // Firebase 에러 전역 감지
            window.addEventListener('error', function(event) {
                const errorMessage = event.error?.message || event.message || '';
                if (errorMessage.includes('resource-exhausted') || 
                    errorMessage.includes('Quota exceeded')) {
                    addSecurityLog('ERROR', 'Firebase 할당량 초과 감지 - 에러 이벤트');
                    showQuotaExceededMessage();
                }
            });
            
            // 지역 정보 즉시 초기화 (Firebase 없이 고정 데이터 사용)
            updateRegionCheckboxes();
        });
        
        // 페이지 언로드시 정리
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                addSecurityLog('INFO', `관리자 세션 종료: ${currentUser.username}`);
            }
            // 세션 모니터링 정리
            stopSessionMonitoring();
        });
    </script>
</body>
</html>