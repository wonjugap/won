<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전화번호 매칭 프로그램</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .icon {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
            fill: currentColor;
        }
        .icon-large {
            width: 3rem;
            height: 3rem;
        }
        .icon-medium {
            width: 1.25rem;
            height: 1.25rem;
        }
        .icon-small {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, createElement: h } = React;

        // SVG 아이콘들
        const UploadIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        }, 
            h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
            h('polyline', { points: '7,10 12,15 17,10' }),
            h('line', { x1: '12', y1: '15', x2: '12', y2: '3' })
        );

        const SearchIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        },
            h('circle', { cx: '11', cy: '11', r: '8' }),
            h('path', { d: 'M21 21l-4.35-4.35' })
        );

        const DownloadIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        },
            h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
            h('polyline', { points: '7,10 12,15 17,10' }),
            h('line', { x1: '12', y1: '15', x2: '12', y2: '3' })
        );

        const FileTextIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        },
            h('path', { d: 'M14,2 L14,8 L20,8 L20,22 L4,22 L4,2 L14,2 Z' }),
            h('polyline', { points: '14,2 14,8 20,8' }),
            h('line', { x1: '16', y1: '13', x2: '8', y2: '13' }),
            h('line', { x1: '16', y1: '17', x2: '8', y2: '17' }),
            h('polyline', { points: '10,9 9,9 8,9' })
        );

        const PhoneIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        },
            h('path', { d: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' })
        );

        const AlertCircleIcon = ({ className }) => h('svg', {
            className: `icon ${className}`,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2'
        },
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('line', { x1: '12', y1: '8', x2: '12', y2: '12' }),
            h('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' })
        );

        const PhoneMatcher = () => {
            const [file1Data, setFile1Data] = useState(null);
            const [file2Data, setFile2Data] = useState(null);
            const [file1Columns, setFile1Columns] = useState([]);
            const [file2Columns, setFile2Columns] = useState([]);
            const [selectedColumn1, setSelectedColumn1] = useState('');
            const [selectedColumn2, setSelectedColumn2] = useState('');
            const [matches, setMatches] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [file1Name, setFile1Name] = useState('');
            const [file2Name, setFile2Name] = useState('');

            // 전화번호 정규화 함수 (숫자만 추출)
            const normalizePhone = (phone) => {
                if (!phone) return '';
                return String(phone).replace(/[^\d]/g, '');
            };

            // 파일 읽기 함수
            const handleFileUpload = (event, fileNumber) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) {
                            alert('파일에 데이터가 없습니다.');
                            return;
                        }

                        const columns = Object.keys(jsonData[0]);
                        
                        if (fileNumber === 1) {
                            setFile1Data(jsonData);
                            setFile1Columns(columns);
                            setFile1Name(file.name);
                        } else {
                            setFile2Data(jsonData);
                            setFile2Columns(columns);
                            setFile2Name(file.name);
                        }
                    } catch (error) {
                        alert('파일을 읽는 중 오류가 발생했습니다: ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // 전화번호 매칭 실행
            const findMatches = () => {
                if (!file1Data || !file2Data || !selectedColumn1 || !selectedColumn2) {
                    alert('모든 파일과 컬럼을 선택해주세요.');
                    return;
                }

                setIsProcessing(true);
                
                setTimeout(() => {
                    const matchedResults = [];
                    
                    file1Data.forEach((row1, index1) => {
                        const phone1 = normalizePhone(row1[selectedColumn1]);
                        if (!phone1) return;
                        
                        file2Data.forEach((row2, index2) => {
                            const phone2 = normalizePhone(row2[selectedColumn2]);
                            if (!phone2) return;
                            
                            if (phone1 === phone2) {
                                matchedResults.push({
                                    id: matchedResults.length + 1,
                                    phone: phone1,
                                    file1_row: index1 + 1,
                                    file2_row: index2 + 1,
                                    file1_data: row1,
                                    file2_data: row2,
                                    original_phone1: row1[selectedColumn1],
                                    original_phone2: row2[selectedColumn2]
                                });
                            }
                        });
                    });

                    setMatches(matchedResults);
                    setIsProcessing(false);
                    
                    if (matchedResults.length === 0) {
                        alert('일치하는 전화번호가 없습니다.');
                    } else {
                        alert(`${matchedResults.length}개의 일치하는 전화번호를 찾았습니다!`);
                    }
                }, 100);
            };

            // 결과 다운로드
            const downloadResults = () => {
                if (matches.length === 0) {
                    alert('다운로드할 결과가 없습니다.');
                    return;
                }

                try {
                    // 결과 데이터 준비
                    const exportData = matches.map(match => {
                        const result = {
                            '순번': match.id,
                            '매칭된_전화번호': match.original_phone1,
                            '파일1_행번호': match.file1_row,
                            '파일2_행번호': match.file2_row,
                        };

                        // 파일1 데이터 추가
                        Object.keys(match.file1_data).forEach(key => {
                            result[`파일1_${key}`] = match.file1_data[key];
                        });

                        // 파일2 데이터 추가
                        Object.keys(match.file2_data).forEach(key => {
                            result[`파일2_${key}`] = match.file2_data[key];
                        });

                        return result;
                    });

                    // Excel 파일 생성
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '매칭결과');

                    // 파일 다운로드
                    const fileName = `전화번호_매칭결과_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    alert('Excel 파일이 다운로드되었습니다!');
                } catch (error) {
                    alert('파일 다운로드 중 오류가 발생했습니다: ' + error.message);
                }
            };

            return h('div', { className: "max-w-6xl mx-auto p-6 bg-white min-h-screen" },
                // 헤더
                h('div', { className: "mb-8" },
                    h('h1', { className: "text-3xl font-bold text-gray-900 mb-2" }, '전화번호 매칭 프로그램'),
                    h('p', { className: "text-gray-600" }, '두 개의 엑셀 파일에서 동일한 전화번호를 찾아 매칭 결과를 제공합니다.')
                ),

                // 파일 업로드 섹션
                h('div', { className: "grid md:grid-cols-2 gap-6 mb-8" },
                    // 파일 1 업로드
                    h('div', { className: "border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-400 transition-colors" },
                        h('div', { className: "text-center" },
                            h(UploadIcon, { className: "mx-auto text-gray-400 mb-4 icon-large" }),
                            h('label', { className: "block cursor-pointer" },
                                h('span', { className: "text-lg font-medium text-gray-700 mb-2 block" }, '첫 번째 엑셀 파일'),
                                h('input', {
                                    type: "file",
                                    accept: ".xlsx,.xls",
                                    onChange: (e) => handleFileUpload(e, 1),
                                    className: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                })
                            ),
                            file1Name && h('p', { className: "mt-2 text-sm text-green-600 flex items-center justify-center" },
                                h(FileTextIcon, { className: "mr-1 icon-small" }),
                                file1Name + ' 업로드 완료'
                            )
                        )
                    ),

                    // 파일 2 업로드
                    h('div', { className: "border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-400 transition-colors" },
                        h('div', { className: "text-center" },
                            h(UploadIcon, { className: "mx-auto text-gray-400 mb-4 icon-large" }),
                            h('label', { className: "block cursor-pointer" },
                                h('span', { className: "text-lg font-medium text-gray-700 mb-2 block" }, '두 번째 엑셀 파일'),
                                h('input', {
                                    type: "file",
                                    accept: ".xlsx,.xls",
                                    onChange: (e) => handleFileUpload(e, 2),
                                    className: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                })
                            ),
                            file2Name && h('p', { className: "mt-2 text-sm text-green-600 flex items-center justify-center" },
                                h(FileTextIcon, { className: "mr-1 icon-small" }),
                                file2Name + ' 업로드 완료'
                            )
                        )
                    )
                ),

                // 컬럼 선택 섹션
                (file1Columns.length > 0 || file2Columns.length > 0) && h('div', { className: "bg-gray-50 rounded-lg p-6 mb-8" },
                    h('h2', { className: "text-xl font-semibold mb-4 flex items-center" },
                        h(PhoneIcon, { className: "mr-2 icon-medium" }),
                        '전화번호 컬럼 선택'
                    ),
                    h('div', { className: "grid md:grid-cols-2 gap-4" },
                        file1Columns.length > 0 && h('div', null,
                            h('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, '첫 번째 파일 - 전화번호 컬럼'),
                            h('select', {
                                value: selectedColumn1,
                                onChange: (e) => setSelectedColumn1(e.target.value),
                                className: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            },
                                h('option', { value: "" }, '컬럼을 선택하세요'),
                                ...file1Columns.map(col => h('option', { key: col, value: col }, col))
                            )
                        ),

                        file2Columns.length > 0 && h('div', null,
                            h('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, '두 번째 파일 - 전화번호 컬럼'),
                            h('select', {
                                value: selectedColumn2,
                                onChange: (e) => setSelectedColumn2(e.target.value),
                                className: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            },
                                h('option', { value: "" }, '컬럼을 선택하세요'),
                                ...file2Columns.map(col => h('option', { key: col, value: col }, col))
                            )
                        )
                    ),

                    h('button', {
                        onClick: findMatches,
                        disabled: !file1Data || !file2Data || !selectedColumn1 || !selectedColumn2 || isProcessing,
                        className: "mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center transition-colors"
                    },
                        h(SearchIcon, { className: "mr-2 icon-small" }),
                        isProcessing ? '매칭 중...' : '매칭 시작'
                    )
                ),

                // 결과 섹션
                matches.length > 0 && h('div', { className: "bg-white border rounded-lg shadow-sm" },
                    h('div', { className: "p-4 border-b bg-green-50" },
                        h('div', { className: "flex justify-between items-center" },
                            h('h2', { className: "text-xl font-semibold text-green-800" }, `매칭 결과: ${matches.length}건 발견`),
                            h('button', {
                                onClick: downloadResults,
                                className: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center transition-colors"
                            },
                                h(DownloadIcon, { className: "mr-2 icon-small" }),
                                'Excel 다운로드'
                            )
                        )
                    ),

                    h('div', { className: "overflow-x-auto" },
                        h('table', { className: "min-w-full divide-y divide-gray-200" },
                            h('thead', { className: "bg-gray-50" },
                                h('tr', null,
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '순번'),
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '전화번호'),
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '파일1 행'),
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '파일2 행'),
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '파일1 데이터'),
                                    h('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, '파일2 데이터')
                                )
                            ),
                            h('tbody', { className: "bg-white divide-y divide-gray-200" },
                                ...matches.slice(0, 100).map(match =>
                                    h('tr', { key: match.id, className: "hover:bg-gray-50" },
                                        h('td', { className: "px-4 py-3 text-sm text-gray-900" }, match.id),
                                        h('td', { className: "px-4 py-3 text-sm text-blue-600 font-medium" }, match.original_phone1),
                                        h('td', { className: "px-4 py-3 text-sm text-gray-900" }, match.file1_row),
                                        h('td', { className: "px-4 py-3 text-sm text-gray-900" }, match.file2_row),
                                        h('td', { className: "px-4 py-3 text-sm text-gray-600 max-w-xs" },
                                            h('div', { className: "truncate" },
                                                ...Object.entries(match.file1_data).slice(0, 3).map(([key, value]) =>
                                                    h('div', { key: key, className: "text-xs" }, `${key}: ${value}`)
                                                )
                                            )
                                        ),
                                        h('td', { className: "px-4 py-3 text-sm text-gray-600 max-w-xs" },
                                            h('div', { className: "truncate" },
                                                ...Object.entries(match.file2_data).slice(0, 3).map(([key, value]) =>
                                                    h('div', { key: key, className: "text-xs" }, `${key}: ${value}`)
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    matches.length > 100 && h('div', { className: "p-4 bg-yellow-50 border-t" },
                        h('div', { className: "flex items-center text-yellow-800" },
                            h(AlertCircleIcon, { className: "mr-2 icon-small" }),
                            '처음 100건만 표시됩니다. 전체 결과를 보려면 Excel 파일을 다운로드하세요.'
                        )
                    )
                ),

                // 사용 안내
                h('div', { className: "mt-8 bg-blue-50 rounded-lg p-4" },
                    h('h3', { className: "font-semibold text-blue-800 mb-2" }, '사용 방법:'),
                    h('ol', { className: "text-blue-700 text-sm space-y-1 list-decimal list-inside" },
                        h('li', null, '두 개의 엑셀 파일을 각각 업로드하세요.'),
                        h('li', null, '각 파일에서 전화번호가 들어있는 컬럼을 선택하세요.'),
                        h('li', null, '\'매칭 시작\' 버튼을 클릭하여 동일한 전화번호를 찾으세요.'),
                        h('li', null, '결과를 확인하고 필요시 Excel 파일로 다운로드하세요.')
                    ),
                    h('p', { className: "text-blue-600 text-xs mt-2" },
                        '* 전화번호는 하이픈, 공백, 괄호 등을 제거한 숫자만으로 비교됩니다.'
                    )
                )
            );
        };

        // 앱 렌더링
        ReactDOM.render(React.createElement(PhoneMatcher), document.getElementById('root'));
    </script>
</body>
</html>