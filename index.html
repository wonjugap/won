<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>더불어민주당 원주갑 당원관리 시스템 - 사용자용</title>
    
    <!-- 외부 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        
        // Firebase 프로젝트 설정 (관리자용과 동일)
        const firebaseConfig = {
            apiKey: "AIzaSyAFAsd9XBblWD1G2vVrP48T9IQqwWoDZro",
            authDomain: "wonju-minjoo-member-system.firebaseapp.com",
            projectId: "wonju-minjoo-member-system",
            storageBucket: "wonju-minjoo-member-system.firebasestorage.app",
            messagingSenderId: "227156177261",
            appId: "1:227156177261:web:9f37ea54dab14265c2aa64"
        };

        let app, db;
        let isFirebaseReady = false;
        
        // Firebase 초기화
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // 연결 테스트
                const testRef = doc(db, 'system', 'connectionTest');
                await setDoc(testRef, { 
                    timestamp: new Date().toISOString(),
                    status: 'user_connection_test'
                }, { merge: true });
                
                console.log('✅ Firebase 연결 성공');
                isFirebaseReady = true;
                
                // Firebase 상태를 전역으로 노출
                window.isFirebaseReady = true;
                
                // Firebase 함수들을 전역으로 노출
                window.firebaseApp = app;
                window.firebaseDB = db;
                window.firebaseUtils = { getDoc, getDocs, setDoc, updateDoc, deleteDoc, doc, collection };
                
                updateConnectionStatus(true);
                defineFirebaseFunctions();
                
            } catch (error) {
                console.error('❌ Firebase 초기화 실패:', error);
                isFirebaseReady = false;
                window.isFirebaseReady = false;
                updateConnectionStatus(false);
                
                setTimeout(() => {
                    alert('⚠️ Firebase 연결에 실패했습니다.\n\n• 인터넷 연결을 확인해주세요\n• 관리자에게 문의하세요\n\n이 시스템은 서버 연결이 필요합니다.');
                }, 1000);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (connected) {
                    statusEl.innerHTML = '<span style="color: #28a745;">🟢 서버 연결됨</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #dc3545;">🔴 서버 연결 실패</span>';
                }
            }
        }
        
        function defineFirebaseFunctions() {
            // 사용자 인증
            window.authenticateUser = async function(username, password) {
                try {
                    const usersDoc = await getDoc(doc(db, 'system', 'users'));
                    if (!usersDoc.exists()) {
                        throw new Error('사용자 데이터를 찾을 수 없습니다. 관리자에게 문의하세요.');
                    }
                    
                    const userData = usersDoc.data();
                    if (!userData.users || !userData.users[username]) {
                        throw new Error('존재하지 않는 사용자입니다.');
                    }
                    
                    const user = userData.users[username];
                    if (user.password !== password) {
                        throw new Error('비밀번호가 올바르지 않습니다.');
                    }
                    
                    return {
                        username: username,
                        permissions: user.permissions,
                        lastSync: userData.lastSync
                    };
                } catch (error) {
                    console.error('인증 오류:', error);
                    throw error;
                }
            };
            
            // 당원 데이터 로드
            window.loadMemberData = async function() {
                try {
                    const statusEl = document.getElementById('loadingStatus');
                    if (statusEl) statusEl.textContent = '당원 데이터를 불러오는 중...';
                    
                    // 메타데이터 확인
                    const metaDoc = await getDoc(doc(db, 'memberData', 'metadata'));
                    
                    if (metaDoc.exists()) {
                        const metaData = metaDoc.data();
                        
                        if (metaData.syncVersion === '3.0') {
                            // 새 청크 기반 형식
                            return await loadChunkedData(metaData);
                        } else {
                            // 구 형식 시도
                            return await loadLegacyData();
                        }
                    } else {
                        // 구 형식 시도
                        return await loadLegacyData();
                    }
                } catch (error) {
                    console.error('데이터 로드 오류:', error);
                    throw new Error('당원 데이터를 불러올 수 없습니다. 관리자에게 문의하세요.');
                }
            };
            
            async function loadChunkedData(metaData) {
                const chunkPromises = [];
                for (let i = 0; i < metaData.totalChunks; i++) {
                    chunkPromises.push(getDoc(doc(db, 'memberData', `chunk_${i}`)));
                }
                
                const chunkDocs = await Promise.all(chunkPromises);
                let allMembers = [];
                
                chunkDocs.forEach((chunkDoc) => {
                    if (chunkDoc.exists()) {
                        const chunkData = chunkDoc.data();
                        if (chunkData.members) {
                            allMembers = allMembers.concat(chunkData.members);
                        }
                    }
                });
                
                return {
                    members: allMembers,
                    columnSettings: metaData.columnSettings,
                    headers: metaData.headers,
                    lastSync: metaData.lastSync,
                    totalMembers: allMembers.length
                };
            }
            
            async function loadLegacyData() {
                const legacyDoc = await getDoc(doc(db, 'system', 'memberData'));
                if (legacyDoc.exists()) {
                    const data = legacyDoc.data();
                    return {
                        members: data.members || [],
                        columnSettings: data.columnSettings,
                        headers: data.headers,
                        lastSync: data.lastSync,
                        totalMembers: data.members ? data.members.length : 0
                    };
                } else {
                    throw new Error('당원 데이터가 없습니다.');
                }
            }
        }
        
        // 페이지 로드 시 Firebase 초기화
        initializeFirebase();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 15px;
            left: 20px;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .login-screen {
            max-width: 450px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .main-app {
            display: none;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
        }

        .tab-btn:hover {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .tab-btn.active {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .tab-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .welcome-message {
            background: linear-gradient(135deg, #d4f8d4 0%, #a8e6a8 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }

        .welcome-message h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #155724;
            line-height: 1.6;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
        }

        .results-area {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-header {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .member-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .member-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .member-item.duplicate {
            border-left-color: #dc3545;
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.05) 0%, rgba(248, 249, 250, 1) 10%);
        }

        .member-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .member-details {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 50px;
            font-style: italic;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .permission-notice {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: #856404;
        }

        .phone-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .phone-btn {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid;
        }

        .call-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        .call-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #17a085);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .sms-btn {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            border-color: #007bff;
        }

        .sms-btn:hover {
            background: linear-gradient(135deg, #0056b3, #520dc2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .nav-tabs {
                padding: 5px;
            }
            
            .tab-btn {
                padding: 10px 5px;
                font-size: 0.9em;
                min-width: 100px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            .phone-btn {
                padding: 8px 14px;
                font-size: 0.9em;
                min-width: 90px;
                text-align: center;
            }
            
            .phone-actions {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        🟡 서버 연결 중...
    </div>
    
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo" style="display: none;"></div>
            <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">🚪 로그아웃</button>
            <h2>더불어민주당 원주갑지역위원회</h2>
            <p>당원관리 시스템 - 사용자용</p>
        </div>

        <!-- 로그인 화면 -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #495057;">사용자 로그인</h2>
                
               <div class="permission-notice">
                    <h4 style="margin-bottom: 10px;">👤 사용자 시스템 안내</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>ID와 비밀번호를 입력하세요</li>
                        <li>ID와 비밀번호는 관리자에게 문의하세요</li>
                     </ul>
                </div>
                
                <div class="form-group">
                    <label for="username">사용자 ID</label>
                    <input type="text" id="username" class="form-control" placeholder="ID를 입력하세요">
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" class="form-control" placeholder="비밀번호를 입력하세요">
                </div>
                <button onclick="login()" class="btn btn-success" style="width: 100%;">로그인</button>
                
                <div id="loadingStatus" style="margin-top: 15px; text-align: center; color: #6c757d; display: none;">
                    로그인 중...
                </div>
            </div>
        </div>

        <!-- 메인 애플리케이션 -->
        <div id="mainApp" class="main-app">
            <div class="nav-tabs" id="navTabs">
                <!-- 권한에 따라 동적으로 생성됨 -->
            </div>

            <div class="tab-content">
                <!-- 생일 검색 탭 -->
                <div id="birthdaySearch" class="tab-pane">
                    <h3>🎂 생일 검색</h3>
                    
                    <div class="filter-section">
                        <div class="filter-row">
                            <div>
                                <label><strong>검색 날짜</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="dateOption" value="today" checked onchange="toggleDateOptions()"> 오늘 생일</label>
                                    <label><input type="radio" name="dateOption" value="specific" onchange="toggleDateOptions()"> 특정 날짜</label>
                                </div>
                                <input type="date" id="specificDate" class="form-control" style="display: none; margin-top: 10px;">
                            </div>
                            
                            <div>
                                <label><strong>연령대 필터</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="ageFilter" value="all" checked onchange="toggleAgeFilter()"> 전체</label>
                                    <label><input type="radio" name="ageFilter" value="specific" onchange="toggleAgeFilter()"> 특정 연령대</label>
                                </div>
                                <select id="ageRange" class="form-control" style="display: none; margin-top: 10px;">
                                    <option>10대</option>
                                    <option>20대</option>
                                    <option>30대</option>
                                    <option>40대</option>
                                    <option>50대</option>
                                    <option>60대</option>
                                    <option>70대</option>
                                    <option>80대 이상</option>
                                </select>
                            </div>
                            
                            <div>
                                <label><strong>지역 필터</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="dongFilter" value="all" checked onchange="toggleDongFilter()"> 전체</label>
                                    <label><input type="radio" name="dongFilter" value="specific" onchange="toggleDongFilter()"> 특정 지역</label>
                                </div>
                                <input type="text" id="specificDong" class="form-control" placeholder="읍면동 입력" style="display: none; margin-top: 10px;">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="searchBirthdays()" class="btn btn-primary">🔍 생일 검색</button>
                        </div>
                    </div>

                    <div id="birthdayResults" class="results-area">
                        <div class="loading-spinner">데이터를 불러오는 중...</div>
                    </div>
                </div>

                <!-- 당원 검색 탭 -->
                <div id="memberSearch" class="tab-pane">
                    <h3>👥 당원 검색</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">이름이나 전화번호로 당원을 검색하고 상세 정보를 확인할 수 있습니다.</p>
                    
                    <div class="filter-section">
                        <div class="filter-row">
                            <div>
                                <label><strong>이름으로 검색</strong></label>
                                <input type="text" id="searchByName" class="form-control" placeholder="당원 이름을 입력하세요" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">부분 검색 가능</small>
                            </div>
                            
                            <div>
                                <label><strong>전화번호로 검색</strong></label>
                                <input type="text" id="searchByPhone" class="form-control" placeholder="전화번호를 입력하세요" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">부분 검색 가능</small>
                            </div>
                            
                            <div>
                                <label><strong>지역으로 검색</strong></label>
                                <input type="text" id="searchByDong" class="form-control" placeholder="읍면동을 입력하세요" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">부분 검색 가능</small>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="searchMembersByInput()" class="btn btn-primary">🔍 당원 검색</button>
                            <button onclick="clearSearchInputs()" class="btn btn-secondary">🗑️ 검색 초기화</button>
                        </div>
                    </div>

                    <div id="memberSearchResults" class="results-area">
                        <div class="loading-spinner">데이터를 불러오는 중...</div>
                    </div>
                </div>

                <!-- 데이터 관리 탭 -->
                <div id="dataManage" class="tab-pane">
                    <h3>📝 데이터 관리</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">당원 정보를 추가하고 수정할 수 있습니다. (권한에 따라 제한)</p>
                    
                    <div class="permission-notice">
                        <h4>⚠️ 권한 안내</h4>
                        <p>데이터 관리 권한이 있는 사용자만 이 기능을 사용할 수 있습니다.</p>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button onclick="showAddModal()" class="btn btn-success">➕ 새 당원 추가</button>
                        <button onclick="showEditSearchModal()" class="btn btn-warning">✏️ 당원 정보 수정</button>
                    </div>

                    <div id="recentActivity" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>📋 최근 활동</h4>
                        <div id="activityLog">
                            <p style="color: #6c757d;">활동 내역이 여기에 표시됩니다.</p>
                        </div>
                    </div>
                </div>

                <!-- 통계 탭 -->
                <div id="statistics" class="tab-pane">
                    <h3>📊 통계 현황</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">당원 현황과 통계를 확인할 수 있습니다. (읽기 전용)</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalMembers">-</div>
                            <div class="stat-label">총 당원 수</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayBirthdays">-</div>
                            <div class="stat-label">오늘 생일자</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgAge">-</div>
                            <div class="stat-label">평균 연령</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreas">-</div>
                            <div class="stat-label">관리 지역 수</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h4 style="margin-bottom: 20px;">연령대별 분포</h4>
                        <canvas id="ageChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h4 style="margin-bottom: 20px;">지역별 분포</h4>
                        <canvas id="areaChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달들 -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMemberModal')">&times;</span>
            <h2>새 당원 추가</h2>
            <form id="addMemberForm">
                <div class="form-group">
                    <label>이름 *</label>
                    <input type="text" id="newMemberName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>생년월일 *</label>
                    <input type="date" id="newMemberDob" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>전화번호</label>
                    <input type="tel" id="newMemberPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label>읍면동</label>
                    <input type="text" id="newMemberDong" class="form-control">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" onclick="addNewMember()" class="btn btn-success">💾 추가</button>
                    <button type="button" onclick="closeModal('addMemberModal')" class="btn btn-secondary">❌ 취소</button>
                </div>
            </form>
        </div>
    </div>

    <div id="memberDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memberDetailModal')">&times;</span>
            <h2 id="memberDetailTitle">당원 상세 정보</h2>
            <div id="memberDetailContent"></div>
        </div>
    </div>

    <script>
        // 전역 변수들
        let currentUser = null;
        let memberData = null;
        let userPermissions = [];
        
        // Firebase 상태를 전역으로 초기화
        window.isFirebaseReady = false;
        
        // 유틸리티 함수들
function calculateAge(dob) {
    if (!dob) return 0;
    
    let birthDate;
    
    if (typeof dob === 'number') {
        // 엑셀 시리얼 날짜인 경우
        birthDate = new Date((dob - 25569) * 86400 * 1000);
    } else if (typeof dob === 'string') {
        // 문자열 날짜 처리
        const dateStr = dob.toString().replace(/[^\d]/g, '');
        if (dateStr.length === 8) {
            // YYYYMMDD 형식
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            birthDate = new Date(year, month - 1, day);
        } else if (dateStr.length === 6) {
            // YYMMDD 형식
            let year = parseInt(dateStr.substring(0, 2));
            year = year < 30 ? 2000 + year : 1900 + year;
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            birthDate = new Date(year, month - 1, day);
        } else {
            birthDate = new Date(dob);
        }
    } else {
        birthDate = new Date(dob);
    }
    
    if (isNaN(birthDate.getTime())) return 0;
    
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    return age;
}

        function getAgeGroup(age) {
            if (age < 20) return '10대';
            if (age < 30) return '20대';
            if (age < 40) return '30대';
            if (age < 50) return '40대';
            if (age < 60) return '50대';
            if (age < 70) return '60대';
            if (age < 80) return '70대';
            return '80대 이상';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('ko-KR');
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.replace(/[^\d]/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (cleaned.length === 10) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            return phone;
        }

        // 전화번호 액션 버튼 생성
        function createPhoneActionButtons(phone) {
            if (!phone) return '';
            
            const cleanPhone = phone.replace(/[^\d]/g, '');
            const formattedPhone = formatPhoneNumber(phone);
            
            // 전화번호가 유효하지 않은 경우
            if (cleanPhone.length < 10) {
                return `📞 전화번호: ${formattedPhone} <small style="color: #dc3545;">(유효하지 않은 번호)</small>`;
            }
            
            return `
                📞 전화번호: ${formattedPhone}
                <div class="phone-actions" onclick="event.stopPropagation();" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="tel:${cleanPhone}" class="phone-btn call-btn">📞 전화걸기</a>
                    <a href="sms:${cleanPhone}" class="phone-btn sms-btn">💬 문자보내기</a>
                </div>
            `;
        }

        // 모바일 감지
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

function isBirthday(dob, targetDate = new Date()) {
    if (!dob) return false;
    
    let birthDate;
    if (typeof dob === 'number') {
        birthDate = new Date((dob - 25569) * 86400 * 1000);
    } else {
        const dateStr = dob.toString().replace(/[^\d]/g, '');
        if (dateStr.length === 8) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            birthDate = new Date(year, month - 1, day);
        } else if (dateStr.length === 6) {
            let year = parseInt(dateStr.substring(0, 2));
            year = year < 30 ? 2000 + year : 1900 + year;
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            birthDate = new Date(year, month - 1, day);
        } else {
            birthDate = new Date(dob);
        }
    }
    
    if (isNaN(birthDate.getTime())) return false;
    
    return birthDate.getMonth() === targetDate.getMonth() && 
           birthDate.getDate() === targetDate.getDate();
}

        // 로그인 함수
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loadingStatus');

            if (!username || !password) {
                alert('사용자 ID와 비밀번호를 모두 입력하세요.');
                return;
            }

            if (!window.isFirebaseReady) {
                alert('서버 연결이 필요합니다. 잠시 후 다시 시도하세요.');
                return;
            }

            statusEl.style.display = 'block';
            statusEl.textContent = '로그인 중...';

            try {
                const authResult = await window.authenticateUser(username, password);
                currentUser = authResult;
                userPermissions = authResult.permissions;

                // 당원 데이터 로드
                statusEl.textContent = '당원 데이터를 불러오는 중...';
                memberData = await window.loadMemberData();

                // 로그인 성공
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfo').textContent = `${username}님 (${userPermissions.length}개 권한)`;
                document.getElementById('logoutBtn').style.display = 'block';

                // 권한에 따른 탭 생성
                createUserTabs();
                
                // 기본 탭 활성화
                const firstTab = document.querySelector('.tab-btn');
                if (firstTab) {
                    firstTab.click();
                }

                console.log('✅ 로그인 성공:', authResult);
                
            } catch (error) {
                console.error('로그인 실패:', error);
                alert(`로그인 실패: ${error.message}`);
            } finally {
                statusEl.style.display = 'none';
            }
        }

        // 권한에 따른 탭 생성
        function createUserTabs() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            const availableTabs = [
                { id: 'birthdaySearch', title: '🎂 생일 검색', permission: '2. 생일 검색' },
                { id: 'memberSearch', title: '👥 당원 검색', permission: '3. 당원 검색' },
                { id: 'dataManage', title: '📝 데이터 관리', permission: '4. 데이터 관리' },
                { id: 'statistics', title: '📊 통계 현황', permission: '5. 통계/설정' }
            ];

            let firstTabCreated = false;

            availableTabs.forEach(tab => {
                if (userPermissions.includes(tab.permission)) {
                    const tabBtn = document.createElement('button');
                    tabBtn.className = firstTabCreated ? 'tab-btn' : 'tab-btn active';
                    tabBtn.onclick = () => showTab(tab.id);
                    tabBtn.textContent = tab.title;
                    navTabs.appendChild(tabBtn);

                    if (!firstTabCreated) {
                        document.getElementById(tab.id).classList.add('active');
                        firstTabCreated = true;
                    }
                }
            });

            if (!firstTabCreated) {
                navTabs.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">사용 가능한 권한이 없습니다. 관리자에게 문의하세요.</div>';
            }
        }

        // 탭 전환
        function showTab(tabName) {
            // 모든 탭 숨기기
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 선택된 탭 보이기
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // 탭별 초기화
            if (tabName === 'birthdaySearch') {
                initializeBirthdaySearch();
            } else if (tabName === 'memberSearch') {
                initializeMemberSearch();
            } else if (tabName === 'statistics') {
                refreshStats();
            }
        }

        // 생일 검색 초기화
        function initializeBirthdaySearch() {
            const resultsEl = document.getElementById('birthdayResults');
            if (!memberData) {
                resultsEl.innerHTML = '<div class="no-data">데이터를 불러오는 중입니다...</div>';
                return;
            }
            resultsEl.innerHTML = '<div class="no-data">검색 조건을 설정하고 검색 버튼을 클릭하세요.</div>';
        }

        // 당원 검색 초기화
        function initializeMemberSearch() {
            const resultsEl = document.getElementById('memberSearchResults');
            if (!memberData) {
                resultsEl.innerHTML = '<div class="no-data">데이터를 불러오는 중입니다...</div>';
                return;
            }
            resultsEl.innerHTML = '<div class="no-data">이름, 전화번호 또는 지역을 입력하고 검색해주세요.</div>';
        }

        // 검색 기능들
        function toggleDateOptions() {
            const specificDate = document.getElementById('specificDate');
            const dateOption = document.querySelector('input[name="dateOption"]:checked').value;
            
            if (dateOption === 'specific') {
                specificDate.style.display = 'block';
                specificDate.value = new Date().toISOString().split('T')[0];
            } else {
                specificDate.style.display = 'none';
            }
        }

        function toggleAgeFilter() {
            const ageRange = document.getElementById('ageRange');
            const ageFilter = document.querySelector('input[name="ageFilter"]:checked').value;
            
            ageRange.style.display = ageFilter === 'specific' ? 'block' : 'none';
        }

        function toggleDongFilter() {
            const specificDong = document.getElementById('specificDong');
            const dongFilter = document.querySelector('input[name="dongFilter"]:checked').value;
            
            specificDong.style.display = dongFilter === 'specific' ? 'block' : 'none';
        }

        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchMembersByInput();
            }
        }

        function clearSearchInputs() {
            document.getElementById('searchByName').value = '';
            document.getElementById('searchByPhone').value = '';
            document.getElementById('searchByDong').value = '';
            initializeMemberSearch();
        }

        // 생일 검색
        function searchBirthdays() {
            if (!memberData || !memberData.members) {
                alert('데이터가 로드되지 않았습니다.');
                return;
            }

            const dateOption = document.querySelector('input[name="dateOption"]:checked').value;
            const ageFilter = document.querySelector('input[name="ageFilter"]:checked').value;
            const dongFilter = document.querySelector('input[name="dongFilter"]:checked').value;
            
            let targetDate = new Date();
            if (dateOption === 'specific') {
                const specificDate = document.getElementById('specificDate').value;
                if (!specificDate) {
                    alert('특정 날짜를 선택해주세요.');
                    return;
                }
                targetDate = new Date(specificDate);
            }
            
            const selectedAgeRange = ageFilter === 'specific' ? document.getElementById('ageRange').value : null;
            const selectedDong = dongFilter === 'specific' ? document.getElementById('specificDong').value.trim() : null;
            
            let results = [];
            
            memberData.members.forEach(member => {
                if (!member.name || !member.name.trim()) return;
                
                if (!isBirthday(member.dob, targetDate)) return;
                
                const age = calculateAge(member.dob);
                const ageGroup = getAgeGroup(age);
                
                if (selectedAgeRange && ageGroup !== selectedAgeRange) return;
                
                if (selectedDong && !member.dong.toString().includes(selectedDong)) return;
                
                results.push({
                    name: member.name,
                    dob: member.dob,
                    phone: member.phone || '',
                    dong: member.dong || '',
                    age,
                    ageGroup
                });
            });
            
            displaySearchResults(results, 'birthdayResults', '🎂 생일자 검색 결과', targetDate);
        }

        // 당원 검색
        function searchMembersByInput() {
            if (!memberData || !memberData.members) {
                alert('데이터가 로드되지 않았습니다.');
                return;
            }

            const searchName = document.getElementById('searchByName').value.trim();
            const searchPhone = document.getElementById('searchByPhone').value.trim().replace(/[^\d]/g, '');
            const searchDong = document.getElementById('searchByDong').value.trim();

            if (!searchName && !searchPhone && !searchDong) {
                alert('이름, 전화번호 또는 지역 중 하나 이상을 입력해주세요.');
                return;
            }

            let results = [];
            const duplicateTracker = {};

            memberData.members.forEach((member, index) => {
                if (!member.name || !member.name.trim()) return;

                const name = member.name.toString();
                const phone = (member.phone || '').toString().replace(/[^\d]/g, '');
                const dong = (member.dong || '').toString();

                let matches = false;

                if (searchName && name.includes(searchName)) matches = true;
                if (searchPhone && phone.includes(searchPhone)) matches = true;
                if (searchDong && dong.includes(searchDong)) matches = true;

                if (matches) {
                    const age = calculateAge(member.dob);
                    const ageGroup = getAgeGroup(age);
                    
                    const key = `${name}_${phone}_${dong}`;
                    
                    if (!duplicateTracker[key]) {
                        duplicateTracker[key] = [];
                    }
                    
                    duplicateTracker[key].push({
                        index,
                        name,
                        dob: member.dob,
                        phone: member.phone || '',
                        dong: member.dong || '',
                        age,
                        ageGroup
                    });
                }
            });

            const groupedResults = [];
            Object.keys(duplicateTracker).forEach(key => {
                const group = duplicateTracker[key];
                groupedResults.push({
                    key: key,
                    count: group.length,
                    members: group,
                    representative: group[0]
                });
            });

            displayGroupedSearchResults(groupedResults, 'memberSearchResults', '👥 당원 검색 결과');
        }

        // 검색 결과 표시
        function displaySearchResults(results, containerId, title, targetDate = null) {
            const container = document.getElementById(containerId);
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-data">검색 조건에 맞는 당원이 없습니다.</div>';
                return;
            }
            
            let html = `<div class="results-header">${title} (${results.length}명)</div>`;
            
            if (targetDate) {
                html += `<div style="text-align: center; margin-bottom: 15px; color: #666;">
                    검색 날짜: ${targetDate.toLocaleDateString('ko-KR')}
                </div>`;
            }
            
            results.forEach(member => {
                const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';
                
                html += `
                    <div class="member-item" onclick="showMemberDetail(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                        <div class="member-name">${member.name}</div>
                        <div class="member-details">
                            🎂 생년월일: ${formatDate(member.dob)} (${member.age}세, ${member.ageGroup})<br>
                            ${phoneHtml}
                            ${member.dong ? `🏠 읍면동: ${member.dong}<br>` : ''}
                            <small style="color: #666;">👆 클릭하여 상세 정보 보기</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            window.lastSearchResults = results;
            window.lastSearchTitle = title;
        }

        function displayGroupedSearchResults(groupedResults, containerId, title) {
            const container = document.getElementById(containerId);
            
            if (groupedResults.length === 0) {
                container.innerHTML = '<div class="no-data">검색 조건에 맞는 당원이 없습니다.</div>';
                return;
            }

            let totalMembers = 0;
            groupedResults.forEach(group => totalMembers += group.count);

            let html = `<div class="results-header">${title} (${groupedResults.length}개 그룹, 총 ${totalMembers}명)</div>`;

            groupedResults.forEach((group, groupIndex) => {
                const rep = group.representative;
                const isDuplicate = group.count > 1;
                const phoneHtml = rep.phone ? createPhoneActionButtons(rep.phone) : '';
                
                html += `
                    <div class="member-item ${isDuplicate ? 'duplicate' : ''}" onclick="showMemberGroup(${groupIndex})">
                        <div class="member-name">
                            ${rep.name} 
                            ${isDuplicate ? `<span style="color: #dc3545; font-weight: bold;">(${group.count}명 중복)</span>` : ''}
                        </div>
                        <div class="member-details">
                            🎂 나이: ${rep.age}세 (${rep.ageGroup})<br>
                            ${phoneHtml}
                            ${rep.dong ? `🏠 주소: ${rep.dong}<br>` : ''}
                            ${isDuplicate ? '<small style="color: #dc3545;">⚠️ 클릭하여 중복 데이터 확인</small>' : '<small style="color: #666;">👆 클릭하여 상세 정보 보기</small>'}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            window.lastGroupedResults = groupedResults;
            
            // 내보내기용 결과도 준비
            window.lastSearchResults = [];
            groupedResults.forEach(group => {
                group.members.forEach(member => {
                    window.lastSearchResults.push(member);
                });
            });
            window.lastSearchTitle = title;
        }

        // 통계 새로고침
        function refreshStats() {
            if (!memberData || !memberData.members) {
                document.getElementById('totalMembers').textContent = '-';
                document.getElementById('todayBirthdays').textContent = '-';
                document.getElementById('avgAge').textContent = '-';
                document.getElementById('totalAreas').textContent = '-';
                return;
            }

            let totalMembers = 0;
            let todayBirthdays = 0;
            let totalAge = 0;
            let validAges = 0;
            const areas = new Set();
            const ageGroups = {};
            const dongCounts = {};
            
            const today = new Date();
            
            memberData.members.forEach(member => {
                if (!member.name || !member.name.trim()) return;
                
                totalMembers++;
                
                const age = calculateAge(member.dob);
                if (age > 0) {
                    totalAge += age;
                    validAges++;
                    
                    const ageGroup = getAgeGroup(age);
                    ageGroups[ageGroup] = (ageGroups[ageGroup] || 0) + 1;
                }
                
                if (isBirthday(member.dob, today)) {
                    todayBirthdays++;
                }
                
                if (member.dong && member.dong.toString().trim()) {
                    areas.add(member.dong.toString().trim());
                    dongCounts[member.dong.toString().trim()] = (dongCounts[member.dong.toString().trim()] || 0) + 1;
                }
            });
            
            document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
            document.getElementById('todayBirthdays').textContent = todayBirthdays.toLocaleString();
            document.getElementById('avgAge').textContent = validAges > 0 ? Math.round(totalAge / validAges) : 0;
            document.getElementById('totalAreas').textContent = areas.size;
            
            updateAgeChart(ageGroups);
            updateAreaChart(dongCounts);
        }

        function updateAgeChart(ageGroups) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            
            if (window.ageChartInstance) {
                window.ageChartInstance.destroy();
            }
            
            const labels = ['10대', '20대', '30대', '40대', '50대', '60대', '70대', '80대 이상'];
            const data = labels.map(label => ageGroups[label] || 0);
            
            window.ageChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '당원 수',
                        data: data,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(102, 16, 242, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateAreaChart(dongCounts) {
            const ctx = document.getElementById('areaChart').getContext('2d');
            
            if (window.areaChartInstance) {
                window.areaChartInstance.destroy();
            }
            
            const sortedDongs = Object.entries(dongCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedDongs.map(item => item[0]);
            const data = sortedDongs.map(item => item[1]);
            
            window.areaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(102, 16, 242, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)',
                            'rgba(255, 99, 255, 0.8)',
                            'rgba(99, 255, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 모달 관련 함수들
        function showAddModal() {
            document.getElementById('addMemberModal').style.display = 'block';
        }

        function showEditSearchModal() {
            alert('구현 중인 기능입니다. 당원 검색 탭에서 수정할 당원을 찾아 클릭하세요.');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMemberDetail(member) {
            const modal = document.getElementById('memberDetailModal');
            const title = document.getElementById('memberDetailTitle');
            const content = document.getElementById('memberDetailContent');

            const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';

            title.textContent = `${member.name}님의 상세 정보`;
            content.innerHTML = `
                <div style="padding: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;"><strong>이름:</strong> ${member.name}</div>
                        <div style="margin-bottom: 10px;"><strong>생년월일:</strong> ${formatDate(member.dob)}</div>
                        <div style="margin-bottom: 15px;"><strong>나이:</strong> ${member.age}세 (${member.ageGroup})</div>
                        ${member.phone ? `<div style="margin-bottom: 15px;">${phoneHtml}</div>` : ''}
                        ${member.dong ? `<div><strong>주소:</strong> ${member.dong}</div>` : ''}
                    </div>
                    ${isMobile() ? '<div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 8px; color: #0c5460; font-size: 0.9em;"><strong>💡 팁:</strong> 전화걸기 및 문자보내기 버튼을 터치하여 바로 연락할 수 있습니다.</div>' : ''}
                </div>
            `;

            modal.style.display = 'block';
        }

        function showMemberGroup(groupIndex) {
            const group = window.lastGroupedResults[groupIndex];
            if (!group) return;

            const modal = document.getElementById('memberDetailModal');
            const title = document.getElementById('memberDetailTitle');
            const content = document.getElementById('memberDetailContent');

            if (group.count === 1) {
                showMemberDetail(group.representative);
            } else {
                title.textContent = `${group.representative.name}님 - 중복 데이터 (${group.count}명)`;
                let duplicateHtml = `
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #dc3545;">⚠️ 중복된 데이터가 발견되었습니다</strong>
                        </div>
                `;

                group.members.forEach((member, index) => {
                    const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';
                    
                    duplicateHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #dc3545;">
                            <div style="margin-bottom: 10px;"><strong>데이터 ${index + 1}</strong></div>
                            <div style="margin-bottom: 5px;"><strong>이름:</strong> ${member.name}</div>
                            <div style="margin-bottom: 5px;"><strong>생년월일:</strong> ${formatDate(member.dob)}</div>
                            <div style="margin-bottom: 10px;"><strong>나이:</strong> ${member.age}세</div>
                            ${member.phone ? `<div style="margin-bottom: 10px;">${phoneHtml}</div>` : ''}
                            ${member.dong ? `<div style="margin-bottom: 10px;"><strong>주소:</strong> ${member.dong}</div>` : ''}
                        </div>
                    `;
                });

                duplicateHtml += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; color: #856404;">
                            <strong>💡 권장사항:</strong><br>
                            • 관리자에게 중복 데이터 정리를 요청하세요<br>
                            • 정확한 정보를 확인하여 중복을 해결하세요
                        </div>
                        ${isMobile() ? '<div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 8px; color: #0c5460; font-size: 0.9em;"><strong>💡 팁:</strong> 전화걸기 및 문자보내기 버튼을 터치하여 바로 연락할 수 있습니다.</div>' : ''}
                    </div>
                `;
                content.innerHTML = duplicateHtml;
                modal.style.display = 'block';
            }
        }

        // 결과 내보내기
        function exportResults(type) {
            const results = window.lastSearchResults;
            const title = window.lastSearchTitle;
            
            if (!results || results.length === 0) {
                alert('내보낼 검색 결과가 없습니다.');
                return;
            }
            
            const exportData = results.map(member => ({
                이름: member.name,
                생년월일: formatDate(member.dob),
                나이: member.age,
                연령대: member.ageGroup,
                전화번호: member.phone || '',
                읍면동: member.dong || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '검색결과');
            
            const fileName = `${title.replace(/[^\w가-힣]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`${fileName} 파일이 다운로드되었습니다.`);
        }

        function printResults(type) {
            const results = window.lastSearchResults;
            const title = window.lastSearchTitle;
            
            if (!results || results.length === 0) {
                alert('인쇄할 검색 결과가 없습니다.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            let html = `
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .print-date { text-align: center; color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="print-date">인쇄일: ${new Date().toLocaleDateString('ko-KR')} | 사용자: ${currentUser.username}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>이름</th>
                                <th>생년월일</th>
                                <th>나이</th>
                                <th>연령대</th>
                                <th>전화번호</th>
                                <th>읍면동</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach((member, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${member.name}</td>
                        <td>${formatDate(member.dob)}</td>
                        <td>${member.age}세</td>
                        <td>${member.ageGroup}</td>
                        <td>${member.phone || ''}</td>
                        <td>${member.dong || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                currentUser = null;
                memberData = null;
                userPermissions = [];
                
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        // Enter 키 로그인
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>
