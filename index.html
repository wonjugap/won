<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ ì›ì£¼ê°‘ ë‹¹ì›ê´€ë¦¬ ì‹œìŠ¤í…œ - ì‚¬ìš©ììš©</title>
    
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        
        // Firebase í”„ë¡œì íŠ¸ ì„¤ì • (ê´€ë¦¬ììš©ê³¼ ë™ì¼)
        const firebaseConfig = {
            apiKey: "AIzaSyAFAsd9XBblWD1G2vVrP48T9IQqwWoDZro",
            authDomain: "wonju-minjoo-member-system.firebaseapp.com",
            projectId: "wonju-minjoo-member-system",
            storageBucket: "wonju-minjoo-member-system.firebasestorage.app",
            messagingSenderId: "227156177261",
            appId: "1:227156177261:web:9f37ea54dab14265c2aa64"
        };

        let app, db;
        let isFirebaseReady = false;
        
        // Firebase ì´ˆê¸°í™”
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // ì—°ê²° í…ŒìŠ¤íŠ¸
                const testRef = doc(db, 'system', 'connectionTest');
                await setDoc(testRef, { 
                    timestamp: new Date().toISOString(),
                    status: 'user_connection_test'
                }, { merge: true });
                
                console.log('âœ… Firebase ì—°ê²° ì„±ê³µ');
                isFirebaseReady = true;
                
                // Firebase ìƒíƒœë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
                window.isFirebaseReady = true;
                
                // Firebase í•¨ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
                window.firebaseApp = app;
                window.firebaseDB = db;
                window.firebaseUtils = { getDoc, getDocs, setDoc, updateDoc, deleteDoc, doc, collection };
                
                updateConnectionStatus(true);
                defineFirebaseFunctions();
                
            } catch (error) {
                console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                isFirebaseReady = false;
                window.isFirebaseReady = false;
                updateConnectionStatus(false);
                
                setTimeout(() => {
                    alert('âš ï¸ Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nâ€¢ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”\nâ€¢ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”\n\nì´ ì‹œìŠ¤í…œì€ ì„œë²„ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }, 1000);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (connected) {
                    statusEl.innerHTML = '<span style="color: #28a745;">ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #dc3545;">ğŸ”´ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</span>';
                }
            }
        }
        
        function defineFirebaseFunctions() {
            // ì‚¬ìš©ì ì¸ì¦
            window.authenticateUser = async function(username, password) {
                try {
                    const usersDoc = await getDoc(doc(db, 'system', 'users'));
                    if (!usersDoc.exists()) {
                        throw new Error('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    }
                    
                    const userData = usersDoc.data();
                    if (!userData.users || !userData.users[username]) {
                        throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.');
                    }
                    
                    const user = userData.users[username];
                    if (user.password !== password) {
                        throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                    
                    return {
                        username: username,
                        permissions: user.permissions,
                        lastSync: userData.lastSync
                    };
                } catch (error) {
                    console.error('ì¸ì¦ ì˜¤ë¥˜:', error);
                    throw error;
                }
            };
            
            // ë‹¹ì› ë°ì´í„° ë¡œë“œ
            window.loadMemberData = async function() {
                try {
                    const statusEl = document.getElementById('loadingStatus');
                    if (statusEl) statusEl.textContent = 'ë‹¹ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                    
                    // ë©”íƒ€ë°ì´í„° í™•ì¸
                    const metaDoc = await getDoc(doc(db, 'memberData', 'metadata'));
                    
                    if (metaDoc.exists()) {
                        const metaData = metaDoc.data();
                        
                        if (metaData.syncVersion === '3.0') {
                            // ìƒˆ ì²­í¬ ê¸°ë°˜ í˜•ì‹
                            return await loadChunkedData(metaData);
                        } else {
                            // êµ¬ í˜•ì‹ ì‹œë„
                            return await loadLegacyData();
                        }
                    } else {
                        // êµ¬ í˜•ì‹ ì‹œë„
                        return await loadLegacyData();
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    throw new Error('ë‹¹ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }
            };
            
            async function loadChunkedData(metaData) {
                const chunkPromises = [];
                for (let i = 0; i < metaData.totalChunks; i++) {
                    chunkPromises.push(getDoc(doc(db, 'memberData', `chunk_${i}`)));
                }
                
                const chunkDocs = await Promise.all(chunkPromises);
                let allMembers = [];
                
                chunkDocs.forEach((chunkDoc) => {
                    if (chunkDoc.exists()) {
                        const chunkData = chunkDoc.data();
                        if (chunkData.members) {
                            allMembers = allMembers.concat(chunkData.members);
                        }
                    }
                });
                
                return {
                    members: allMembers,
                    columnSettings: metaData.columnSettings,
                    headers: metaData.headers,
                    lastSync: metaData.lastSync,
                    totalMembers: allMembers.length
                };
            }
            
            async function loadLegacyData() {
                const legacyDoc = await getDoc(doc(db, 'system', 'memberData'));
                if (legacyDoc.exists()) {
                    const data = legacyDoc.data();
                    return {
                        members: data.members || [],
                        columnSettings: data.columnSettings,
                        headers: data.headers,
                        lastSync: data.lastSync,
                        totalMembers: data.members ? data.members.length : 0
                    };
                } else {
                    throw new Error('ë‹¹ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™”
        initializeFirebase();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 15px;
            left: 20px;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .login-screen {
            max-width: 450px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .main-app {
            display: none;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
        }

        .tab-btn:hover {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .tab-btn.active {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .tab-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .welcome-message {
            background: linear-gradient(135deg, #d4f8d4 0%, #a8e6a8 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
        }

        .welcome-message h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #155724;
            line-height: 1.6;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
        }

        .results-area {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-header {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .member-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .member-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .member-item.duplicate {
            border-left-color: #dc3545;
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.05) 0%, rgba(248, 249, 250, 1) 10%);
        }

        .member-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .member-details {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 50px;
            font-style: italic;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .permission-notice {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: #856404;
        }

        .phone-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .phone-btn {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid;
        }

        .call-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        .call-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #17a085);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .sms-btn {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            border-color: #007bff;
        }

        .sms-btn:hover {
            background: linear-gradient(135deg, #0056b3, #520dc2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .nav-tabs {
                padding: 5px;
            }
            
            .tab-btn {
                padding: 10px 5px;
                font-size: 0.9em;
                min-width: 100px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            .phone-btn {
                padding: 8px 14px;
                font-size: 0.9em;
                min-width: 90px;
                text-align: center;
            }
            
            .phone-actions {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        ğŸŸ¡ ì„œë²„ ì—°ê²° ì¤‘...
    </div>
    
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo" style="display: none;"></div>
            <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            <h2>ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ ì›ì£¼ê°‘ì§€ì—­ìœ„ì›íšŒ</h2>
            <p>ë‹¹ì›ê´€ë¦¬ ì‹œìŠ¤í…œ - ì‚¬ìš©ììš©</p>
        </div>

        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; color: #495057;">ì‚¬ìš©ì ë¡œê·¸ì¸</h2>
                
               <div class="permission-notice">
                    <h4 style="margin-bottom: 10px;">ğŸ‘¤ ì‚¬ìš©ì ì‹œìŠ¤í…œ ì•ˆë‚´</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                        <li>IDì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”</li>
                     </ul>
                </div>
                
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ì ID</label>
                    <input type="text" id="username" class="form-control" placeholder="IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button onclick="login()" class="btn btn-success" style="width: 100%;">ë¡œê·¸ì¸</button>
                
                <div id="loadingStatus" style="margin-top: 15px; text-align: center; color: #6c757d; display: none;">
                    ë¡œê·¸ì¸ ì¤‘...
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
        <div id="mainApp" class="main-app">
            <div class="nav-tabs" id="navTabs">
                <!-- ê¶Œí•œì— ë”°ë¼ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>

            <div class="tab-content">
                <!-- ìƒì¼ ê²€ìƒ‰ íƒ­ -->
                <div id="birthdaySearch" class="tab-pane">
                    <h3>ğŸ‚ ìƒì¼ ê²€ìƒ‰</h3>
                    
                    <div class="filter-section">
                        <div class="filter-row">
                            <div>
                                <label><strong>ê²€ìƒ‰ ë‚ ì§œ</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="dateOption" value="today" checked onchange="toggleDateOptions()"> ì˜¤ëŠ˜ ìƒì¼</label>
                                    <label><input type="radio" name="dateOption" value="specific" onchange="toggleDateOptions()"> íŠ¹ì • ë‚ ì§œ</label>
                                </div>
                                <input type="date" id="specificDate" class="form-control" style="display: none; margin-top: 10px;">
                            </div>
                            
                            <div>
                                <label><strong>ì—°ë ¹ëŒ€ í•„í„°</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="ageFilter" value="all" checked onchange="toggleAgeFilter()"> ì „ì²´</label>
                                    <label><input type="radio" name="ageFilter" value="specific" onchange="toggleAgeFilter()"> íŠ¹ì • ì—°ë ¹ëŒ€</label>
                                </div>
                                <select id="ageRange" class="form-control" style="display: none; margin-top: 10px;">
                                    <option>10ëŒ€</option>
                                    <option>20ëŒ€</option>
                                    <option>30ëŒ€</option>
                                    <option>40ëŒ€</option>
                                    <option>50ëŒ€</option>
                                    <option>60ëŒ€</option>
                                    <option>70ëŒ€</option>
                                    <option>80ëŒ€ ì´ìƒ</option>
                                </select>
                            </div>
                            
                            <div>
                                <label><strong>ì§€ì—­ í•„í„°</strong></label>
                                <div class="radio-group">
                                    <label><input type="radio" name="dongFilter" value="all" checked onchange="toggleDongFilter()"> ì „ì²´</label>
                                    <label><input type="radio" name="dongFilter" value="specific" onchange="toggleDongFilter()"> íŠ¹ì • ì§€ì—­</label>
                                </div>
                                <input type="text" id="specificDong" class="form-control" placeholder="ìë©´ë™ ì…ë ¥" style="display: none; margin-top: 10px;">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="searchBirthdays()" class="btn btn-primary">ğŸ” ìƒì¼ ê²€ìƒ‰</button>
                        </div>
                    </div>

                    <div id="birthdayResults" class="results-area">
                        <div class="loading-spinner">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ë‹¹ì› ê²€ìƒ‰ íƒ­ -->
                <div id="memberSearch" class="tab-pane">
                    <h3>ğŸ‘¥ ë‹¹ì› ê²€ìƒ‰</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">ì´ë¦„ì´ë‚˜ ì „í™”ë²ˆí˜¸ë¡œ ë‹¹ì›ì„ ê²€ìƒ‰í•˜ê³  ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <div class="filter-section">
                        <div class="filter-row">
                            <div>
                                <label><strong>ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰</strong></label>
                                <input type="text" id="searchByName" class="form-control" placeholder="ë‹¹ì› ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">ë¶€ë¶„ ê²€ìƒ‰ ê°€ëŠ¥</small>
                            </div>
                            
                            <div>
                                <label><strong>ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰</strong></label>
                                <input type="text" id="searchByPhone" class="form-control" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">ë¶€ë¶„ ê²€ìƒ‰ ê°€ëŠ¥</small>
                            </div>
                            
                            <div>
                                <label><strong>ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰</strong></label>
                                <input type="text" id="searchByDong" class="form-control" placeholder="ìë©´ë™ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="handleSearchKeyup(event)">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">ë¶€ë¶„ ê²€ìƒ‰ ê°€ëŠ¥</small>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="searchMembersByInput()" class="btn btn-primary">ğŸ” ë‹¹ì› ê²€ìƒ‰</button>
                            <button onclick="clearSearchInputs()" class="btn btn-secondary">ğŸ—‘ï¸ ê²€ìƒ‰ ì´ˆê¸°í™”</button>
                        </div>
                    </div>

                    <div id="memberSearchResults" class="results-area">
                        <div class="loading-spinner">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ë°ì´í„° ê´€ë¦¬ íƒ­ -->
                <div id="dataManage" class="tab-pane">
                    <h3>ğŸ“ ë°ì´í„° ê´€ë¦¬</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">ë‹¹ì› ì •ë³´ë¥¼ ì¶”ê°€í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê¶Œí•œì— ë”°ë¼ ì œí•œ)</p>
                    
                    <div class="permission-notice">
                        <h4>âš ï¸ ê¶Œí•œ ì•ˆë‚´</h4>
                        <p>ë°ì´í„° ê´€ë¦¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button onclick="showAddModal()" class="btn btn-success">â• ìƒˆ ë‹¹ì› ì¶”ê°€</button>
                        <button onclick="showEditSearchModal()" class="btn btn-warning">âœï¸ ë‹¹ì› ì •ë³´ ìˆ˜ì •</button>
                    </div>

                    <div id="recentActivity" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>ğŸ“‹ ìµœê·¼ í™œë™</h4>
                        <div id="activityLog">
                            <p style="color: #6c757d;">í™œë™ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ íƒ­ -->
                <div id="statistics" class="tab-pane">
                    <h3>ğŸ“Š í†µê³„ í˜„í™©</h3>
                    <p style="margin-bottom: 25px; color: #6c757d;">ë‹¹ì› í˜„í™©ê³¼ í†µê³„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalMembers">-</div>
                            <div class="stat-label">ì´ ë‹¹ì› ìˆ˜</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayBirthdays">-</div>
                            <div class="stat-label">ì˜¤ëŠ˜ ìƒì¼ì</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgAge">-</div>
                            <div class="stat-label">í‰ê·  ì—°ë ¹</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreas">-</div>
                            <div class="stat-label">ê´€ë¦¬ ì§€ì—­ ìˆ˜</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h4 style="margin-bottom: 20px;">ì—°ë ¹ëŒ€ë³„ ë¶„í¬</h4>
                        <canvas id="ageChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h4 style="margin-bottom: 20px;">ì§€ì—­ë³„ ë¶„í¬</h4>
                        <canvas id="areaChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMemberModal')">&times;</span>
            <h2>ìƒˆ ë‹¹ì› ì¶”ê°€</h2>
            <form id="addMemberForm">
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="newMemberName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>ìƒë…„ì›”ì¼ *</label>
                    <input type="date" id="newMemberDob" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>ì „í™”ë²ˆí˜¸</label>
                    <input type="tel" id="newMemberPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label>ìë©´ë™</label>
                    <input type="text" id="newMemberDong" class="form-control">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" onclick="addNewMember()" class="btn btn-success">ğŸ’¾ ì¶”ê°€</button>
                    <button type="button" onclick="closeModal('addMemberModal')" class="btn btn-secondary">âŒ ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="memberDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memberDetailModal')">&times;</span>
            <h2 id="memberDetailTitle">ë‹¹ì› ìƒì„¸ ì •ë³´</h2>
            <div id="memberDetailContent"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤
        let currentUser = null;
        let memberData = null;
        let userPermissions = [];
        
        // Firebase ìƒíƒœë¥¼ ì „ì—­ìœ¼ë¡œ ì´ˆê¸°í™”
        window.isFirebaseReady = false;
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function calculateAge(dob) {
    if (!dob) return 0;
    
    let birthDate;
    
    if (typeof dob === 'number') {
        // ì—‘ì…€ ì‹œë¦¬ì–¼ ë‚ ì§œì¸ ê²½ìš°
        birthDate = new Date((dob - 25569) * 86400 * 1000);
    } else if (typeof dob === 'string') {
        // ë¬¸ìì—´ ë‚ ì§œ ì²˜ë¦¬
        const dateStr = dob.toString().replace(/[^\d]/g, '');
        if (dateStr.length === 8) {
            // YYYYMMDD í˜•ì‹
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            birthDate = new Date(year, month - 1, day);
        } else if (dateStr.length === 6) {
            // YYMMDD í˜•ì‹
            let year = parseInt(dateStr.substring(0, 2));
            year = year < 30 ? 2000 + year : 1900 + year;
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            birthDate = new Date(year, month - 1, day);
        } else {
            birthDate = new Date(dob);
        }
    } else {
        birthDate = new Date(dob);
    }
    
    if (isNaN(birthDate.getTime())) return 0;
    
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    return age;
}

        function getAgeGroup(age) {
            if (age < 20) return '10ëŒ€';
            if (age < 30) return '20ëŒ€';
            if (age < 40) return '30ëŒ€';
            if (age < 50) return '40ëŒ€';
            if (age < 60) return '50ëŒ€';
            if (age < 70) return '60ëŒ€';
            if (age < 80) return '70ëŒ€';
            return '80ëŒ€ ì´ìƒ';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('ko-KR');
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const cleaned = phone.replace(/[^\d]/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (cleaned.length === 10) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
            }
            return phone;
        }

        // ì „í™”ë²ˆí˜¸ ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
        function createPhoneActionButtons(phone) {
            if (!phone) return '';
            
            const cleanPhone = phone.replace(/[^\d]/g, '');
            const formattedPhone = formatPhoneNumber(phone);
            
            // ì „í™”ë²ˆí˜¸ê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
            if (cleanPhone.length < 10) {
                return `ğŸ“ ì „í™”ë²ˆí˜¸: ${formattedPhone} <small style="color: #dc3545;">(ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸)</small>`;
            }
            
            return `
                ğŸ“ ì „í™”ë²ˆí˜¸: ${formattedPhone}
                <div class="phone-actions" onclick="event.stopPropagation();" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="tel:${cleanPhone}" class="phone-btn call-btn">ğŸ“ ì „í™”ê±¸ê¸°</a>
                    <a href="sms:${cleanPhone}" class="phone-btn sms-btn">ğŸ’¬ ë¬¸ìë³´ë‚´ê¸°</a>
                </div>
            `;
        }

        // ëª¨ë°”ì¼ ê°ì§€
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

function isBirthday(dob, targetDate = new Date()) {
    if (!dob) return false;
    
    let birthDate;
    if (typeof dob === 'number') {
        birthDate = new Date((dob - 25569) * 86400 * 1000);
    } else {
        const dateStr = dob.toString().replace(/[^\d]/g, '');
        if (dateStr.length === 8) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            birthDate = new Date(year, month - 1, day);
        } else if (dateStr.length === 6) {
            let year = parseInt(dateStr.substring(0, 2));
            year = year < 30 ? 2000 + year : 1900 + year;
            const month = dateStr.substring(2, 4);
            const day = dateStr.substring(4, 6);
            birthDate = new Date(year, month - 1, day);
        } else {
            birthDate = new Date(dob);
        }
    }
    
    if (isNaN(birthDate.getTime())) return false;
    
    return birthDate.getMonth() === targetDate.getMonth() && 
           birthDate.getDate() === targetDate.getDate();
}

        // ë¡œê·¸ì¸ í•¨ìˆ˜
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loadingStatus');

            if (!username || !password) {
                alert('ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!window.isFirebaseReady) {
                alert('ì„œë²„ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                return;
            }

            statusEl.style.display = 'block';
            statusEl.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

            try {
                const authResult = await window.authenticateUser(username, password);
                currentUser = authResult;
                userPermissions = authResult.permissions;

                // ë‹¹ì› ë°ì´í„° ë¡œë“œ
                statusEl.textContent = 'ë‹¹ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                memberData = await window.loadMemberData();

                // ë¡œê·¸ì¸ ì„±ê³µ
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfo').textContent = `${username}ë‹˜ (${userPermissions.length}ê°œ ê¶Œí•œ)`;
                document.getElementById('logoutBtn').style.display = 'block';

                // ê¶Œí•œì— ë”°ë¥¸ íƒ­ ìƒì„±
                createUserTabs();
                
                // ê¸°ë³¸ íƒ­ í™œì„±í™”
                const firstTab = document.querySelector('.tab-btn');
                if (firstTab) {
                    firstTab.click();
                }

                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', authResult);
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`);
            } finally {
                statusEl.style.display = 'none';
            }
        }

        // ê¶Œí•œì— ë”°ë¥¸ íƒ­ ìƒì„±
        function createUserTabs() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            const availableTabs = [
                { id: 'birthdaySearch', title: 'ğŸ‚ ìƒì¼ ê²€ìƒ‰', permission: '2. ìƒì¼ ê²€ìƒ‰' },
                { id: 'memberSearch', title: 'ğŸ‘¥ ë‹¹ì› ê²€ìƒ‰', permission: '3. ë‹¹ì› ê²€ìƒ‰' },
                { id: 'dataManage', title: 'ğŸ“ ë°ì´í„° ê´€ë¦¬', permission: '4. ë°ì´í„° ê´€ë¦¬' },
                { id: 'statistics', title: 'ğŸ“Š í†µê³„ í˜„í™©', permission: '5. í†µê³„/ì„¤ì •' }
            ];

            let firstTabCreated = false;

            availableTabs.forEach(tab => {
                if (userPermissions.includes(tab.permission)) {
                    const tabBtn = document.createElement('button');
                    tabBtn.className = firstTabCreated ? 'tab-btn' : 'tab-btn active';
                    tabBtn.onclick = () => showTab(tab.id);
                    tabBtn.textContent = tab.title;
                    navTabs.appendChild(tabBtn);

                    if (!firstTabCreated) {
                        document.getElementById(tab.id).classList.add('active');
                        firstTabCreated = true;
                    }
                }
            });

            if (!firstTabCreated) {
                navTabs.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">ì‚¬ìš© ê°€ëŠ¥í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>';
            }
        }

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ ë³´ì´ê¸°
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // íƒ­ë³„ ì´ˆê¸°í™”
            if (tabName === 'birthdaySearch') {
                initializeBirthdaySearch();
            } else if (tabName === 'memberSearch') {
                initializeMemberSearch();
            } else if (tabName === 'statistics') {
                refreshStats();
            }
        }

        // ìƒì¼ ê²€ìƒ‰ ì´ˆê¸°í™”
        function initializeBirthdaySearch() {
            const resultsEl = document.getElementById('birthdayResults');
            if (!memberData) {
                resultsEl.innerHTML = '<div class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
                return;
            }
            resultsEl.innerHTML = '<div class="no-data">ê²€ìƒ‰ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>';
        }

        // ë‹¹ì› ê²€ìƒ‰ ì´ˆê¸°í™”
        function initializeMemberSearch() {
            const resultsEl = document.getElementById('memberSearchResults');
            if (!memberData) {
                resultsEl.innerHTML = '<div class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
                return;
            }
            resultsEl.innerHTML = '<div class="no-data">ì´ë¦„, ì „í™”ë²ˆí˜¸ ë˜ëŠ” ì§€ì—­ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</div>';
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥ë“¤
        function toggleDateOptions() {
            const specificDate = document.getElementById('specificDate');
            const dateOption = document.querySelector('input[name="dateOption"]:checked').value;
            
            if (dateOption === 'specific') {
                specificDate.style.display = 'block';
                specificDate.value = new Date().toISOString().split('T')[0];
            } else {
                specificDate.style.display = 'none';
            }
        }

        function toggleAgeFilter() {
            const ageRange = document.getElementById('ageRange');
            const ageFilter = document.querySelector('input[name="ageFilter"]:checked').value;
            
            ageRange.style.display = ageFilter === 'specific' ? 'block' : 'none';
        }

        function toggleDongFilter() {
            const specificDong = document.getElementById('specificDong');
            const dongFilter = document.querySelector('input[name="dongFilter"]:checked').value;
            
            specificDong.style.display = dongFilter === 'specific' ? 'block' : 'none';
        }

        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchMembersByInput();
            }
        }

        function clearSearchInputs() {
            document.getElementById('searchByName').value = '';
            document.getElementById('searchByPhone').value = '';
            document.getElementById('searchByDong').value = '';
            initializeMemberSearch();
        }

        // ìƒì¼ ê²€ìƒ‰
        function searchBirthdays() {
            if (!memberData || !memberData.members) {
                alert('ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const dateOption = document.querySelector('input[name="dateOption"]:checked').value;
            const ageFilter = document.querySelector('input[name="ageFilter"]:checked').value;
            const dongFilter = document.querySelector('input[name="dongFilter"]:checked').value;
            
            let targetDate = new Date();
            if (dateOption === 'specific') {
                const specificDate = document.getElementById('specificDate').value;
                if (!specificDate) {
                    alert('íŠ¹ì • ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                targetDate = new Date(specificDate);
            }
            
            const selectedAgeRange = ageFilter === 'specific' ? document.getElementById('ageRange').value : null;
            const selectedDong = dongFilter === 'specific' ? document.getElementById('specificDong').value.trim() : null;
            
            let results = [];
            
            memberData.members.forEach(member => {
                if (!member.name || !member.name.trim()) return;
                
                if (!isBirthday(member.dob, targetDate)) return;
                
                const age = calculateAge(member.dob);
                const ageGroup = getAgeGroup(age);
                
                if (selectedAgeRange && ageGroup !== selectedAgeRange) return;
                
                if (selectedDong && !member.dong.toString().includes(selectedDong)) return;
                
                results.push({
                    name: member.name,
                    dob: member.dob,
                    phone: member.phone || '',
                    dong: member.dong || '',
                    age,
                    ageGroup
                });
            });
            
            displaySearchResults(results, 'birthdayResults', 'ğŸ‚ ìƒì¼ì ê²€ìƒ‰ ê²°ê³¼', targetDate);
        }

        // ë‹¹ì› ê²€ìƒ‰
        function searchMembersByInput() {
            if (!memberData || !memberData.members) {
                alert('ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const searchName = document.getElementById('searchByName').value.trim();
            const searchPhone = document.getElementById('searchByPhone').value.trim().replace(/[^\d]/g, '');
            const searchDong = document.getElementById('searchByDong').value.trim();

            if (!searchName && !searchPhone && !searchDong) {
                alert('ì´ë¦„, ì „í™”ë²ˆí˜¸ ë˜ëŠ” ì§€ì—­ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let results = [];
            const duplicateTracker = {};

            memberData.members.forEach((member, index) => {
                if (!member.name || !member.name.trim()) return;

                const name = member.name.toString();
                const phone = (member.phone || '').toString().replace(/[^\d]/g, '');
                const dong = (member.dong || '').toString();

                let matches = false;

                if (searchName && name.includes(searchName)) matches = true;
                if (searchPhone && phone.includes(searchPhone)) matches = true;
                if (searchDong && dong.includes(searchDong)) matches = true;

                if (matches) {
                    const age = calculateAge(member.dob);
                    const ageGroup = getAgeGroup(age);
                    
                    const key = `${name}_${phone}_${dong}`;
                    
                    if (!duplicateTracker[key]) {
                        duplicateTracker[key] = [];
                    }
                    
                    duplicateTracker[key].push({
                        index,
                        name,
                        dob: member.dob,
                        phone: member.phone || '',
                        dong: member.dong || '',
                        age,
                        ageGroup
                    });
                }
            });

            const groupedResults = [];
            Object.keys(duplicateTracker).forEach(key => {
                const group = duplicateTracker[key];
                groupedResults.push({
                    key: key,
                    count: group.length,
                    members: group,
                    representative: group[0]
                });
            });

            displayGroupedSearchResults(groupedResults, 'memberSearchResults', 'ğŸ‘¥ ë‹¹ì› ê²€ìƒ‰ ê²°ê³¼');
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(results, containerId, title, targetDate = null) {
            const container = document.getElementById(containerId);
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-data">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë‹¹ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = `<div class="results-header">${title} (${results.length}ëª…)</div>`;
            
            if (targetDate) {
                html += `<div style="text-align: center; margin-bottom: 15px; color: #666;">
                    ê²€ìƒ‰ ë‚ ì§œ: ${targetDate.toLocaleDateString('ko-KR')}
                </div>`;
            }
            
            results.forEach(member => {
                const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';
                
                html += `
                    <div class="member-item" onclick="showMemberDetail(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                        <div class="member-name">${member.name}</div>
                        <div class="member-details">
                            ğŸ‚ ìƒë…„ì›”ì¼: ${formatDate(member.dob)} (${member.age}ì„¸, ${member.ageGroup})<br>
                            ${phoneHtml}
                            ${member.dong ? `ğŸ  ìë©´ë™: ${member.dong}<br>` : ''}
                            <small style="color: #666;">ğŸ‘† í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            window.lastSearchResults = results;
            window.lastSearchTitle = title;
        }

        function displayGroupedSearchResults(groupedResults, containerId, title) {
            const container = document.getElementById(containerId);
            
            if (groupedResults.length === 0) {
                container.innerHTML = '<div class="no-data">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë‹¹ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let totalMembers = 0;
            groupedResults.forEach(group => totalMembers += group.count);

            let html = `<div class="results-header">${title} (${groupedResults.length}ê°œ ê·¸ë£¹, ì´ ${totalMembers}ëª…)</div>`;

            groupedResults.forEach((group, groupIndex) => {
                const rep = group.representative;
                const isDuplicate = group.count > 1;
                const phoneHtml = rep.phone ? createPhoneActionButtons(rep.phone) : '';
                
                html += `
                    <div class="member-item ${isDuplicate ? 'duplicate' : ''}" onclick="showMemberGroup(${groupIndex})">
                        <div class="member-name">
                            ${rep.name} 
                            ${isDuplicate ? `<span style="color: #dc3545; font-weight: bold;">(${group.count}ëª… ì¤‘ë³µ)</span>` : ''}
                        </div>
                        <div class="member-details">
                            ğŸ‚ ë‚˜ì´: ${rep.age}ì„¸ (${rep.ageGroup})<br>
                            ${phoneHtml}
                            ${rep.dong ? `ğŸ  ì£¼ì†Œ: ${rep.dong}<br>` : ''}
                            ${isDuplicate ? '<small style="color: #dc3545;">âš ï¸ í´ë¦­í•˜ì—¬ ì¤‘ë³µ ë°ì´í„° í™•ì¸</small>' : '<small style="color: #666;">ğŸ‘† í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°</small>'}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            window.lastGroupedResults = groupedResults;
            
            // ë‚´ë³´ë‚´ê¸°ìš© ê²°ê³¼ë„ ì¤€ë¹„
            window.lastSearchResults = [];
            groupedResults.forEach(group => {
                group.members.forEach(member => {
                    window.lastSearchResults.push(member);
                });
            });
            window.lastSearchTitle = title;
        }

        // í†µê³„ ìƒˆë¡œê³ ì¹¨
        function refreshStats() {
            if (!memberData || !memberData.members) {
                document.getElementById('totalMembers').textContent = '-';
                document.getElementById('todayBirthdays').textContent = '-';
                document.getElementById('avgAge').textContent = '-';
                document.getElementById('totalAreas').textContent = '-';
                return;
            }

            let totalMembers = 0;
            let todayBirthdays = 0;
            let totalAge = 0;
            let validAges = 0;
            const areas = new Set();
            const ageGroups = {};
            const dongCounts = {};
            
            const today = new Date();
            
            memberData.members.forEach(member => {
                if (!member.name || !member.name.trim()) return;
                
                totalMembers++;
                
                const age = calculateAge(member.dob);
                if (age > 0) {
                    totalAge += age;
                    validAges++;
                    
                    const ageGroup = getAgeGroup(age);
                    ageGroups[ageGroup] = (ageGroups[ageGroup] || 0) + 1;
                }
                
                if (isBirthday(member.dob, today)) {
                    todayBirthdays++;
                }
                
                if (member.dong && member.dong.toString().trim()) {
                    areas.add(member.dong.toString().trim());
                    dongCounts[member.dong.toString().trim()] = (dongCounts[member.dong.toString().trim()] || 0) + 1;
                }
            });
            
            document.getElementById('totalMembers').textContent = totalMembers.toLocaleString();
            document.getElementById('todayBirthdays').textContent = todayBirthdays.toLocaleString();
            document.getElementById('avgAge').textContent = validAges > 0 ? Math.round(totalAge / validAges) : 0;
            document.getElementById('totalAreas').textContent = areas.size;
            
            updateAgeChart(ageGroups);
            updateAreaChart(dongCounts);
        }

        function updateAgeChart(ageGroups) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            
            if (window.ageChartInstance) {
                window.ageChartInstance.destroy();
            }
            
            const labels = ['10ëŒ€', '20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€', '60ëŒ€', '70ëŒ€', '80ëŒ€ ì´ìƒ'];
            const data = labels.map(label => ageGroups[label] || 0);
            
            window.ageChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë‹¹ì› ìˆ˜',
                        data: data,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(102, 16, 242, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateAreaChart(dongCounts) {
            const ctx = document.getElementById('areaChart').getContext('2d');
            
            if (window.areaChartInstance) {
                window.areaChartInstance.destroy();
            }
            
            const sortedDongs = Object.entries(dongCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedDongs.map(item => item[0]);
            const data = sortedDongs.map(item => item[1]);
            
            window.areaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(102, 16, 242, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)',
                            'rgba(255, 99, 255, 0.8)',
                            'rgba(99, 255, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showAddModal() {
            document.getElementById('addMemberModal').style.display = 'block';
        }

        function showEditSearchModal() {
            alert('êµ¬í˜„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë‹¹ì› ê²€ìƒ‰ íƒ­ì—ì„œ ìˆ˜ì •í•  ë‹¹ì›ì„ ì°¾ì•„ í´ë¦­í•˜ì„¸ìš”.');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMemberDetail(member) {
            const modal = document.getElementById('memberDetailModal');
            const title = document.getElementById('memberDetailTitle');
            const content = document.getElementById('memberDetailContent');

            const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';

            title.textContent = `${member.name}ë‹˜ì˜ ìƒì„¸ ì •ë³´`;
            content.innerHTML = `
                <div style="padding: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;"><strong>ì´ë¦„:</strong> ${member.name}</div>
                        <div style="margin-bottom: 10px;"><strong>ìƒë…„ì›”ì¼:</strong> ${formatDate(member.dob)}</div>
                        <div style="margin-bottom: 15px;"><strong>ë‚˜ì´:</strong> ${member.age}ì„¸ (${member.ageGroup})</div>
                        ${member.phone ? `<div style="margin-bottom: 15px;">${phoneHtml}</div>` : ''}
                        ${member.dong ? `<div><strong>ì£¼ì†Œ:</strong> ${member.dong}</div>` : ''}
                    </div>
                    ${isMobile() ? '<div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 8px; color: #0c5460; font-size: 0.9em;"><strong>ğŸ’¡ íŒ:</strong> ì „í™”ê±¸ê¸° ë° ë¬¸ìë³´ë‚´ê¸° ë²„íŠ¼ì„ í„°ì¹˜í•˜ì—¬ ë°”ë¡œ ì—°ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>' : ''}
                </div>
            `;

            modal.style.display = 'block';
        }

        function showMemberGroup(groupIndex) {
            const group = window.lastGroupedResults[groupIndex];
            if (!group) return;

            const modal = document.getElementById('memberDetailModal');
            const title = document.getElementById('memberDetailTitle');
            const content = document.getElementById('memberDetailContent');

            if (group.count === 1) {
                showMemberDetail(group.representative);
            } else {
                title.textContent = `${group.representative.name}ë‹˜ - ì¤‘ë³µ ë°ì´í„° (${group.count}ëª…)`;
                let duplicateHtml = `
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #dc3545;">âš ï¸ ì¤‘ë³µëœ ë°ì´í„°ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤</strong>
                        </div>
                `;

                group.members.forEach((member, index) => {
                    const phoneHtml = member.phone ? createPhoneActionButtons(member.phone) : '';
                    
                    duplicateHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #dc3545;">
                            <div style="margin-bottom: 10px;"><strong>ë°ì´í„° ${index + 1}</strong></div>
                            <div style="margin-bottom: 5px;"><strong>ì´ë¦„:</strong> ${member.name}</div>
                            <div style="margin-bottom: 5px;"><strong>ìƒë…„ì›”ì¼:</strong> ${formatDate(member.dob)}</div>
                            <div style="margin-bottom: 10px;"><strong>ë‚˜ì´:</strong> ${member.age}ì„¸</div>
                            ${member.phone ? `<div style="margin-bottom: 10px;">${phoneHtml}</div>` : ''}
                            ${member.dong ? `<div style="margin-bottom: 10px;"><strong>ì£¼ì†Œ:</strong> ${member.dong}</div>` : ''}
                        </div>
                    `;
                });

                duplicateHtml += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; color: #856404;">
                            <strong>ğŸ’¡ ê¶Œì¥ì‚¬í•­:</strong><br>
                            â€¢ ê´€ë¦¬ìì—ê²Œ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ë¥¼ ìš”ì²­í•˜ì„¸ìš”<br>
                            â€¢ ì •í™•í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì¤‘ë³µì„ í•´ê²°í•˜ì„¸ìš”
                        </div>
                        ${isMobile() ? '<div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 8px; color: #0c5460; font-size: 0.9em;"><strong>ğŸ’¡ íŒ:</strong> ì „í™”ê±¸ê¸° ë° ë¬¸ìë³´ë‚´ê¸° ë²„íŠ¼ì„ í„°ì¹˜í•˜ì—¬ ë°”ë¡œ ì—°ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>' : ''}
                    </div>
                `;
                content.innerHTML = duplicateHtml;
                modal.style.display = 'block';
            }
        }

        // ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportResults(type) {
            const results = window.lastSearchResults;
            const title = window.lastSearchTitle;
            
            if (!results || results.length === 0) {
                alert('ë‚´ë³´ë‚¼ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const exportData = results.map(member => ({
                ì´ë¦„: member.name,
                ìƒë…„ì›”ì¼: formatDate(member.dob),
                ë‚˜ì´: member.age,
                ì—°ë ¹ëŒ€: member.ageGroup,
                ì „í™”ë²ˆí˜¸: member.phone || '',
                ìë©´ë™: member.dong || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ê²€ìƒ‰ê²°ê³¼');
            
            const fileName = `${title.replace(/[^\wê°€-í£]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`${fileName} íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function printResults(type) {
            const results = window.lastSearchResults;
            const title = window.lastSearchTitle;
            
            if (!results || results.length === 0) {
                alert('ì¸ì‡„í•  ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            let html = `
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .print-date { text-align: center; color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="print-date">ì¸ì‡„ì¼: ${new Date().toLocaleDateString('ko-KR')} | ì‚¬ìš©ì: ${currentUser.username}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ìƒë…„ì›”ì¼</th>
                                <th>ë‚˜ì´</th>
                                <th>ì—°ë ¹ëŒ€</th>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <th>ìë©´ë™</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach((member, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${member.name}</td>
                        <td>${formatDate(member.dob)}</td>
                        <td>${member.age}ì„¸</td>
                        <td>${member.ageGroup}</td>
                        <td>${member.phone || ''}</td>
                        <td>${member.dong || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentUser = null;
                memberData = null;
                userPermissions = [];
                
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        // Enter í‚¤ ë¡œê·¸ì¸
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>
